{
  "active": false,
  "connections": {
    "HTTP Request6": {
      "main": [
        [
          {
            "node": "RetrieveClients",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger": {
      "main": [
        [
          {
            "node": "Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres": {
      "main": [
        [
          {
            "node": "HTTP Request6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Invoice Customer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Postgres PGVector Store1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Invoice Reciepient",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres PGVector Store": {
      "main": [
        [
          {
            "node": "Postgres4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Postgres PGVector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Postgres PGVector Store",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Token Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Postgres3": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Postgres PGVector Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RetrieveClients": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Postgres PGVector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Postgres PGVector Store1": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Extract Invoice Customer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Extract Invoice Customer": {
      "main": [
        [
          {
            "node": "Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "firebaseId1": {
      "main": [
        [
          {
            "node": "Register Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "access_token": {
      "main": [
        [
          {
            "node": "firebaseId1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Register Customer": {
      "main": [
        [
          {
            "node": "Success",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Success1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Postgres3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payload": {
      "main": [
        [
          {
            "node": "access_token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "output",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "output1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-09-25T07:31:38.404Z",
  "id": "T62sz3KQxb7AZdtZ",
  "meta": null,
  "name": "InvoiceCustomer-V-1.0.4",
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "https://hub-api-prod-649845453193.us-central1.run.app/api/v1/authentication/system-user/token",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "=5dd3450f93dfb2415c97e282"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -440,
        140
      ],
      "id": "a191349a-b2f3-4a1d-a0e7-1bf831013038",
      "name": "HTTP Request6",
      "retryOnFail": false,
      "credentials": {
        "googleApi": {
          "id": "Hue2Vve59bazs83Y",
          "name": "Google Service Account account 2"
        },
        "httpBearerAuth": {
          "id": "db2me6PVtNUH5oYv",
          "name": "Bearer Auth account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "action"
            },
            {
              "name": "data",
              "type": "any"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1260,
        800
      ],
      "id": "09258252-8c8b-4cc1-8f9b-bc6178ebe424",
      "name": "Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT firebase_uid as x_acting_as_user FROM hub_user_hubuser WHERE number= $1",
        "options": {
          "queryReplacement": "={{ $json.data.user_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -740,
        140
      ],
      "id": "acc5a455-bb55-4333-b6bb-5af1f972acce",
      "name": "Postgres",
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action===\"embed\" }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "28e3ffed-32fb-4392-b084-6dcaf01cb580"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e4df6fe9-c26c-409c-a064-5d72c24eccab",
                    "leftValue": "={{ $json.action===\"create\" }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "07d60566-e75a-45a9-aa61-1dca85cbbca9",
                    "leftValue": "={{ $json.action===\"retrieve\" && $json.data.invoice_recipient!=\"\"}}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1cc4d877-eccb-4be3-8aa0-fcca62a0efe4",
                    "leftValue": "={{ $json.action===\"retrieve\" && $json.data.invoice_recipient===\"\"}}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1040,
        780
      ],
      "id": "5bcad9ef-57ea-45bc-b8f8-013c82c460f3",
      "name": "Route"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": "invoice_client_embeddings",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePGVector",
      "typeVersion": 1.1,
      "position": [
        680,
        0
      ],
      "id": "dfccaa7c-bc75-494f-9305-791c85726e33",
      "name": "Postgres PGVector Store",
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        660,
        220
      ],
      "id": "658a2144-d8d8-4c0e-b988-aeadce08e809",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $('RetrieveClients').item.json.address.name }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "book_number",
                "value": "={{ $('RetrieveClients').item.json.book_number }}"
              },
              {
                "name": "=client_number",
                "value": "={{ $('RetrieveClients').item.json.client_number }}"
              },
              {
                "name": "address",
                "value": "={{   Object.entries($('RetrieveClients').item.json.address)     .filter(([key, value]) => key.toLowerCase() !== 'name' && value != null && value !== '')     .map(([key, value]) => `**${key.charAt(0).toUpperCase() + key.slice(1)}:** ${value}`)     .join('\\n') }}"
              },
              {
                "name": "name",
                "value": "={{ $('RetrieveClients').item.json.address.name }}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        780,
        240
      ],
      "id": "52fd60c6-68a6-49bb-aa01-a222a8f7c09b",
      "name": "Default Data Loader"
    },
    {
      "parameters": {
        "chunkSize": 10000
      },
      "type": "@n8n/n8n-nodes-langchain.textSplitterTokenSplitter",
      "typeVersion": 1,
      "position": [
        880,
        420
      ],
      "id": "279f98a4-aa63-4c91-b4a9-0cef2e6685ee",
      "name": "Token Splitter"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ca5e5011-7198-4301-99a9-b21bb2449375",
              "name": "message",
              "value": "Operation Failed",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        240
      ],
      "id": "e452d777-6873-409b-815e-afb565a66b41",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT EXISTS (\n    SELECT 1\n    FROM invoice_client_embeddings\n    WHERE trim(metadata->>'client_number') = trim($1)\n      AND trim(metadata->>'book_number')   = trim($2)\n) AS is_matched;",
        "options": {
          "queryReplacement": "={{ $json.client_number }},{{ $json.book_number }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        220,
        0
      ],
      "id": "97b8084d-de43-44fc-9798-44350a092578",
      "name": "Postgres3",
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aacbe24a-fc7a-4760-a676-054ca025a0a5",
              "leftValue": "={{ $json.is_matched }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        440,
        0
      ],
      "id": "9ce769a0-6c24-40d4-8509-f53b8f95ac40",
      "name": "If"
    },
    {
      "parameters": {
        "url": "=https://hub-api-prod-649845453193.us-central1.run.app/api/v1/clients/{{ $('Trigger').first().json.data.book_number }}/invoiceClients",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$json.access_token}}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $('Postgres').item.json.x_acting_as_user }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -220,
        60
      ],
      "id": "5c42c5ed-ec7c-42b9-aa68-5efa50d1537a",
      "name": "RetrieveClients",
      "executeOnce": false,
      "alwaysOutputData": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE invoice_client_embeddings\nSET text = CONCAT(\n              'Invoice Client Name: ', text, E'\\n',\n              'Invoice Client Number: ', metadata->>'client_number', E'\\n',\n              'Address: ', metadata->>'address'\n           ),\n    metadata = (metadata::jsonb) - 'address'\nWHERE metadata->>'book_number' = $1\n  AND metadata->>'client_number' = $2\n",
        "options": {
          "queryReplacement": "={{ $json.metadata.book_number }},{{ $json.metadata.client_number }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1160,
        0
      ],
      "id": "241cc11a-d8fc-4a08-93be-a6bafe1e05dd",
      "name": "Postgres4",
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -720,
        1160
      ],
      "id": "74c3bd69-5098-4737-a3dc-ea2865d65e1b",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "mode": "load",
        "tableName": "invoice_client_embeddings",
        "prompt": "={{ $json.data.invoice_recipient }}",
        "topK": 1,
        "options": {
          "distanceStrategy": "cosine",
          "metadata": {
            "metadataValues": [
              {
                "name": "book_number",
                "value": "={{ $('Trigger').item.json.data.book_number }}"
              }
            ]
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePGVector",
      "typeVersion": 1.1,
      "position": [
        -820,
        940
      ],
      "id": "6f6f73aa-c4e5-49f1-a29c-c1b46fad7439",
      "name": "Postgres PGVector Store1",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ \n{\ninvoice_recipient: {\nstatus: 'exists',\nname: $json.document.metadata.name,\ninvoice_recipient_number: $json.document.metadata.client_number\n\n}\n}\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -220,
        900
      ],
      "id": "8dc7864f-c113-4653-aa26-7d7a51664c0c",
      "name": "output"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ \n{\ninvoice_recipient: {\nstatus: 'missing',\nname: $('Route').item.json.data.invoice_recipient\n}\n}\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -220,
        1140
      ],
      "id": "21ff4b35-aabc-41d1-b96c-8c44acef2334",
      "name": "output1"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ \n{\ninvoice_recipient: {\nstatus: 'not_provided',\nname: \"Not Provided\"\n}\n}\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -740,
        1340
      ],
      "id": "4455c6ea-f389-4950-a37b-e8f60733cd8b",
      "name": "No Invoice Reciepient"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -720,
        720
      ],
      "id": "910d43ce-06db-4d85-8930-d4ed72c7592f",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "text": "=Invoice Recipient:  {{ $('Trigger').item.json.data.invoice_recipient.name }}\n---\nEmail Thread:{{\n  JSON.stringify(\n    $json.data.thread.Emails\n      .filter(e => !e.From?.some(f => f.address?.toLowerCase() === \"asst@patchbay.xyz\"))\n      .map(e => {\n        const { From, to, ThreadId, EmailId, MessageId, References, last_attachment, cc, date, ...rest } = e;\n        return rest;\n      }),\n    null,\n    \" \"\n  )\n}}\n----\nbook = {{ $('Trigger').item.json.data.metadata.person_verification.book_number }}",
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"required\": [\"invoice_client_info\"],\n  \"additionalProperties\": false,\n  \"properties\": {\n    \"invoice_client_info\": {\n      \"type\": \"object\",\n      \"description\": \"Parse exactly from text. If any field is not found, set it to \\\"\\\" (empty string). Do not guess.\",\n      \"required\": [\"book_number\", \"organization\", \"address\"],\n      \"additionalProperties\": false,\n      \"properties\": {\n        \"book_number\": {\n          \"type\": \"string\",\n          \"description\": \"Exact book_number from context. If absent, set to \\\"\\\".\",\n          \"default\": \"\"\n        },\n        \"organization\": {\n          \"type\": \"object\",\n          \"description\": \"Recipient's organization (may be the recipient itself). No guessingâ€”use \\\"\\\" when unknown.\",\n          \"required\": [\n            \"name\",\n            \"city\",\n            \"state\",\n            \"country_code\",\n            \"url_website\",\n            \"url_linkedin\",\n            \"verified\",\n            \"email\"\n          ],\n          \"additionalProperties\": false,\n          \"properties\": {\n            \"name\": {\n              \"type\": \"string\",\n              \"description\": \"Organization name.\",\n              \"default\": \"\"\n            },\n            \"city\": {\n              \"type\": \"string\",\n              \"description\": \"Organization city.\",\n              \"default\": \"\"\n            },\n            \"state\": {\n              \"type\": \"string\",\n              \"description\": \"Organization state/region.\",\n              \"default\": \"\"\n            },\n            \"country_code\": {\n              \"type\": \"string\",\n              \"description\": \"ISO 2-letter code if provided; otherwise \\\"\\\".\",\n              \"default\": \"\"\n            },\n            \"url_website\": {\n              \"type\": \"string\",\n              \"description\": \"Website URL if provided; otherwise \\\"\\\".\",\n              \"default\": \"\"\n            },\n            \"url_linkedin\": {\n              \"type\": \"string\",\n              \"description\": \"LinkedIn URL if provided; otherwise \\\"\\\".\",\n              \"default\": \"\"\n            },\n            \"verified\": {\n              \"type\": \"boolean\",\n              \"description\": \"Always set to false unless explicitly stated as verified.\",\n              \"default\": false\n            },\n            \"email\": {\n              \"type\": \"string\",\n              \"description\": \"Organization email if provided; otherwise \\\"\\\".\",\n              \"default\": \"\"\n            }\n          }\n        },\n        \"address\": {\n          \"type\": \"object\",\n          \"description\": \"Invoice recipient's mailing details only. Use \\\"\\\" when not present.\",\n          \"required\": [\n            \"name\",\n            \"address_line_1\",\n            \"address_line_2\",\n            \"city\",\n            \"state\",\n            \"postal_code\",\n            \"country\"\n          ],\n          \"additionalProperties\": false,\n          \"properties\": {\n            \"name\": {\n              \"type\": \"string\",\n              \"description\": \"Invoice Recipient provided.\",\n              \"default\": \"\"\n            },\n            \"address_line_1\": {\n              \"type\": \"string\",\n              \"description\": \"Primary street address.\",\n              \"default\": \"\"\n            },\n            \"address_line_2\": {\n              \"type\": \"string\",\n              \"description\": \"Apt/Suite/Unit/etc.\",\n              \"default\": \"\"\n            },\n            \"city\": {\n              \"type\": \"string\",\n              \"description\": \"Recipient city.\",\n              \"default\": \"\"\n            },\n            \"state\": {\n              \"type\": \"string\",\n              \"description\": \"Recipient state/region.\",\n              \"default\": \"\"\n            },\n            \"postal_code\": {\n              \"type\": \"string\",\n              \"description\": \"Postal/ZIP code.\",\n              \"default\": \"\"\n            },\n            \"country\": {\n              \"type\": \"string\",\n              \"description\": \"Country name or code.\",\n              \"default\": \"\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n",
        "options": {
          "systemPromptTemplate": "=You are an expert extraction algorithm. You will be provided with below data;\n- Invoice Recipient: Name of the invoice recipient.\n- Email Thread: A conversation between different agents which could provide information/context required for the extraction of data.\n\nWhat you will do:\n- Locate all the information relevant to the invoice Recipient in the email thread.\n- Extract all the data if available, otherwise set to null.\nOnly extract relevant information from the text.\nIf you do not know the value of an attribute asked to extract, you may omit the attribute's value."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        -820,
        500
      ],
      "id": "16e900cf-f40c-4df9-abfe-2c202fef5c27",
      "name": "Extract Invoice Customer",
      "executeOnce": false,
      "retryOnFail": true,
      "maxTries": 2,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT firebase_uid as x_acting_as_user FROM hub_user_hubuser WHERE number= $1",
        "options": {
          "queryReplacement": "={{ $('Trigger').item.json.data.user_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        0,
        460
      ],
      "id": "78f5642f-20c6-4456-a7f1-db7098005e11",
      "name": "firebaseId1",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hub-api-prod-649845453193.us-central1.run.app/api/v1/authentication/system-user/token",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "=5dd3450f93dfb2415c97e282"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -220,
        540
      ],
      "id": "bac61d65-788e-4051-82b5-610c1563ffdd",
      "name": "access_token",
      "retryOnFail": true,
      "maxTries": 2,
      "credentials": {
        "googleApi": {
          "id": "Hue2Vve59bazs83Y",
          "name": "Google Service Account account 2"
        },
        "httpBearerAuth": {
          "id": "db2me6PVtNUH5oYv",
          "name": "Bearer Auth account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://hub-api-prod-649845453193.us-central1.run.app/api/v1/clients/{{ $('Trigger').item.json.data.metadata.person_verification.book_number }}/invoiceClients",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $('access_token').item.json.access_token }}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $json.x_acting_as_user }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Payload').item.json.output.invoice_client_info }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        220,
        460
      ],
      "id": "c22e3e3b-9f9a-4c22-bf71-37bfd736ee19",
      "name": "Register Customer",
      "executeOnce": false,
      "retryOnFail": true,
      "maxTries": 2,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4e7d12d1-3833-4556-b960-cd799bbb0661",
              "name": "invoice_recipient.status",
              "value": "success",
              "type": "string"
            },
            {
              "id": "21577be9-5129-44c8-906a-2472d7d9fdc6",
              "name": "invoice_recipient.name",
              "value": "={{ $('Trigger').item.json.data.invoice_recipient.name }}",
              "type": "string"
            },
            {
              "id": "62a65c46-0f0e-4af3-ab40-15d4747def30",
              "name": "invoice_recipient.data",
              "value": "={{$json}}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        440,
        340
      ],
      "id": "ca1b3508-44dd-4596-b8b4-08c15361b0da",
      "name": "Success"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4e7d12d1-3833-4556-b960-cd799bbb0661",
              "name": "invoice_recipient.status",
              "value": "failed",
              "type": "string"
            },
            {
              "id": "21577be9-5129-44c8-906a-2472d7d9fdc6",
              "name": "invoice_recipient.name",
              "value": "={{ $('Trigger').item.json.data.invoice_recipient.name }}",
              "type": "string"
            },
            {
              "id": "2eaa22dd-1a7a-4536-9872-298630e2bda0",
              "name": "invoice_recipient.failure_reason",
              "value": "Technical",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        440,
        700
      ],
      "id": "ab04ec38-02b5-4464-8c72-9ebfe0591f94",
      "name": "Success1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d3487969-4d1c-419d-93a8-ce2bd133f3f3",
              "leftValue": "={{ $json.isNotEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        0,
        0
      ],
      "id": "17aa0a88-7375-4f1b-90a6-8d1d14b1abf9",
      "name": "If2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4394c3ba-c9fe-4abc-a21a-2bbe48a25402",
              "name": "output.invoice_client_info.book_number",
              "value": "={{ $('Trigger').item.json.data.metadata.person_verification.book_number }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -440,
        540
      ],
      "id": "16bf29e5-9d54-435b-9f0a-ddbf7ebc1c82",
      "name": "Payload"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "338bc58f-57c0-4ac1-b00d-a3b635ce0016",
              "leftValue": "={{ $json.isNotEmpty() && $json.score<=$('Trigger').item.json.data.threshold }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -440,
        1040
      ],
      "id": "33216a7c-cec3-4a69-8886-db300d1fee3d",
      "name": "If1"
    }
  ],
  "pinData": {
    "Trigger": [
      {
        "json": {
          "action": "create",
          "data": {
            "user_id": "2edfd81b-b1a1-4cb9-89b5-6c84b8bd6dc2",
            "invoice_recipient": {
              "status": "not_provided",
              "name": "Maximum LLC",
              "source": "user_input",
              "route": "register"
            },
            "metadata": {
              "type": "deals_and_invoices",
              "person_verification": {
                "person_name": "Quincy  Jones",
                "status": "verified",
                "book_number": "38930866-9e7a-424c-9492-bf9dd476bde6",
                "book_id": "620",
                "role": "",
                "message": " Quincy  Jones is verified in the Manager's workspace. Inform the manager.",
                "verification_status": "resolved"
              },
              "deal_metadata": {
                "deal_status": "missing"
              },
              "invoice_metadata": {
                "invoice_status": "missing",
                "invoice_recipient": {
                  "status": "not_provided",
                  "name": "Not Provided"
                }
              },
              "routing_id": "<CAEaeWjSRKOzh4d7Cc_TrgGkLUyTkUVuE83KBA4Kr72LjwrxTUA@mail.gmail.com>",
              "last_bot_response": "<div style=\"font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:1.5;color:#111;max-width:680px;\">\n  <p>I will help you create a new invoice with a new recipient.</p>\n  <p><b>Invoice</b></p>\n  <ul>\n    <li>Client: Quincy Jones</li>\n    <li>Amount: 5000 USD</li>\n    <li>Status: Draft</li>\n    <li>Invoice Recipient: Not Provided</li>\n    <li>Due Date: Not Provided</li>\n  </ul>\n  <p>Please provide the invoice recipient details and the due date for this invoice so I can finalize it for you.</p>\n  <hr>\n  <p>Best,<br>Patchbay Assistant</p>\n</div>"
            },
            "thread": {
              "ThreadId": "19956d094fc1c1e5",
              "Emails": [
                {
                  "EmailId": "19956d094fc1c1e5",
                  "MessageId": "<CAP=u+8C4PO_2G3rfz4xtJ=kJJsJqMHp50=n22-XkobVfCoWJtg@mail.gmail.com>",
                  "Subject": "Create Invoice",
                  "From": [
                    {
                      "address": "dwayne@patchbay.xyz",
                      "name": "Dwayne Hoover"
                    }
                  ],
                  "to": [
                    {
                      "address": "asst@patchbay.xyz",
                      "name": "Patchbay Assistant"
                    }
                  ],
                  "cc": [],
                  "date": "2025-09-17T08:35:21.000Z",
                  "emailText": "I want to create a new invoice for my client Quincey Jones with an amount\nof 5000 USD.\n"
                },
                {
                  "ThreadId": "19956d094fc1c1e5",
                  "EmailId": "19956d1cec8f7835",
                  "MessageId": "<CAP=u+8AGp-8szah8CScXVJwQ3KB2PXs6tKt7q+cUY5C_LR+syA@mail.gmail.com>",
                  "References": [
                    "<CAP=u+8C4PO_2G3rfz4xtJ=kJJsJqMHp50=n22-XkobVfCoWJtg@mail.gmail.com>",
                    "<CAEaeWjRBeJYuBgcty8Oj=8NeS2yvc0fGKwicpQEpm=noe_7JvQ@mail.gmail.com>"
                  ],
                  "Subject": "Re: Create Invoice",
                  "From": [
                    {
                      "address": "dwayne@patchbay.xyz",
                      "name": "Dwayne Hoover"
                    }
                  ],
                  "to": [
                    {
                      "address": "asst@patchbay.xyz",
                      "name": ""
                    }
                  ],
                  "cc": [],
                  "date": "2025-09-17T08:36:42.000Z",
                  "emailText": "I there is already an invoice. Can you search for it?"
                },
                {
                  "ThreadId": "19956d094fc1c1e5",
                  "EmailId": "19956d5174f16e08",
                  "MessageId": "<CAP=u+8CC2+odDqZhy3TS1yiOg+kLE43TPA2YA-Q_xxz3CKG=xw@mail.gmail.com>",
                  "References": [
                    "<CAP=u+8AGp-8szah8CScXVJwQ3KB2PXs6tKt7q+cUY5C_LR+syA@mail.gmail.com>",
                    "<CAEaeWjSvxx+Q3h5uX9w818DM1qZkAJ-8gJSoS9nAQgZyVHhRWw@mail.gmail.com>"
                  ],
                  "Subject": "Re: Create Invoice",
                  "From": [
                    {
                      "address": "dwayne@patchbay.xyz",
                      "name": "Dwayne Hoover"
                    }
                  ],
                  "to": [
                    {
                      "address": "asst@patchbay.xyz",
                      "name": ""
                    }
                  ],
                  "cc": [],
                  "date": "2025-09-17T08:40:17.000Z",
                  "emailText": "No actually I want to create a new invoice with a new recipient. Can you help me with that?"
                },
                {
                  "ThreadId": "19956d094fc1c1e5",
                  "EmailId": "19956da2caad84c1",
                  "MessageId": "<CAP=u+8CUnCNuhhSoNCfVR_98k3rHqkCTxPKddjWKw6+n5i60Sg@mail.gmail.com>",
                  "References": [
                    "<CAP=u+8CC2+odDqZhy3TS1yiOg+kLE43TPA2YA-Q_xxz3CKG=xw@mail.gmail.com>",
                    "<CAEaeWjSRKOzh4d7Cc_TrgGkLUyTkUVuE83KBA4Kr72LjwrxTUA@mail.gmail.com>"
                  ],
                  "Subject": "Re: Create Invoice",
                  "From": [
                    {
                      "address": "dwayne@patchbay.xyz",
                      "name": "Dwayne Hoover"
                    }
                  ],
                  "to": [
                    {
                      "address": "asst@patchbay.xyz",
                      "name": ""
                    }
                  ],
                  "cc": [],
                  "date": "2025-09-17T08:45:50.000Z",
                  "emailText": "Actually the amount should be 500 USD, recipient: Maximum LLC, Due Date: 20 December, 2025."
                }
              ],
              "Others": [],
              "Managers": [
                {
                  "name": "Dwayne Hoover",
                  "address": "dwayne@patchbay.xyz",
                  "user_id": "2edfd81b-b1a1-4cb9-89b5-6c84b8bd6dc2",
                  "person_number": "2752c92b-b570-4f0f-a082-611fe1770ec4",
                  "Role": "Manager",
                  "Clients": []
                },
                {
                  "name": "Agent",
                  "address": "asst@patchbay.xyz",
                  "user_id": "9cd5749c-7e7d-4a92-98cd-c1356b626258",
                  "person_number": "03014402-449b-48bb-8973-212449e99e2f",
                  "Role": "Manager",
                  "Clients": []
                }
              ],
              "Label": "CRUD-ASSISTANT",
              "sessionStatus": true
            }
          }
        }
      }
    ]
  },
  "repo_name": "hub-n8n",
  "repo_owner": "ck-bit",
  "repo_path": "",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-09-25T07:31:38.404Z",
  "versionId": "af2f9a8e-32af-4a7c-adac-fd85ee0f83a4"
}