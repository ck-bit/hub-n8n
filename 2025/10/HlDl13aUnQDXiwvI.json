{
  "active": false,
  "connections": {
    "Switch": {
      "main": [
        [
          {
            "node": "Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "access_token2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields11",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Postgres6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ByInvoiceId",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Basic LLM Chain2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger": {
      "main": [
        [
          {
            "node": "GetUserSession1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Invoice": {
      "main": [
        [
          {
            "node": "invoice_payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Model": {
      "ai_languageModel": [
        [
          {
            "node": "Extract Invoice",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Fix",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Fix",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Auto-fixing Output Parser",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "UpdatePayload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Auto-fixing Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres6": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix": {
      "ai_outputParser": [
        [
          {
            "node": "Extract Invoice",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "UpdatePayload": {
      "main": [
        [
          {
            "node": "access_token1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "firebaseId1": {
      "main": [
        [
          {
            "node": "CreateInvoice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "access_token": {
      "main": [
        [
          {
            "node": "firebaseId1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OnFailure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "access_token1": {
      "main": [
        [
          {
            "node": "firebaseId",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "firebaseId": {
      "main": [
        [
          {
            "node": "Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "InvoiceRecipient1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RegisterCustomer": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Format2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code Tool": {
      "ai_tool": [
        [
          {
            "node": "Extract Invoice",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "ByInvoiceId": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "InvoiceOutput",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ByRecAndAmount",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "GetInvoices",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ByRecAndAmount",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "GetInvoices1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ByRecipient",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "InvoiceOutput1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ByRecipient",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If7": {
      "main": [
        [
          {
            "node": "GetInvoices2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ByAmount",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ByAmount": {
      "main": [
        [
          {
            "node": "If8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If8": {
      "main": [
        [
          {
            "node": "GetInvoices3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "InvoiceOutput3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If9": {
      "main": [
        [
          {
            "node": "InvoiceOutput2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ByAmount",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ByRecAndAmount": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetInvoices": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetInvoices1": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetInvoices2": {
      "main": [
        [
          {
            "node": "If9",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetInvoices3": {
      "main": [
        [
          {
            "node": "InvoiceOutput3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ByRecipient": {
      "main": [
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto-fixing Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "firebaseId2": {
      "main": [
        [
          {
            "node": "Get Invoice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OnError",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "access_token2": {
      "main": [
        [
          {
            "node": "firebaseId2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OnError",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "UpdateSesssion5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UpdateSesssion5": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OnError1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Invoice": {
      "main": [
        [
          {
            "node": "If10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Edit Fields6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CreateInvoice": {
      "main": [
        [
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OnFailure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceRecipient1": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "RegisterCustomer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields4": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format2": {
      "main": [
        [
          {
            "node": "Extract Invoice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CreateFile1": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OnError2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If10": {
      "main": [
        [
          {
            "node": "Google Cloud Storage",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CreateFile1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Get Invoice3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Cloud Storage": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OnError2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Invoice3": {
      "main": [
        [
          {
            "node": "Google Cloud Storage",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OnError2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If11": {
      "main": [
        [
          {
            "node": "If12",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code5": {
      "main": [
        [
          {
            "node": "UpdateSesssion6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UpdateSesssion6": {
      "main": [
        [
          {
            "node": "Edit Fields13",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CreateFile2": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If12": {
      "main": [
        [
          {
            "node": "GetFile",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CreateFile2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Get Invoice4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Invoice4": {
      "main": [
        [
          {
            "node": "GetFile",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetFile": {
      "main": [
        [
          {
            "node": "Code5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "invoice_payload": {
      "main": [
        [
          {
            "node": "access_token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain2": {
      "main": [
        [
          {
            "node": "New/Options",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser8": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Chain2",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "UpdateSesssion7": {
      "main": [
        [
          {
            "node": "If11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetUserSession1": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "UpdateSesssion7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-10T05:37:02.103Z",
  "id": "HlDl13aUnQDXiwvI",
  "meta": null,
  "name": "invoice_helpers-V1.0.5",
  "nodes": [
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action.includes(\"create\") }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "a0d57f1e-2666-4549-a35d-9fb424095a98"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3325ec49-ea5d-4532-a9ce-b2b72dc1172b",
                    "leftValue": "={{ $json.action.includes(\"pdf_request\") }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "18c4290d-49af-43d2-a73f-05ae633bcd63",
                    "leftValue": "={{ $json.action.includes(\"send_file\") }}",
                    "rightValue": "send_file",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3178b30e-5cff-4271-a4ab-f10a3199af22",
                    "leftValue": "={{ $json.action.includes(\"update\") }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "5dbddb92-dd71-4b8d-806c-0ac56308c93b",
                    "leftValue": "={{ $json.action.includes(\"check\") }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3b46750e-88f5-4215-81a2-6e340b396b91",
                    "leftValue": "={{ $json.action.includes(\"analyze\") }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -6040,
        1900
      ],
      "id": "d1936ea3-cae3-4f7a-bfe1-f047c686f241",
      "name": "Switch"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "action"
            },
            {
              "name": "data",
              "type": "any"
            },
            {
              "name": "ai_input"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -6700,
        1960
      ],
      "id": "92ab0a60-ef6b-487b-b4ea-782546b8c5f2",
      "name": "Trigger"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Instructions: {{ $('Input').first().json.ai_input }}\n-----\nMetadata: {{ JSON.stringify($json.metadata.removeField('last_bot_response'), null, ' ') }}\n-----",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are an intelligent AI extraction agent responsible for parsing and extracting invoice-related data in strict accordance with the defined JSON parsing schema.\n\nYour task is to:\n- Fully analyze all available context sources.\n- Accurately extract the required fields.\n- Return the output **exactly matching** the structure, types, and enumerations defined in the JSON schema provided to you.\n\n---\n\n### Output Format\n\nYour response **must strictly follow** the following JSON schema structure:\n\n- All fields are **required** unless explicitly marked optional.\n- Use the correct data types (e.g., string, uuid, float, boolean, date).\n- Populate enum fields only with allowed values as defined (e.g., \"status\", \"deal_type\", \"currency\").\n\nRefer to the following schema definitions when forming the output.\n\n---\n\n### You will receive the following input sources:\n\n- **Email Thread / Deal Document**: Unstructured communication containing important deal or invoice context.\n- **Metadata**: Structured profile data of the manager, client, or associated entities.\n- **Tool Input**: Data retrieved via automated systems (e.g., deal lookups, previously stored values).\n- **Instructions**: Latest user instructions, which may contain constraints or field overrides.\n\n---\n\n### Key Guidelines\n\n1. Extract **only relevant and valid** information from the sources.\n2. If any metadata is missing, you must follow the instructions and set the values accordingly without any guess and hallucinations.\n3. Your output must be **machine-parseable**, **strictly valid JSON**, and conform exactly to the schema.\n\n---\n\nAct deterministically. Do not ask clarifying questions. Your job is to extract and format with precision.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -3880,
        300
      ],
      "id": "1d68a64e-9407-462d-8d6e-aa7ceab94f7b",
      "name": "Extract Invoice",
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -3860,
        720
      ],
      "id": "dc66f1e5-d8cc-4d5e-994a-c574a68e8a92",
      "name": "Model",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"book_number\": {\n      \"type\": \"string\",\n      \"format\": \"uuid\",\n      \"description\": \"book_id(uuid) provided in metadata.person_verification\"\n    },\n    \"title\": {\n      \"type\": \"string\",\n      \"description\": \"Assign invoice title\"\n    },\n    \"deal_number\": {\n      \"type\": [\"string\", null],\n      \"format\": \"uuid\",\n      \"description\": \"Search for deal_number(uuid) extracted from Metadata if provided. Set it to null\"\n    },\n    \"deal_type\": {\n      \"type\": [\"string\", null],\n      \"enum\": [\"Producer\", \"Mixer\", \"Featured Artist\"],\n      \"description\": \"Type of deal related to the invoice. If no informations about the deal is present, set this to null\"\n    },\n    \"status\": {\n      \"type\": [\"string\", null],\n      \"enum\": [\"Draft\"],\n      \"description\": \"Status of the invoice. If not matched or provided, set to Draft.\"\n    },\n    \"amount\": {\n      \"type\": [\"number\"],\n      \"description\": \"Extract the approved amount by the manager in the given context. You must look for the amount and extract is accurately. For example: 500\"\n    },\n    \"currency\": {\n      \"type\": \"string\",\n      \"enum\": [\"EUR\", \"GBP\", \"USD\", \"CAD\", \"AUD\"],\n      \"description\": \"Currency of the invoice amount\"\n    },\n    \"commissioned_collected\": {\n      \"type\": \"boolean\",\n      \"description\": \"Whether the commissioned amount has been collected\"\n    },\n    \"management_commission\": {\n      \"type\": \"number\",\n      \"description\": \"Management commission amount, if clearly mentioned\"\n    },\n    \"management_commission_currency\": {\n      \"type\": \"string\",\n      \"enum\": [\"EUR\", \"GBP\", \"USD\", \"CAD\", \"AUD\"],\n      \"description\": \"Currency of the management commission. Set USD if no detail found.\"\n    },\n    \"legal_commissioned_collected\": {\n      \"type\": \"boolean\",\n      \"description\": \"Whether the legal commissioned amount has been collected\"\n    },\n    \"contact\": {\n      \"type\": [\"string\", null],\n      \"description\": \"Contact information of the person/customer who is recieving the invoice. Set null if not provided\"\n    },\n    \"customer_number\": {\n      \"type\": [\"string\", null],\n      \"format\": \"uuid\",\n      \"description\": \"Extract the uuid number from invoice_metadata.invoice_customer if provided, otherwise set to null\"\n    },\n    \"po_number\": {\n      \"type\": [\"string\", null],\n      \"description\": \"Purchase Order number for this invoice if provided\"\n    },\n    \"issued_on\": {\n      \"type\": [\"string\", null],\n      \"format\": \"date\",\n      \"description\": \"Date the invoice was issued. Retrieve the latest date for the invoice calling the tool\"\n    },\n    \"due_on\": {\n      \"type\": [\"string\", null],\n      \"format\": \"date\",\n      \"description\": \"Invoice due date provided in the context, set to null if not provided\"\n    },\n    \"details\": {\n      \"type\": [\"string\"],\n      \"description\": \"Short details of the invoice created.\"\n    }\n  },\n  \"required\": [\n    \"book_number\",\n    \"title\",\n    \"deal_number\",\n    \"deal_type\",\n    \"status\",\n    \"amount\",\n    \"currency\",\n    \"commissioned_collected\",\n    \"management_commission\",\n    \"management_commission_currency\",\n    \"legal_commissioned_collected\",\n    \"contact\",\n    \"customer_number\",\n    \"po_number\",\n    \"issued_on\",\n    \"due_on\",\n    \"details\"\n  ]\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -3560,
        720
      ],
      "id": "0808bd5f-b1fa-4dc7-bd0e-f05255522d7d",
      "name": "Parser"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=instructions: {{ $('Trigger').item.json.ai_input }}\n\nrecommended changes: {{ $('Trigger').item.json.data.recommended_invoice_updates }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are Patchbay Invoice Updation Agent responsible for modifying existing invoices using structured instructions.\n\nYour responsibilities:\n\n1. Always invoke the PostgreSQL tool `RetrieveInvoice` with the provided `invoice_number` to fetch the current invoice record from the database.\n2. Analyze the retrieved invoice details against the provided `Instructions` to determine exactly which fields require updating.\n3. Construct a clean, minimal JSON payload that includes **only the fields whose values differ from the database record based on the instructions**. Do not include unchanged fields or nulls unless a field is being explicitly reset.\n\n---- INPUTS AVAILABLE TO YOU ----\n- `invoice_number`: Unique identifier for the invoice (used to fetch current data).\n- `Instructions`: The latest user instruction specifying what field(s) need to be updated.\n- `Metadata` (optional): Contextual information such as manager ID, client ID, or Book Number if relevant.\n\n---- OUTPUT FORMAT ----\nReturn the final JSON update payload as per the `UpdateInvoiceRequest` schema, strictly without any additional comments, explanations, or preambles. Example:\n\n{\n  \"title\": \"Updated Title\",\n  \"amount\": 1500.00\n}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -5220,
        1660
      ],
      "id": "761d200e-8956-4755-bbeb-13879f318573",
      "name": "AI Agent",
      "retryOnFail": true
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": [\"object\", null],\n  \"description\": \"Update payload for an invoice. Only include fields that require updating. Omit fields that should remain unchanged. Do not provide nulls unless explicitly resetting a field. return null if no updation is needed.\",\n  \"properties\": {\n    \"status\": {\n      \"type\": [\"string\", \"null\"],\n      \"enum\": [\n        \"Paid\", \"Unpad\", \"Sent\"\n      ],\n      \"description\": \"Updated invoice status. Include only if status has changed.\"\n    },\n    \"amount\": {\n      \"type\": [\"number\", \"null\"],\n      \"description\": \"Updated invoice amount. Include only if the value is being changed.\"\n    },\n    \"commissioned_collected\": {\n      \"type\": [\"boolean\", \"null\"],\n      \"description\": \"Set this only if the commissioned collection status is being updated.\"\n    },\n    \"management_commission\": {\n      \"type\": [\"number\", \"null\"],\n      \"description\": \"Update this field only if the management commission amount is being changed.\"\n    },\n    \"management_commission_currency\": {\n      \"type\": [\"string\", \"null\"],\n      \"enum\": [\"EUR\", \"GBP\", \"USD\", \"CAD\", \"AUD\"],\n      \"description\": \"Currency of the management commission. Include if changed.\"\n    },\n    \"legal_commissioned_collected\": {\n      \"type\": [\"boolean\", \"null\"],\n      \"description\": \"Set this field only if legal commissioned collection status is being updated.\"\n    }\n  },\n  \"required\": [\"number\"]\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -5040,
        2080
      ],
      "id": "69ead8d2-84b2-433a-ba0a-de7859ad64a2",
      "name": "Parser1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "edbe88af-c3b5-405d-8125-984557fa1789",
              "leftValue": "={{ $json.output!==null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4760,
        1860
      ],
      "id": "e734de2f-331d-4d07-add5-c0c122e0bfb1",
      "name": "If1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2111359a-e427-4309-959d-330b0684f2f9",
              "name": "message",
              "value": "=No changes detected for updating the invoice. Inform the manager and Call the tool: InvoiceFileRequest to get the latest invoice file and follow the instructions of that tool to inform the manager.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4540,
        2060
      ],
      "id": "2dfc4fb2-bdaf-401b-9f1c-cee238585ba5",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -5200,
        2080
      ],
      "id": "fd5c6eba-4791-40c7-a191-0ed7e2e077df",
      "name": "Model1",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM invoices_invoice WHERE number = $1",
        "options": {
          "queryReplacement": "={{ $json.data.invoice_number }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5740,
        2060
      ],
      "id": "53bbbf30-3dd1-4851-ad66-1b757d4c2c70",
      "name": "Postgres6",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserAutofixing",
      "typeVersion": 1,
      "position": [
        -3680,
        540
      ],
      "id": "9c66b2bb-3260-46a2-ab53-284fa56c0569",
      "name": "Fix"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4547bf90-18fa-4d61-95ed-ab6b85127523",
              "name": "output.number",
              "value": "={{ $('Trigger').item.json.data.invoice_number }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4540,
        1740
      ],
      "id": "5426f809-e9a5-41e0-93ee-3ed8aedaf60d",
      "name": "UpdatePayload"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3bd6ea95-7bc1-4589-bf96-9e863e87e14d",
              "name": "message",
              "value": "=Below updates were made to the invoice;\\n \nInvoice ID: {{ $('Update').first().json.invoice_number }}\n{{ $json.markdown }}\n\nNext, you must execute to tool: InvoiceFileRequest to get the updated invoice file and follow the instructions of that tool to inform the manager.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3080,
        1640
      ],
      "id": "db360fec-c5b1-47e8-9afa-6753b036076d",
      "name": "Edit Fields6"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT firebase_uid as x_acting_as_user FROM hub_user_hubuser WHERE number= $1",
        "options": {
          "queryReplacement": "={{ $('Trigger').item.json.data.user_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2860,
        440
      ],
      "id": "13effd4c-e920-46f8-a4f7-db7e9e30bd13",
      "name": "firebaseId1",
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hub-api-prod-649845453193.us-central1.run.app/api/v1/authentication/system-user/token",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "=5dd3450f93dfb2415c97e282"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3080,
        500
      ],
      "id": "675ba7e5-2e79-4c2d-8eee-1bdf6c7f25cd",
      "name": "access_token",
      "retryOnFail": false,
      "credentials": {
        "googleApi": {
          "id": "Hue2Vve59bazs83Y",
          "name": "Google Service Account account 2"
        },
        "httpBearerAuth": {
          "id": "db2me6PVtNUH5oYv",
          "name": "Bearer Auth account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hub-api-prod-649845453193.us-central1.run.app/api/v1/authentication/system-user/token",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "=5dd3450f93dfb2415c97e282"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4320,
        1740
      ],
      "id": "74050277-f883-4529-95da-a43ea5c3ad2f",
      "name": "access_token1",
      "retryOnFail": true,
      "credentials": {
        "googleApi": {
          "id": "Hue2Vve59bazs83Y",
          "name": "Google Service Account account 2"
        },
        "httpBearerAuth": {
          "id": "db2me6PVtNUH5oYv",
          "name": "Bearer Auth account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT firebase_uid as x_acting_as_user FROM hub_user_hubuser WHERE number= $1",
        "options": {
          "queryReplacement": "={{ $('Trigger').item.json.data.user_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4100,
        1680
      ],
      "id": "fd34dadc-3afa-46fc-8d86-8067f6780190",
      "name": "firebaseId",
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "16461ce0-e9b9-4e0f-b827-b53a6cb9a326",
                    "leftValue": "={{ $json.invoice_recipient.route ==='register' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "55e16791-8b8b-4cad-b168-d54be8dc7c2a",
                    "leftValue": "={{ $json.invoice_recipient.route ==='exists' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.invoice_recipient.route ==='ask_manager' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "674a4b45-3662-47af-8741-10cc07c0aa60"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": 1
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -5440,
        660
      ],
      "id": "c2a2227f-72f4-46f1-b1f0-571be4deb283",
      "name": "Switch1"
    },
    {
      "parameters": {
        "jsCode": "// 1) Safe reads\nconst metadata = $json?.data?.metadata ?? {};\nconst user_id = $json?.data?.user_id ?? \"\";\nconst mdIR = metadata?.invoice_metadata?.invoice_recipient ?? {};\nconst mdStatus = mdIR?.status ?? \"\";\nconst mdName = (mdIR?.name ?? \"\").trim();\nconst userInput = ($json?.data?.invoice_recipient ?? \"\").trim();\nconst thread =\n  $json?.data?.thread ??\n  $json?.data?.session_data?.ThreadId ??\n  \"\";\n\n// Deal ID filtering logic\nconst rawDealId = $json?.data?.deal_id ?? \"\";\nconst normalizedDealId = rawDealId ? String(parseInt(rawDealId, 10)) : \"\";\nlet dealMetadata = metadata?.deal_metadata ?? [];\n\n// Filter deal_metadata if it's a list with more than one object and deal_id is provided\nif (Array.isArray(dealMetadata) && dealMetadata.length > 1 && normalizedDealId) {\n  dealMetadata = dealMetadata.filter(deal => {\n    const dealIdStr = deal?.deal_id ? String(parseInt(deal.deal_id, 10)) : \"\";\n    return dealIdStr === normalizedDealId;\n  });\n  // Update metadata with filtered deal_metadata\n  metadata.deal_metadata = dealMetadata;\n}\n\n// 2) Normalize invoice_recipient object + route\nlet invoice_recipient = {\n  status: \"\",   // exists | not_provided | missing | unknown\n  name: \"\",     // never hallucinated; empty string if unknown\n  source: \"\",   // metadata | user_input | none\n  route: \"\",    // use_existing | use_user_input | use_metadata_name | ask_manager | fallback\n};\n\n// CASE 1: metadata says it exists\nif (mdStatus === \"exists\") {\n  invoice_recipient = {\n    status: \"exists\",\n    name: mdName,\n    source: \"metadata\",\n    route: \"exists\",\n  };\n}\n// CASE 2: not_provided but user supplied input\nelse if ((mdStatus === \"not_provided\" || mdStatus==='') && userInput !== \"\") {\n  invoice_recipient = {\n    status: \"not_provided\",\n    name: userInput,\n    source: \"user_input\",\n    route: \"register\",\n  };\n}\n// CASE 3: missing in store, but metadata has a non-empty name\nelse if (mdStatus === \"missing\" && mdName !== \"\") {\n  invoice_recipient = {\n    status: \"missing\",\n    name: mdName,\n    source: \"metadata\",\n    route: \"register\",\n  };\n}\n// CASE 4: not_provided and no user input -> return METADATA ONLY\nelse if (mdStatus === \"not_provided\" && userInput === \"\") {\n  return [\n    {\n      json: {\n        metadata, // only metadata as requested\n        route: \"ask_manager\"\n      },\n    },\n  ];\n}\n// Fallback\nelse {\n  invoice_recipient = {\n    status: mdStatus || \"unknown\",\n    name: mdName || \"\",\n    source: mdStatus ? \"metadata\" : \"none\",\n    route: \"fallback\",\n  };\n}\n\n// 3) For Cases 1/2/3/fallback -> return thread + metadata + invoice_recipient\nreturn [\n  {\n    json: {\n      user_id,\n      thread,\n      metadata,\n      invoice_recipient,\n    },\n  },\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5740,
        660
      ],
      "id": "7b125847-2c44-47dd-b471-7361e9a5cad7",
      "name": "Router"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DI0OK2QjzXrFmcrM",
          "mode": "list",
          "cachedResultName": "InvoiceCustomer-V-1.0.3"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "create",
            "data": "={{\n{\nuser_id:$('Trigger').first().json.data.user_id,\ninvoice_recipient: $json.invoice_recipient,\nmetadata: $('Trigger').first().json.data.metadata,\nthread: $('Trigger').first().json.data.thread\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -4540,
        540
      ],
      "id": "cc532752-cc00-473f-a4a3-37ea485b6ed6",
      "name": "RegisterCustomer"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f36c5ff6-d53f-434e-9a6b-7ebe81047c99",
              "name": "message",
              "value": "=To proceed with creating an invoice, a valid invoice recipient is needed. Ask the manager to provide a valid invoice recipient details and set the next_task to \"create_invoice\"",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5100,
        840
      ],
      "id": "6ea5f03e-bc2d-4a36-96fe-2a0f191d8ad5",
      "name": "Edit Fields7"
    },
    {
      "parameters": {
        "jsCode": "const base = $('Switch1').first().json;\nconst rec  = $input.first().json.invoice_recipient;\n\nconst updated = JSON.parse(JSON.stringify(base)); // deep clone\n\n// Ensure path exists\nupdated.metadata = updated.metadata ?? {};\nupdated.metadata.invoice_metadata = updated.metadata.invoice_metadata ?? {};\nupdated.metadata.invoice_metadata.invoice_recipient = {\n  status: \"exists\",\n  name: rec.name ?? \"\",\n  invoice_recipient_number: rec.data.customer_number ?? rec.data.client_number ?? null\n};\ndelete updated.invoice_recipient\nreturn [{ json: updated }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4320,
        440
      ],
      "id": "85b0c905-1ad7-4628-8730-e5d092f9cbde",
      "name": "Code2"
    },
    {
      "parameters": {
        "name": "DateTime",
        "description": "Call this tool to provide current time.",
        "jsCode": "return new Date().toISOString()"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.1,
      "position": [
        -3800,
        520
      ],
      "id": "6a745253-2c5a-4c4d-9e9f-6ae550d3e0c7",
      "name": "Code Tool"
    },
    {
      "parameters": {
        "jsCode": "// Get routes safely\nconst routes = $json?.data?.routes ?? [];\n\n// Find the first route with route_by === \"by_invoice_id\"\nconst matchedRoute = routes.find(r => r.route_by === \"by_invoice_id\") || null;\n\n// Return result\nreturn [\n  {\n    json: {\n      route: matchedRoute\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5740,
        2620
      ],
      "id": "ed7954ae-eb31-48c4-98c6-0115a4ed4a0d",
      "name": "ByInvoiceId"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "757ce2c4-8561-4815-8386-699787b7d3e5",
              "leftValue": "={{ $json.invoices.length != 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4760,
        2460
      ],
      "id": "2dc75247-19a7-4e2b-99f9-d05a63b759bd",
      "name": "If3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5c5484d4-7a9b-4154-b35d-f35ba130478e",
              "leftValue": "={{ $json.route!=null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5440,
        2620
      ],
      "id": "f30a0d5a-97c7-4a97-abc2-74b53a49beac",
      "name": "If4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5c5484d4-7a9b-4154-b35d-f35ba130478e",
              "leftValue": "={{ $json.route!=null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4320,
        2720
      ],
      "id": "c1a56f9a-aece-4d7a-ac62-723502b860db",
      "name": "If5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "757ce2c4-8561-4815-8386-699787b7d3e5",
              "leftValue": "={{ $json.invoices.length != 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3700,
        2300
      ],
      "id": "fe597016-2308-490b-9f2a-0704e3dac81f",
      "name": "If6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5c5484d4-7a9b-4154-b35d-f35ba130478e",
              "leftValue": "={{ $json.route!=null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3080,
        2820
      ],
      "id": "ed3f97b4-3fd9-4365-802d-b857d7fd9bf4",
      "name": "If7"
    },
    {
      "parameters": {
        "jsCode": "// Get routes safely\nconst routes = $(\"Switch\").first().json?.data?.routes ?? [];\n\n// Find the first route with route_by === \"by_invoice_id\"\nconst matchedRoute = routes.find(r => r.route_by === \"by_amount_only\") || null;\n\n// Return result\nreturn [\n  {\n    json: {\n      route: matchedRoute\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2420,
        2920
      ],
      "id": "3d1072c0-069f-4ff5-bbfe-4983376bb71c",
      "name": "ByAmount"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c40961bf-6c6e-4d49-9479-eccaaa923faa",
              "name": "invoices",
              "value": "={{ $json.invoices?? [] }}",
              "type": "array"
            },
            {
              "id": "e560ccd1-2cf8-4fbf-8b1a-3a2bea01ce0d",
              "name": "route_by",
              "value": "={{ $('ByInvoiceId').first().json.route.route_by }}",
              "type": "string"
            },
            {
              "id": "48020a1b-789f-4b3c-8099-b2769ee88703",
              "name": "=invoice_next_step",
              "value": "={{ $('ByInvoiceId').first().json.route.next_step }}",
              "type": "string"
            },
            {
              "id": "dcbf256a-ea6d-432c-8986-72fec89726f7",
              "name": "status",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4540,
        2260
      ],
      "id": "fd4f62bf-767e-448c-93b7-f14a80f265ad",
      "name": "InvoiceOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5c5484d4-7a9b-4154-b35d-f35ba130478e",
              "leftValue": "={{ $json.route!=null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2200,
        2920
      ],
      "id": "a878e496-deab-4a8c-93fe-bf457b8a0f3b",
      "name": "If8"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "757ce2c4-8561-4815-8386-699787b7d3e5",
              "leftValue": "={{ $json.invoices.length != 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2640,
        1800
      ],
      "id": "f5d0905d-0cae-49d9-90ce-b3c62372c4ce",
      "name": "If9"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c40961bf-6c6e-4d49-9479-eccaaa923faa",
              "name": "invoices",
              "value": "={{ $json.invoices?? [] }}",
              "type": "array"
            },
            {
              "id": "e560ccd1-2cf8-4fbf-8b1a-3a2bea01ce0d",
              "name": "route_by",
              "value": "={{ $('ByRecAndAmount').first().json.route.route_by }}",
              "type": "string"
            },
            {
              "id": "e58469f7-ceab-460f-8184-090ae925a99c",
              "name": "status",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3300,
        2260
      ],
      "id": "3ef350f3-289d-4f69-b209-81bc2631c595",
      "name": "InvoiceOutput1"
    },
    {
      "parameters": {
        "jsCode": "// Get routes safely\nconst routes = $(\"Switch\").first().json?.data?.routes ?? [];\n\n// Find the first route with route_by === \"by_invoice_id\"\nconst matchedRoute = routes.find(r => r.route_by === \"by_recipient_with_amount\") || null;\n\n// Return result\nreturn [\n  {\n    json: {\n      route: matchedRoute\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4540,
        2720
      ],
      "id": "4cdb69c5-c1f0-47ed-9ce2-f4d9325895fc",
      "name": "ByRecAndAmount"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  COALESCE(\n    (\n      SELECT jsonb_agg(\n               jsonb_build_object(\n                'invoice_id', i.invoice_number,\n                'invoice_number', i.number,\n                'title', i.title,\n                'details', i.details,\n                'invoice_amount', i.amount,\n                'invoice_status', i.status,\n                'book_id', i.book_id\n               )\n               ORDER BY i.created_at DESC\n             )\n      FROM (\n        SELECT *\n        FROM invoices_invoice i\n        WHERE i.book_id = $1\n          AND i.invoice_number = $2\n        ORDER BY i.created_at DESC\n        LIMIT 3\n      ) i\n    ),\n    '[]'::jsonb\n  ) AS invoices;\n",
        "options": {
          "queryReplacement": "={{ $json.route.book_id }}, {{ $json.route.invoice_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5100,
        2560
      ],
      "id": "021e4105-faaa-4a58-8ec9-c0b09a6a3690",
      "name": "GetInvoices",
      "retryOnFail": true,
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  COALESCE(\n    (\n      SELECT jsonb_agg(\n               jsonb_build_object(\n                 'invoice_id', i.invoice_number,\n                 'invoice_number', i.number,\n                 'title', i.title,\n                 'details', i.details,\n                 'invoice_amount', i.amount,\n                 'invoice_status', i.status,\n                 'invoice_customer_id', i.customer_id,\n                 'invoice_recipient', $4   -- still supplied by caller\n               )\n             )\n      FROM (\n        SELECT i.*\n        FROM invoices_invoice i\n        JOIN invoices_invoiceclient ic\n          ON ic.id = i.customer_id\n        WHERE i.amount = $1          -- amount\n          AND ic.number = $2         -- customer number\n          AND i.book_id = $3         -- scope by book\n        ORDER BY i.created_at DESC\n        LIMIT 3\n      ) i\n    ),\n    '[]'::jsonb\n  ) AS invoices;\n",
        "options": {
          "queryReplacement": "={{ $json.route.amount }}, {{ $json.route.recipient_number }}, {{ $json.route.book_id }}, {{ $json.route.recipient_name }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -4100,
        2400
      ],
      "id": "31f47275-8a37-4c1e-81f7-51a5bbc21961",
      "name": "GetInvoices1",
      "retryOnFail": true,
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  COALESCE(\n    (\n      SELECT jsonb_agg(\n               jsonb_build_object(\n                 'invoice_id', i.invoice_number,\n                 'invoice_number', i.number,\n                 'title', i.title,\n                 'details', i.details,\n                 'invoice_amount', i.amount,\n                 'invoice_status', i.status,\n                 'invoice_customer_id', i.customer_id,\n                 'invoice_recipient', $3   -- still supplied by caller\n               )\n               ORDER BY i.created_at DESC\n             )\n      FROM (\n        SELECT *\n        FROM invoices_invoice\n        WHERE book_id = $2\n          AND customer_id = (\n            SELECT ic.id\n            FROM invoices_invoiceclient ic\n            WHERE ic.number = $1\n          )\n        ORDER BY created_at DESC\n        LIMIT 3\n      ) i\n    ),\n    '[]'::jsonb\n  ) AS invoices;\n",
        "options": {
          "queryReplacement": "={{ $json.route.recipient_number }}, {{ $json.route.book_id }}, {{ $json.route.recipient_name }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2860,
        1940
      ],
      "id": "4dd19957-1496-4879-b4fa-c94883e38a3a",
      "name": "GetInvoices2",
      "retryOnFail": true,
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  COALESCE(\n    (\n      SELECT jsonb_agg(t)\n      FROM (\n        SELECT jsonb_build_object(\n                 'invoice_id', i.invoice_number,\n                 'invoice_number', i.number,\n                 'title', i.title,\n                 'details', i.details,\n                 'invoice_amount', i.amount,\n                 'invoice_status', i.status,\n                 'book_id', i.book_id,\n                 'invoice_customer_id', i.customer_id\n               ) AS t\n        FROM invoices_invoice i\n        WHERE i.amount = $1\n          AND i.book_id = $2\n        ORDER BY i.created_at DESC\n        LIMIT 3\n      ) sub\n    ),\n    '[]'::jsonb\n  ) AS invoices;\n",
        "options": {
          "queryReplacement": "={{ $json.route.amount }}, {{ $json.route.book_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1980,
        1780
      ],
      "id": "f83d8f7e-c3fc-4377-a855-ff140aa0aa3a",
      "name": "GetInvoices3",
      "retryOnFail": true,
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c40961bf-6c6e-4d49-9479-eccaaa923faa",
              "name": "invoices",
              "value": "={{ $json.invoices?? [] }}",
              "type": "array"
            },
            {
              "id": "e560ccd1-2cf8-4fbf-8b1a-3a2bea01ce0d",
              "name": "route_by",
              "value": "={{ $('ByRecipient').first().json.route.route_by }}",
              "type": "string"
            },
            {
              "id": "4d77d828-2b50-4534-b015-8c5eac22dc4a",
              "name": "status",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2420,
        1760
      ],
      "id": "77f32269-138a-4816-89b8-9136c6bcaca5",
      "name": "InvoiceOutput2"
    },
    {
      "parameters": {
        "jsCode": "// Get routes safely\nconst routes = $(\"Switch\").first().json?.data?.routes ?? [];\n\n// Find the first route with route_by === \"by_invoice_id\"\nconst matchedRoute = routes.find(r => r.route_by === \"by_recipient_no_amount\") || null;\n\n// Return result\nreturn [\n  {\n    json: {\n      route: matchedRoute\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3300,
        2820
      ],
      "id": "c4081867-be8a-4c04-bbee-f91377f3cb9e",
      "name": "ByRecipient"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c40961bf-6c6e-4d49-9479-eccaaa923faa",
              "name": "invoices",
              "value": "={{ $json.invoices?? [] }}",
              "type": "array"
            },
            {
              "id": "e560ccd1-2cf8-4fbf-8b1a-3a2bea01ce0d",
              "name": "route_by",
              "value": "={{ $('ByAmount').first().json.route.route_by }}",
              "type": "string"
            },
            {
              "id": "7475bba3-5526-42fa-920c-66eea607fc17",
              "name": "status",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1760,
        3020
      ],
      "id": "f58bedaf-966f-4728-b918-9d1b1e947f63",
      "name": "InvoiceOutput3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "162a3fa5-af95-4298-aee0-c7da07a90bae",
              "name": "status",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "bb557265-4bfd-4fcd-b122-4202d7575eaf",
              "name": "message",
              "value": "Failed due to technical reasons",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4760,
        2660
      ],
      "id": "4db47870-a97a-45ce-8557-5e0b089ae667",
      "name": "Error"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "162a3fa5-af95-4298-aee0-c7da07a90bae",
              "name": "status",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "bb557265-4bfd-4fcd-b122-4202d7575eaf",
              "name": "message",
              "value": "Failed due to technical reasons",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3700,
        2500
      ],
      "id": "dfeee6a3-1036-450c-b179-25569832aa02",
      "name": "Error1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "162a3fa5-af95-4298-aee0-c7da07a90bae",
              "name": "status",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "bb557265-4bfd-4fcd-b122-4202d7575eaf",
              "name": "message",
              "value": "Failed due to technical reasons",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2640,
        2040
      ],
      "id": "1b4de9ec-6e51-4b4f-92b1-e064f4cfc216",
      "name": "Error2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "162a3fa5-af95-4298-aee0-c7da07a90bae",
              "name": "status",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "bb557265-4bfd-4fcd-b122-4202d7575eaf",
              "name": "message",
              "value": "Failed due to technical reasons",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1760,
        1740
      ],
      "id": "5c6c3b85-e678-45a2-a47a-19be54dfcce4",
      "name": "Error3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserAutofixing",
      "typeVersion": 1,
      "position": [
        -5140,
        1880
      ],
      "id": "6afbf5c2-face-4979-ac6a-d5a7f099560b",
      "name": "Auto-fixing Output Parser"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2111359a-e427-4309-959d-330b0684f2f9",
              "name": "message",
              "value": "=Encountered some technical issue while creating the invoice. Excuse to the usre. Ask the manager to retry after some time and set the next_task = 'no_action'.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3300,
        2040
      ],
      "id": "440d1c85-e260-41b1-bd31-bbd561e1a82c",
      "name": "Edit Fields8"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f5ef10ea-156d-417f-bb44-a161c486a098",
              "leftValue": "={{ $json.status!=\"Paid\" }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5440,
        2060
      ],
      "id": "e9a734cf-8010-4168-a011-375c96ae9c76",
      "name": "If"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2111359a-e427-4309-959d-330b0684f2f9",
              "name": "message",
              "value": "=The invoice status is already Paid and cannot be processed further. Inform the manager about it. If the Manager hase requested invoice file specifically, next call the tool 'InvoiceFileRequest' to generate and send the invoice file.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5160,
        2280
      ],
      "id": "c5289a93-5686-4ec7-ad96-64502e52448f",
      "name": "Edit Fields9"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT firebase_uid as x_acting_as_user FROM hub_user_hubuser WHERE number= $1",
        "options": {
          "queryReplacement": "={{ $('Trigger').item.json.data.user_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5440,
        1280
      ],
      "id": "00edf6f6-e2ff-41c7-bd40-48c8fa53b6fd",
      "name": "firebaseId2",
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hub-api-prod-649845453193.us-central1.run.app/api/v1/authentication/system-user/token",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "=5dd3450f93dfb2415c97e282"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -5740,
        1360
      ],
      "id": "7f456cac-9759-4149-a6b2-dc8268b7e7fe",
      "name": "access_token2",
      "retryOnFail": true,
      "executeOnce": false,
      "credentials": {
        "googleApi": {
          "id": "Hue2Vve59bazs83Y",
          "name": "Google Service Account account 2"
        },
        "httpBearerAuth": {
          "id": "db2me6PVtNUH5oYv",
          "name": "Bearer Auth account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// Get the metadata string from Trigger node\nconst metadataString = $('GetUserSession1').item.json.user_session;\n\n// Safely parse the JSON string into an object\nlet updatedMetadata;\ntry {\n  updatedMetadata = typeof metadataString === 'string' \n    ? JSON.parse(metadataString) \n    : metadataString;\n} catch (error) {\n  throw new Error(`Failed to parse metadata: ${error.message}`);\n}\n\n// Ensure invoice_metadata exists, but preserve all other data\nif (!updatedMetadata.invoice_metadata) {\n  updatedMetadata.invoice_metadata = {};\n}\n\n// Only update the pdf_invoice_content field\nupdatedMetadata.invoice_metadata.invoice_file = {}\n  updatedMetadata.invoice_metadata.invoice_file.pdf_invoice_content = $input.first().binary.invoice.data;\nupdatedMetadata.invoice_metadata.invoice_file.file_name = $('Get Invoice')?.first()?.json.download_file_name || $('Get Invoice3')?.first()?.json.download_file_name \n  \n// Return updated object\nreturn [\n  {\n    json: {\n      user_session: updatedMetadata,\n    },\n  },\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3380,
        1040
      ],
      "id": "e1ccaa66-27ed-4691-bdd7-b7714e40939e",
      "name": "Code"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $('Trigger').first().json.data.ThreadId+$('Trigger').first().json.data.user_id }}",
        "value": "={{ $json.user_session.toJsonString() }}",
        "expire": true,
        "ttl": "={{ 60 * 60 * 24 * 30 }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -3080,
        1040
      ],
      "id": "237d3ef6-1740-4c7f-8aa3-8f458b23026a",
      "name": "UpdateSesssion5",
      "retryOnFail": true,
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "28d9ee30-04e5-43d5-b29a-38211df99b7c",
              "name": "message",
              "value": "The feature to send files as email to recipients is not build yet.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5740,
        1660
      ],
      "id": "9ad89322-481e-4c28-b627-44dce853c2cf",
      "name": "Edit Fields11"
    },
    {
      "parameters": {
        "url": "=https://hub-api-prod-649845453193.us-central1.run.app/api/v1/invoices/{{ $('Trigger').item.json.data.invoice_number }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$('access_token2').item.json.access_token.trim() }}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $json.x_acting_as_user }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -5100,
        1200
      ],
      "id": "23303f04-522c-4f15-b2f4-28f80e7513b3",
      "name": "Get Invoice",
      "retryOnFail": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "28d9ee30-04e5-43d5-b29a-38211df99b7c",
              "name": "message",
              "value": "=Encountered a technical issue to retrieve the invoice file. Inform the manager that Patchbay technical support team will reach out to him soon. set next_task = no_action.",
              "type": "string"
            },
            {
              "id": "db9c080a-7efd-44a2-892f-f3299cd0d62a",
              "name": "status",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5100,
        1460
      ],
      "id": "1133e7ad-182d-4a5e-aae4-a418ab64769e",
      "name": "OnError"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "28d9ee30-04e5-43d5-b29a-38211df99b7c",
              "name": "message",
              "value": "=Encountered a technical issue to retrieve the invoice file. Inform the user and set next_task = no_action.",
              "type": "string"
            },
            {
              "id": "58a4d5a7-cdce-4bb5-bd3b-31448e733d16",
              "name": "status",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2900,
        1340
      ],
      "id": "a985d86a-1210-48da-b7e9-775c7c90697a",
      "name": "OnError1"
    },
    {
      "parameters": {
        "jsCode": "// Get the AI Agent output\nconst aiAgentOutput = $('AI Agent').item.json.output;\n\n// Parse if string, otherwise use as-is\nconst data = typeof aiAgentOutput === 'string' ? JSON.parse(aiAgentOutput) : aiAgentOutput;\n\n// Convert to markdown format\nfunction toMarkdownString(obj, prefix = '') {\n    let result = '';\n    \n    if (obj === null || obj === undefined) {\n        return `${prefix}: null\\n`;\n    }\n    \n    if (Array.isArray(obj)) {\n        if (obj.length === 0) {\n            return `${prefix}: []\\n`;\n        }\n        obj.forEach((item, index) => {\n            const newPrefix = prefix ? `${prefix}[${index}]` : `[${index}]`;\n            if (typeof item === 'object' && item !== null) {\n                result += toMarkdownString(item, newPrefix);\n            } else {\n                result += `${newPrefix}: ${String(item)}\\n`;\n            }\n        });\n        return result;\n    }\n    \n    if (typeof obj === 'object') {\n        const entries = Object.entries(obj);\n        if (entries.length === 0) {\n            return `${prefix}: {}\\n`;\n        }\n        \n        entries.forEach(([key, value]) => {\n            const newPrefix = prefix ? `${prefix}.${key}` : key;\n            \n            if (value === null || value === undefined) {\n                result += `${newPrefix}: null\\n`;\n            } else if (Array.isArray(value)) {\n                if (value.length === 0) {\n                    result += `${newPrefix}: []\\n`;\n                } else {\n                    value.forEach((item, index) => {\n                        const arrayPrefix = `${newPrefix}[${index}]`;\n                        if (typeof item === 'object' && item !== null) {\n                            result += toMarkdownString(item, arrayPrefix);\n                        } else {\n                            result += `${arrayPrefix}: ${String(item)}\\n`;\n                        }\n                    });\n                }\n            } else if (typeof value === 'object') {\n                result += toMarkdownString(value, newPrefix);\n            } else {\n                result += `${newPrefix}: ${String(value)}\\n`;\n            }\n        });\n        return result;\n    }\n    \n    return `${prefix}: ${String(obj)}\\n`;\n}\n\n// Generate markdown\nconst markdown = toMarkdownString(data);\n\n// Return for next node\nreturn {\n    markdown: markdown\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3300,
        1640
      ],
      "id": "8594af48-96a8-4c5c-bb0e-701e058c0c12",
      "name": "Code1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hub-api-prod-649845453193.us-central1.run.app/api/v1/invoices",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$('access_token').item.json.access_token.trim() }}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $json.x_acting_as_user }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('invoice_payload').first().json.output }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2640,
        440
      ],
      "id": "8ec4bc94-4f84-4a29-8a91-34e1bef9fa24",
      "name": "CreateInvoice",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3bd6ea95-7bc1-4589-bf96-9e863e87e14d",
              "name": "message",
              "value": "=The invoice creation failed due to technical issues. Inform the manager about the issue and that a Patchbay representative will reach out to him soon..\n- Set the next_task to \"no_action\"",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2200,
        740
      ],
      "id": "a55d78e5-7a25-4b2b-bdb7-ba2e99448d18",
      "name": "OnFailure"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DI0OK2QjzXrFmcrM",
          "mode": "list",
          "cachedResultName": "InvoiceCustomer-V-1.0.3"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "retrieve",
            "data": "={{  \n{\n\"invoice_recipient\": $json.invoice_recipient.name ?? \"\", \"threshold\": 0.05,\nbook_number: $json.metadata.person_verification.book_number\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -5100,
        420
      ],
      "id": "32631ccb-cb28-4a3b-a13c-cb4ec6824fcb",
      "name": "InvoiceRecipient1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d788525e-ebda-43f4-b7af-93b4cfd9eb08",
              "leftValue": "={{ $json.invoice_recipient.status }}",
              "rightValue": "exists",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4760,
        440
      ],
      "id": "4e9641c5-3563-4ed0-baec-0c0ec293d750",
      "name": "If2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c8ce596d-8435-4fbd-ab81-a988d92acfc5",
              "name": "invoice_recipient.status",
              "value": "={{ $json.invoice_recipient.status }}",
              "type": "string"
            },
            {
              "id": "80da6f4c-5a53-49a9-83db-02ed91616074",
              "name": "invoice_recipient.name",
              "value": "={{ $json.invoice_recipient.name }}",
              "type": "string"
            },
            {
              "id": "b129ee59-aa3c-4e37-9f80-8561ee0d74c6",
              "name": "invoice_recipient.data.customer_number",
              "value": "={{ $json.invoice_recipient.invoice_recipient_number }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4540,
        340
      ],
      "id": "10bc52ea-673d-481c-a03b-aaf3eb0c0e6a",
      "name": "Edit Fields4"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4140,
        660
      ],
      "id": "2fd1e1a4-1669-4c4f-b76a-e5c09ecf5250",
      "name": "Format2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://hub-api-prod-649845453193.us-central1.run.app/api/v1/invoices/{{ $json.number }}/pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$('access_token2').item.json.access_token.trim() }}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $('firebaseId2').item.json.x_acting_as_user }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4540,
        1360
      ],
      "id": "0064240f-28dd-41f2-b2bf-e31877ba1524",
      "name": "CreateFile1",
      "retryOnFail": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "59f956fe-e4a5-436f-bd2f-edd234f22e44",
              "leftValue": "={{ $json.pdf_on_file===true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4740,
        1160
      ],
      "id": "bb778bb4-00d5-4bf8-94a3-08ac9c03031b",
      "name": "If10"
    },
    {
      "parameters": {
        "amount": 30
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -4320,
        1280
      ],
      "id": "42dc8d04-eaf7-4f5a-8517-d62e87c259e2",
      "name": "Wait1",
      "webhookId": "bf03785d-b139-4884-936c-054436d216db"
    },
    {
      "parameters": {
        "resource": "object",
        "operation": "get",
        "bucketName": "hub-file-storage-prod",
        "objectName": "={{ `books/${$json.book_number}/invoices/${$json.number}/${$json.download_file_name}`.replace(/\\//g, '%2F') }}",
        "alt": "media",
        "binaryPropertyName": "invoice",
        "getParameters": {},
        "encryptionHeaders": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.googleCloudStorage",
      "typeVersion": 1,
      "position": [
        -3740,
        1140
      ],
      "id": "428ea44b-1bdb-4471-926f-ad25887edc50",
      "name": "Google Cloud Storage",
      "retryOnFail": true,
      "maxTries": 2,
      "credentials": {
        "googleCloudStorageOAuth2Api": {
          "id": "jzaYLc3hMj1WhMUi",
          "name": "Google Cloud Storage account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "url": "=https://hub-api-prod-649845453193.us-central1.run.app/api/v1/invoices/{{ $('Trigger').item.json.data.invoice_number }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$('access_token2').item.json.access_token.trim() }}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $('firebaseId2').item.json.x_acting_as_user }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4100,
        1280
      ],
      "id": "37cf9624-7efb-4fd8-8920-fb6d6aea786d",
      "name": "Get Invoice3",
      "retryOnFail": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "28d9ee30-04e5-43d5-b29a-38211df99b7c",
              "name": "message",
              "value": "=Encountered a technical issue to retrieve the invoice file. Inform the manager that Patchbay technical support team will reach out to him soon. set next_task = no_action.",
              "type": "string"
            },
            {
              "id": "506e20ee-5f91-43a1-a920-5f2b95680303",
              "name": "status",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3360,
        1360
      ],
      "id": "4a3498fd-25c9-4e1c-9135-f26a5327dfda",
      "name": "OnError2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "08bf5a51-376f-4344-9a6e-d5aa531a3506",
              "leftValue": "={{ $('Trigger').first()?.json?.data?.invoice_file_request}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1760,
        380
      ],
      "id": "ae763a01-7669-4f3f-b377-bab165aa613e",
      "name": "If11"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f36c5ff6-d53f-434e-9a6b-7ebe81047c99",
              "name": "message",
              "value": "=Invoice created successfully with below details;\n\nInvoice ID: {{ $('CreateInvoice').first().json.invoice_number }}\nTitle: {{ $('CreateInvoice').first().json.title }}\nInvoice Amount: {{ $('CreateInvoice').first().json.amount }}\nStatus: {{ $('CreateInvoice').first().json.status }}\nRecipient: {{ $('CreateInvoice').first().json.customer?.address?.name || \"Not Mentioned\" }}\nCurrency: {{ $('CreateInvoice').first().json.currency }}\nIssue_date: {{ $('CreateInvoice').first().json.issued_on }}\nDue_date: {{ $('CreateInvoice').first().json.due_on }}\n\nNext:\n- Set the next_task = no_action\n- Don't call any other tool further.\n\nInform the manager about the invoice created.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1480,
        660
      ],
      "id": "2ea2d314-2939-4c57-8e13-84144b053af4",
      "name": "Edit Fields10"
    },
    {
      "parameters": {
        "jsCode": "// Get the metadata object from Trigger node\nconst metadata = $('Trigger').item.json.data.metadata;\n\n// Clone to avoid mutating directly (optional)\nlet updatedMetadata = { ...metadata };\n\n// Ensure invoice_metadata exists\nif (!updatedMetadata.invoice_metadata) {\n  updatedMetadata.invoice_metadata = {};\n}\n\n// Add / update pdf_invoice_content\nupdatedMetadata.invoice_metadata.pdf_invoice_content = $input.first().binary.invoice.data;\n\n// Return updated object\nreturn [\n  {\n    json: {\n        user_session: updatedMetadata,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -440,
        60
      ],
      "id": "dc4ff5ac-f941-4a29-a0cb-13d7a01e7b3a",
      "name": "Code5"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $('Trigger').first().json.data.ThreadId+$('Trigger').first().json.data.user_id }}",
        "value": "={{ $json.user_session.toJsonString() }}",
        "expire": true,
        "ttl": "={{ 60 * 60 * 24 * 30 }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -220,
        60
      ],
      "id": "c6449150-adee-4dd3-b3ff-6f032118954d",
      "name": "UpdateSesssion6",
      "retryOnFail": true,
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://hub-api-prod-649845453193.us-central1.run.app/api/v1/invoices/{{ $json.number }}/pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$('access_token').item.json.access_token.trim() }}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $('firebaseId1').item.json.x_acting_as_user }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1320,
        380
      ],
      "id": "1e5ab620-ebc3-454e-b96b-f80fa04bf8fc",
      "name": "CreateFile2",
      "retryOnFail": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "59f956fe-e4a5-436f-bd2f-edd234f22e44",
              "leftValue": "={{ $json.pdf_on_file===true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1540,
        280
      ],
      "id": "35c78716-299e-4a6f-a1f2-909d9f81cf80",
      "name": "If12"
    },
    {
      "parameters": {
        "amount": 30
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -1100,
        300
      ],
      "id": "9cfe78fb-0222-4234-843e-9dbe002b25cf",
      "name": "Wait2",
      "webhookId": "bf03785d-b139-4884-936c-054436d216db"
    },
    {
      "parameters": {
        "url": "=https://hub-api-prod-649845453193.us-central1.run.app/api/v1/invoices/{{ $('Trigger').item.json.data.metadata.invoice_metadata.invoice_number }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$('access_token').item.json.access_token.trim() }}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $('firebaseId1').item.json.x_acting_as_user }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -880,
        300
      ],
      "id": "5eefe9b3-38f8-401f-8b4f-e0ed1a6b0a1b",
      "name": "Get Invoice4",
      "retryOnFail": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f36c5ff6-d53f-434e-9a6b-7ebe81047c99",
              "name": "message",
              "value": "=Invoice created successfully with below details;\n\nInvoice ID: {{ $('CreateInvoice').first().json.invoice_number }}\nTitle: {{ $('CreateInvoice').first().json.title }}\nInvoice Amount: {{ $('CreateInvoice').first().json.amount }}\nStatus: {{ $('CreateInvoice').first().json.status }}\nRecipient: {{ $('CreateInvoice').first().json.customer?.address?.name || \"Not Mentioned\" }}\nCurrency: {{ $('CreateInvoice').first().json.currency }}\nIssue_date: {{ $('CreateInvoice').first().json.issued_on }}\nDue_date: {{ $('CreateInvoice').first().json.due_on }}\n\nHowever, the attempt to retrieve invoice file for Manager failed due to technical reasons.\n\nNext:\n- Set the next_task = no_action\n- Don't call any other tool further.\n\nInform the manager about the invoice created.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        380
      ],
      "id": "dedc5337-28f5-4949-b5ec-5449b42687b9",
      "name": "Edit Fields12"
    },
    {
      "parameters": {
        "resource": "object",
        "operation": "get",
        "bucketName": "hub-file-storage-prod",
        "objectName": "={{ `books%2F${$json.book_number}%2F${$json.number}%2F${$json.download_file_name}` }}",
        "alt": "media",
        "binaryPropertyName": "invoice",
        "getParameters": {},
        "encryptionHeaders": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.googleCloudStorage",
      "typeVersion": 1,
      "position": [
        -660,
        140
      ],
      "id": "aafd8b23-6142-4070-b397-5c3018cfbb66",
      "name": "GetFile",
      "retryOnFail": true,
      "maxTries": 2,
      "credentials": {
        "googleCloudStorageOAuth2Api": {
          "id": "jzaYLc3hMj1WhMUi",
          "name": "Google Cloud Storage account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f36c5ff6-d53f-434e-9a6b-7ebe81047c99",
              "name": "message",
              "value": "=Invoice created successfully with below details;\n\nInvoice ID: {{ $('CreateInvoice').first().json.invoice_number }}\nTitle: {{ $('CreateInvoice').first().json.title }}\nInvoice Amount: {{ $('CreateInvoice').first().json.amount }}\nStatus: {{ $('CreateInvoice').first().json.status }}\nRecipient: {{ $('CreateInvoice').first().json.customer?.address?.name || \"Not Mentioned\" }}\nCurrency: {{ $('CreateInvoice').first().json.currency }}\nIssue_date: {{ $('CreateInvoice').first().json.issued_on }}\nDue_date: {{ $('CreateInvoice').first().json.due_on }}\n\nNext:\n- Set the next_task = send_file_to_user\n- Don't call any other tool.\n\nInform the manager about the invoice created and let him know to find the invoice file as attached.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        0
      ],
      "id": "cdea7f79-0a9f-4180-b64c-173372e3dfc2",
      "name": "Edit Fields13"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://hub-api-prod-649845453193.us-central1.run.app/api/v1/invoices/{{ $('Trigger').item.json.data.invoice_number }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$('access_token1').item.json.access_token.trim() }}"
            },
            {
              "name": "X-Acting-As-User",
              "value": "={{ $json.x_acting_as_user }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('UpdatePayload').item.json.output }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3700,
        1680
      ],
      "id": "d1967803-953c-4af7-9323-34f3a4dfb373",
      "name": "Update",
      "retryOnFail": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "34849289-7322-4a23-923a-ab1a7f20a242",
              "name": "message",
              "value": "=Requested Invoice File for below details is attached. Inform the manager to find the file as attachement. \n\nInvoice ID: {{ $('Get Invoice').item.json.invoice_number }}\nTitle: {{ $('Get Invoice').first().json.title }}\nInvoice Amount: {{ $('Get Invoice').first().json.amount }}\nStatus: {{ $('Get Invoice').first().json.status }}\nRecipient: {{ $('Get Invoice').first().json.customer?.address?.name || \"Not Mentioned\" }}\nCurrency: {{ $('Get Invoice').first().json.currency }}\nIssue_date: {{ $('Get Invoice').first().json.issued_on }}\nDue_date: {{ $('Get Invoice').first().json.due_on }}\n\n- Set next_task = send_file_to_user.",
              "type": "string"
            },
            {
              "id": "a57a8171-2ccf-4746-aed4-7c086ecf88ce",
              "name": "file_status",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2860,
        940
      ],
      "id": "fa5715b0-c73a-4f4a-a7a4-d8ad5d21b3e7",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "91511acc-0775-4b15-ac71-fa59b0dfa57f",
              "name": "output.book_number",
              "value": "={{ $('Trigger').item.json.data.metadata.person_verification.book_number }}",
              "type": "string"
            },
            {
              "id": "287f313a-9203-462b-9540-795de1f2961b",
              "name": "output.customer_number",
              "value": "={{ $('Format2').first().json.metadata.invoice_metadata.invoice_recipient.status === \"exists\" ? $('Format2').first().json.metadata.invoice_metadata.invoice_recipient.invoice_recipient_number : null }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3300,
        500
      ],
      "id": "beebddfb-ac45-4598-8cd4-430a82d833b1",
      "name": "invoice_payload"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "40d7397e-7161-46b6-a482-274968d356d7",
              "name": "invoice_search_findings",
              "value": "={{ $json.output.invoice_findings }}",
              "type": "string"
            },
            {
              "id": "f6f9f910-0297-41dc-a18b-5076731f6203",
              "name": "invoice_next_step",
              "value": "={{ $json.output.invoice_next_steps }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5440,
        2920
      ],
      "id": "009fec11-517b-43bc-94b5-5eb2673ffc14",
      "name": "New/Options"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.data.input }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "={{ $json.data.system_prompt }}"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.6,
      "position": [
        -5820,
        2920
      ],
      "id": "d22dcc8f-a21d-4343-86d0-e159ffd2f08d",
      "name": "Basic LLM Chain2",
      "retryOnFail": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -5800,
        3140
      ],
      "id": "dc13526c-ae88-48aa-bebd-0393dd009ee3",
      "name": "OpenAI Chat Model5",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n\t\"type\": \"object\",\n\t\"properties\": {\n\t\t\"invoice_next_steps\": {\n\t\t\t\"type\": \"string\",\n            \"enum\": [\"update\", \"not_update\", \"create_new\"],\n            \"description\": \"decide based on the invoice analysis\"\n    \t},\n      \t\"invoice_findings\": {\n\t\t\t\"type\": \"string\",\n            \"description\": \"<Invoice Findings>.\"\n\t\t}\n    }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -5680,
        3140
      ],
      "id": "163bb563-789b-4d32-b1c2-e1f268f0533c",
      "name": "Structured Output Parser8"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $('Trigger').first().json.data.ThreadId+$('Trigger').first().json.data.user_id }}",
        "value": "={{ $json.user_session.toJsonString() }}",
        "expire": true,
        "ttl": "={{ 60 * 60 * 24 * 30 }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2200,
        340
      ],
      "id": "77863fb5-f2aa-4915-a458-023e2829ad45",
      "name": "UpdateSesssion7",
      "retryOnFail": true,
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "user_session",
        "key": "=user_session_{{ $('Trigger').item.json.data.ThreadId+$('Trigger').item.json.data.user_id }}",
        "keyType": "string",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -6480,
        1960
      ],
      "id": "6073ba82-6b83-413a-8d86-bec293e7526c",
      "name": "GetUserSession1",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "let trigger_input = $(\"Trigger\").first().json;\nconst user_session = $json.user_session;\n// Validate and parse user_session\nlet validatedSession;\nif (typeof user_session === \"string\") {\n  try {\n    validatedSession = JSON.parse(user_session);\n  } catch (error) {\n    console.error(\"Failed to parse user_session:\", error);\n    validatedSession = { sessionStatus: false, error: \"Invalid JSON\" };\n  }\n} else if (user_session && typeof user_session === \"object\") {\n  validatedSession = user_session;\n} else {\n  validatedSession = { sessionStatus: false, error: \"No session data\" };\n}\n// Check if deal_id exists and has a valid value\nif (trigger_input.data && trigger_input.data.deal_id && trigger_input.data.deal_id !== null && trigger_input.data.deal_id !== '') {\n  // Remove leading zeros from deal_id\n  const dealIdFromTrigger = String(trigger_input.data.deal_id).replace(/^0+/, '') || '0';\n  \n  // Filter deal_metadata if it exists\n  if (validatedSession.deal_metadata && Array.isArray(validatedSession.deal_metadata)) {\n    validatedSession.deal_metadata = validatedSession.deal_metadata.filter(deal => {\n      if (deal.deal_id) {\n        // Remove leading zeros from deal_id for comparison\n        const dealId = String(deal.deal_id).replace(/^0+/, '') || '0';\n        return dealId === dealIdFromTrigger;\n      }\n      return false;\n    });\n  }\n}\n// If deal_id is missing/invalid, deal_metadata remains as it was in user_session\n\n// Ensure trigger_input has metadata object\nif (!trigger_input.data.metadata) {\n  trigger_input.data.metadata = {};\n}\ntrigger_input.data.metadata = validatedSession;\nreturn trigger_input;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6260,
        1960
      ],
      "id": "ea0abebc-5cba-487c-b297-9573c691d4bd",
      "name": "Input"
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Format2').item.json.metadata;\nconst currentInvoice = $input.item.json;\n\n// Validate presence of metadata\nif (!prev) {\n  throw new Error(\"Missing metadata from Format2\");\n}\n\n// Get existing invoice_metadata structure\nconst existingInvoiceMetadata = prev.invoice_metadata || { invoices: [] };\nconst existingInvoices = existingInvoiceMetadata.invoices || [];\n\n// Create Map from existing data - only include entries with invoice_number\n//  THIS ENSURES UNIQUENESS BY invoice_number\nconst uniqueInvoicesMap = new Map(\n  existingInvoices\n    .filter(inv => inv.invoice_number) // Only include entries with invoice_number\n    .map(inv => [inv.invoice_number, inv]) // Key = invoice_number, Value = invoice object\n);\n\n// Add/update current invoice\n//  IF invoice_number EXISTS, IT UPDATES; IF NEW, IT ADDS\nif (currentInvoice.number) {\n  uniqueInvoicesMap.set(currentInvoice.number, {\n    exists: true,\n    invoice_id: currentInvoice.invoice_number,\n    invoice_number: currentInvoice.number,\n    deal_id: $('Trigger')?.first()?.json?.data?.deal_id || null\n  });\n}\n\n// Convert Map to array - guaranteed unique by invoice_number\nconst invoices = Array.from(uniqueInvoicesMap.values());\n\n// Build invoice_metadata structure\nconst invoice_metadata = {\n  invoice_recipient: existingInvoiceMetadata.invoice_recipient || null,\n  invoices: invoices\n};\n\n// Return with updated invoice_metadata, keeping all other keys untouched\nreturn {\n  json: {\n    user_session: {\n      ...prev,\n      invoice_metadata: invoice_metadata\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2420,
        340
      ],
      "id": "1d0fa4d0-3211-468a-8b2f-a93b4da01b6c",
      "name": "Code3"
    }
  ],
  "pinData": {
    "Trigger": [
      {
        "json": {
          "action": "pdf_request",
          "data": {
            "ThreadId": "19934ec38f3bf143",
            "user_id": "b07af3f8-c51e-42df-b5c7-6b5248a5ee5e",
            "invoice_number": "e78c6a99-69fa-4d52-a5e9-065b1b96baac"
          },
          "ai_input": null
        }
      }
    ]
  },
  "repo_name": "hub-n8n",
  "repo_owner": "ck-bit",
  "repo_path": "",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-11-05T03:53:24.784Z",
  "versionId": "133e6231-ed82-43ac-becc-d43642b8d718"
}