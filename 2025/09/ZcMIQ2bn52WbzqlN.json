{
  "active": false,
  "connections": {
    "Trigger": {
      "main": [
        [
          {
            "node": "Memory1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CreateDeal": {
      "ai_tool": [
        [
          {
            "node": "Action Executer",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "CreateInvoice": {
      "ai_tool": [
        [
          {
            "node": "Action Executer",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "UpdateDeal1": {
      "ai_tool": [
        [
          {
            "node": "Action Executer",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "UpdateInvoice1": {
      "ai_tool": [
        [
          {
            "node": "Action Executer",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "FormatHistory": {
      "main": [
        [
          {
            "node": "Action Executer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Memory1": {
      "main": [
        [
          {
            "node": "FormatHistory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ChatHistory": {
      "main": [
        [
          {
            "node": "Postgres2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields5": {
      "main": [
        [
          {
            "node": "ChatHistory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres2": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser": {
      "ai_outputParser": [
        [
          {
            "node": "AutoFix",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "AutoFix": {
      "ai_outputParser": [
        [
          {
            "node": "Action Executer",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Model": {
      "ai_languageModel": [
        [
          {
            "node": "Action Executer",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "AutoFix",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get Invoice File": {
      "ai_tool": [
        [
          {
            "node": "Action Executer",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "SendFile": {
      "ai_tool": [
        []
      ]
    },
    "Action Executer": {
      "main": [
        [
          {
            "node": "Edit Fields5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-09-25T07:28:34.057Z",
  "id": "ZcMIQ2bn52WbzqlN",
  "meta": null,
  "name": "ActionsExecuter-V1.0.4",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "data",
              "type": "any"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -2180,
        100
      ],
      "id": "787337b5-f3dd-4f45-a6ef-d1b57b40c323",
      "name": "Trigger"
    },
    {
      "parameters": {
        "name": "CreateDeal",
        "description": "Call this tool when the user intent is to create a new deal. Execute the tool once and route the user based on the response.",
        "workflowId": {
          "__rl": true,
          "value": "jTv7sJrLK2YoRS2A",
          "mode": "list",
          "cachedResultName": "deal_helpers-V1.0.4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "ai_input": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ai_input', `A complete summary documenting all the latest details discussed in the thread/memory for deal and agreements for the <customer name>.`, 'string') }}",
            "action": "create",
            "data": "={{\n{\n  user_id: $('Trigger').first().json.data.user_id,\n  deal_document: $('Trigger').first().json.data.thread.last_attachment?.document \n  || $('Trigger').first().json.data.thread.Emails,\n  client_id: $('Trigger').first().json.data.metadata.person_verification.book_number,\nstore_file: $fromAI(\"store_file\", \"Set true If the user have explicitly requested to store/file the deal docuemnt in his last message. Otherwise set to false.\", \"boolean\"),\nThreadId : $('Trigger').first().json.data.thread.ThreadId,\nuser_id: $('Trigger').first().json.data.user_id,\nmetadata: $('Trigger').first().json.data.metadata,\nfile: $('Trigger').first().json.data.thread.last_attachment?.file || null\n} \n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -1440,
        420
      ],
      "id": "9f7cc686-aae2-4d81-9ad4-ed612f96dc18",
      "name": "CreateDeal"
    },
    {
      "parameters": {
        "name": "CreateInvoice",
        "description": "Call this tool when the user intent is create a new invoice for the user. This is a critical operation and you must be careful and make sure that this tool needs to be called.",
        "workflowId": {
          "__rl": true,
          "value": "WOYF6k52WBWh9f8A",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "ai_input": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ai_input', `A detailed description of the task to be performed by the worker agent for the Manager <Include manager>. This description must include all the details related to invoice such as recipient, amount, due date, emails and address extracted from all the provided context.`, 'string') }}",
            "action": "create",
            "data": "={{ \n{\nuser_id: $('Trigger').first().json.data.user_id,\nThreadId: $('Trigger').first().json.data.thread.ThreadId,\nmetadata: $('Trigger').first().json.data.metadata,\ninvoice_recipient: $fromAI(\"invoice_recipient\", \"Extract the invoice recipeint if exclusively mentioned in the User message. Make sure not to extract the invoice recipient name from the metadata provided. If not provided, set ''\", \"string\"),\ninvoice_file_request: $fromAI(\"invoice_file_request\", \"Set true If the user have explicitly requested an invoice file after creation. Otherwise set to false.\", \"boolean\"),\nthread: $('Trigger').first().json.data.thread\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -960,
        420
      ],
      "id": "8d7ad265-c281-4728-813a-9aa7100ff7f5",
      "name": "CreateInvoice"
    },
    {
      "parameters": {
        "name": "UpdateDeal",
        "description": "Call this tool only when deal updation is recommended in the last_recommended_action.",
        "workflowId": {
          "__rl": true,
          "value": "jTv7sJrLK2YoRS2A",
          "mode": "list",
          "cachedResultName": "deal_helpers-V1.0.4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "ai_input": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ai_input', `A detailed description of the task to be performed by the worker agent for the Manager <Include manager Details>`, 'string') }}",
            "action": "update",
            "data": "={{\n{\n  user_id: $('Trigger').first().json.data.user_id,\n  recommended_deal_updates: $fromAI(\"recommended_deal_updates\", \"Clearly list the updates needs to be made to the deal which are approved by the user's from the last_action_recommended by you.\", \"string\"),\nstore_file: $fromAI(\"store_file\", \"Set true If the user have explicitly requested to store/file the deal docuemnt in his last message. Otherwise set to false.\", \"boolean\"),\n  deal_id: $fromAI(\"deal_id\", \"Correctly identify extract the 'deal_id' from metadata.deal_metadata.deal_id. If not provided, lookup in metadata from tool:CreateDeal payload.\", \"string\"),\n  deal_number: $fromAI(\"deal_number\", \"Correctly identify extract the 'deal_number' from metadata.deal_metadata.deal_number.If not provided, lookup in metadata from tool:CreateDeal payload.\", \"string\"),\n} \n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -840,
        420
      ],
      "id": "a38fd183-f541-4f3c-adaf-5043afc61eea",
      "name": "UpdateDeal1"
    },
    {
      "parameters": {
        "name": "UpdateInvoice",
        "description": "Call this tool when the user intent is create a new invoice for the user. This is a critical operation and you must be careful and make sure that this tool needs to be called.",
        "workflowId": {
          "__rl": true,
          "value": "WOYF6k52WBWh9f8A",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "ai_input": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ai_input', `A detailed description of the task to be performed by the worker agent for the Manager <Include manager Details>`, 'string') }}",
            "action": "update",
            "data": "={{\n{\n  ThreadId: $('Trigger').first().json.data.thread.ThreadId, \n  user_id: $('Trigger').first().json.data.user_id,\n  recommended_invoice_updates: $fromAI(\"recommended_invoice_updates\", \"Clearly list the updates needs to be made to the current invoice which are approved by the user/manager from the last_action_recommended by you.\", \"string\"),\ninvoice_id: $fromAI(\"deal_id\", \"Correctly identify extract the 'invoice_id' from metadata.invoice_metadata.invoice_d. If not provided, lookup in metadata from tool:CreateDeal payload.\", \"string\"),\n  invoice_number: $fromAI(\"invoice_number\", \"Correctly identify extract the 'invoice_number' from metadata.invoice_number.invoice_number.If not provided, lookup in metadata from tool:CreateDeal payload.\", \"string\"),\n} \n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -720,
        420
      ],
      "id": "e6a27f13-b9c6-4036-9a3d-74b0bda1622f",
      "name": "UpdateInvoice1"
    },
    {
      "parameters": {
        "jsCode": "// n8n Function node\n// Input: last 10 message objects, newest at index 0\n// Output: { json: { markdown: \"<markdown string>\" } }\n\nconst WINDOW_SIZE = 10;\n\n// ---- Helpers ----\nconst toStr = (v) => (v === null || v === undefined) ? \"\" : String(v);\n\nconst stripHtml = (s) => {\n  const str = toStr(s);\n  return str\n    .replace(/<style[\\s\\S]*?<\\/style>/gi, \" \")\n    .replace(/<script[\\s\\S]*?<\\/script>/gi, \" \")\n    .replace(/<[^>]*>/g, \" \")\n    .replace(/\\s+/g, \" \")\n    .trim();\n};\n\nconst decodeHtml = (s) => {\n  const map = {\n    \"&nbsp;\": \" \",\n    \"&lt;\": \"<\",\n    \"&gt;\": \">\",\n    \"&amp;\": \"&\",\n    \"&quot;\": \"\\\"\",\n    \"&#39;\": \"'\",\n  };\n  return toStr(s).replace(/(&nbsp;|&lt;|&gt;|&amp;|&quot;|&#39;)/g, (m) => map[m] || m);\n};\n\nconst htmlToText = (html) => stripHtml(decodeHtml(html));\n\nconst safeJsonParse = (val) => {\n  if (typeof val !== \"string\") return null;\n  const t = val.trim();\n  if (!(t.startsWith(\"{\") || t.startsWith(\"[\"))) return null;\n  try { return JSON.parse(t); } catch { return null; }\n};\n\nconst formatTime = (raw) => {\n  if (!raw) return \"unknown\";\n  // If it's already a readable string (e.g., \"2025-09-05 10:23:44\"), keep it.\n  // Otherwise try to parse and convert to ISO.\n  const d = new Date(raw);\n  if (isNaN(d.getTime())) return toStr(raw).trim();\n  // Use local-like ISO without milliseconds for readability\n  const iso = d.toISOString().replace(\"T\", \" \").replace(\".000Z\", \"Z\");\n  return iso;\n};\n\n// ---- Collect messages (use order as provided; newest first) ----\nlet messages = [];\nif (items.length === 1) {\n  const j = items[0].json ?? {};\n  if (Array.isArray(j)) messages = j;\n  else if (Array.isArray(j.data)) messages = j.data;\n  else if (Array.isArray(j.messages)) messages = j.messages;\n  else if (j.id && j.message) messages = [j];\n} else {\n  for (const it of items) {\n    const j = it.json ?? {};\n    if (j.id && j.message) messages.push(j);\n  }\n}\n\nif (!messages.length) {\n  return [{ json: { history: \"Missing\" } }];\n}\n\n// ---- Keep window of 10 (already newest-first), then switch to chronological for pairing ----\nconst windowMsgs = messages.slice(0, WINDOW_SIZE);\nconst chronological = windowMsgs.slice().reverse(); // oldest -> newest\n\n// ---- Build user→AI turns (with timestamps) ----\nconst turns = [];\nfor (let i = 0; i < chronological.length; i++) {\n  const msg = chronological[i];\n  if (msg?.message?.type === \"human\") {\n    const userRaw = msg.message.content ?? \"\";\n    const userText = stripHtml(userRaw);\n    \n    let aiText = null;\n\n    // Look ahead for next AI reply within the window\n    for (let j = i + 1; j < chronological.length; j++) {\n      const next = chronological[j];\n      const type = next?.message?.type;\n      if (type === \"ai\") {\n        const raw = next.message.content ?? \"\";\n        const parsed = safeJsonParse(raw);\n        const responseHtml = parsed?.output?.response_html ?? null;\n        aiText = responseHtml ? htmlToText(responseHtml) : stripHtml(raw);\n        break;\n      }\n      if (type === \"human\") break; // next human starts a new turn\n    }\n\n    turns.push({\n      userText,\n      aiText,\n    });\n  }\n}\n\n// ---- Build Markdown string ----\nlet md = `### Conversation (last ${Math.min(WINDOW_SIZE, turns.length)} turns)\\n\\n`;\nturns.forEach((t) => {\n  md += `**User** ${t.userText}\\n\\n`;\n  if (t.aiText) {\n    md += `**AI** ${t.aiText}\\n\\n`;\n  } else {\n    md += `**AI** (no reply found)_\\n\\n`;\n  }\n});\n\nreturn [{\n  json: {\n    history: md.trim()\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1740,
        100
      ],
      "id": "5fdf872f-a577-48b6-9963-9d007d020738",
      "name": "FormatHistory"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "name"
        },
        "limit": 5,
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $json.data.thread.ThreadId+$json.data.user_id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "id",
              "direction": "DESC"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1960,
        100
      ],
      "id": "4d75dbcb-45e5-4e8b-8bac-de6e27517a53",
      "name": "Memory1",
      "executeOnce": true,
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "46e7750e-0c4f-4a33-9f60-32a5ade9a825",
              "name": "output",
              "value": "={{ $('Action Executer').first().json.output }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        0
      ],
      "id": "33d11bf3-50dd-4814-8ed2-e0d5028276e3",
      "name": "Edit Fields3",
      "executeOnce": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ea8bc648-c48d-417d-86f0-5cef6db4a27c",
              "leftValue": "={{ $('Action Executer').first().json.output.isNotEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -220,
        100
      ],
      "id": "c0e58c87-38a9-4bba-bc21-6753b4df6547",
      "name": "If3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a162561e-1399-4ee3-9db1-452ef7e923b3",
              "name": "message",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        0,
        200
      ],
      "id": "90f1fdc3-0540-4ed5-b084-2f8438111b4b",
      "name": "Edit Fields4",
      "alwaysOutputData": false,
      "executeOnce": true
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node (JavaScript)\n// Creates two DB-ready objects (human, then ai) with cleaned content\n// Adds \"Last interaction: <date time>\" to the human message content\n// Hardened for Postgres: escapes backslashes and invalid \\u escapes, removes null bytes, fixes unpaired surrogates.\n\n// ---------------- Helpers ----------------\nconst toStr = (v) => (v === null || v === undefined) ? \"\" : String(v);\n\n/** Strip HTML to plain text and tidy whitespace */\nfunction stripHtml(html) {\n  const s = toStr(html);\n  const withoutTags = s.replace(/<[^>]*>/g, \" \");\n  const decoded = withoutTags\n    .replace(/&nbsp;/gi, \" \")\n    .replace(/&amp;/gi, \"&\")\n    .replace(/&lt;/gi, \"<\")\n    .replace(/&gt;/gi, \">\")\n    .replace(/&#39;/gi, \"'\")\n    .replace(/&quot;/gi, '\"');\n  return decoded.replace(/\\s+/g, \" \").trim();\n}\n\n/** Try to parse JSON safely */\nfunction tryParseJson(s) {\n  if (typeof s !== \"string\") return null;\n  const trimmed = s.trim();\n  if (!(trimmed.startsWith(\"{\") || trimmed.startsWith(\"[\"))) return null;\n  try { return JSON.parse(trimmed); } catch { return null; }\n}\n\n/** Remove null bytes and fix unpaired surrogate code units */\nfunction sanitizeUnicode(s) {\n  let out = s.replace(/\\u0000/g, \"\"); // remove NULs\n  // remove unpaired surrogates\n  out = out.replace(/[\\uD800-\\uDBFF](?![\\uDC00-\\uDFFF])|(?<![\\uD800-\\uDBFF])[\\uDC00-\\uDFFF]/g, \"�\");\n  return out;\n}\n\n/** Escape content so Postgres won't treat \\u... as a Unicode escape */\nfunction escapeForPostgresText(s) {\n  // First, double all backslashes\n  let out = s.replace(/\\\\/g, \"\\\\\\\\\");\n  // If any sequence looks like \\u but not \\uXXXX, re-escape it (turn \\\\u into \\\\\\\\u in the final string)\n  out = out.replace(/\\\\u(?![0-9a-fA-F]{4})/g, \"\\\\\\\\u\");\n  return out;\n}\n\n/** Normalize AI/Human content */\nfunction normalizeContent(raw) {\n  const asString = typeof raw === \"string\" ? raw : JSON.stringify(raw ?? \"\");\n  const maybeJson = tryParseJson(asString);\n\n  if (maybeJson && typeof maybeJson === \"object\") {\n    const respHtml =\n      maybeJson?.output?.response_html ??\n      maybeJson?.response_html ??\n      maybeJson?.html ??\n      null;\n\n    if (respHtml) return stripHtml(respHtml);\n\n    if (typeof maybeJson.content === \"string\") {\n      const c = maybeJson.content.trim();\n      return /<[^>]+>/.test(c) ? stripHtml(c) : c;\n    }\n    return JSON.stringify(maybeJson);\n  }\n\n  return /<[^>]+>/.test(asString) ? stripHtml(asString) : asString.trim();\n}\n\n/** Build one DB record */\nfunction buildRecord({ tag, content, session_id, id = null }) {\n  const type = (toStr(tag).toLowerCase() === \"human\") ? \"human\" : \"ai\";\n  let cleaned = normalizeContent(content);\n\n  // Add last interaction timestamp only for human\n  if (type === \"human\") {\n    const ts = new Date().toISOString(); // ISO 8601 (UTC)\n    cleaned += `\\n\\nLast interaction: ${ts}`;\n  }\n\n  // Unicode + Postgres safety\n  cleaned = sanitizeUnicode(cleaned);\n  cleaned = escapeForPostgresText(cleaned);\n\n  return {\n    json: {\n      session_id: toStr(session_id),\n      message: {\n        type,\n        content: cleaned,\n        tool_calls: [],\n        additional_kwargs: {},\n        response_metadata: {},\n        invalid_tool_calls: []\n      }\n    }\n  };\n}\n\n// ---------------- Input Normalization ----------------\nconst inJson = $json ?? {};\nlet humanRec = null;\nlet aiRec = null;\n\n// Case 1: records array\nif (Array.isArray(inJson.records)) {\n  for (const r of inJson.records) {\n    const tag = toStr(r?.tag).toLowerCase();\n    if (tag === \"human\") humanRec = { ...r };\n    if (tag === \"ai\") aiRec = { ...r };\n  }\n}\n\n// Case 2: explicit human/ai objects\nif (!humanRec && inJson.human) {\n  humanRec = {\n    tag: \"human\",\n    content: inJson.human.content,\n    session_id: inJson.human.session_id ?? inJson.session_id\n  };\n}\nif (!aiRec && inJson.ai) {\n  aiRec = {\n    tag: \"ai\",\n    content: inJson.ai.content,\n    session_id: inJson.ai.session_id ?? inJson.session_id\n  };\n}\n\n// Case 3: separate fields\nif (!humanRec && (inJson.human_content || inJson.human_text)) {\n  humanRec = {\n    tag: \"human\",\n    content: inJson.human_content ?? inJson.human_text,\n    session_id: inJson.session_id\n  };\n}\nif (!aiRec && (inJson.ai_content || inJson.ai_text)) {\n  aiRec = {\n    tag: \"ai\",\n    content: inJson.ai_content ?? inJson.ai_text,\n    session_id: inJson.session_id\n  };\n}\n\n// Case 4: fallback\nif (!humanRec && !aiRec && inJson.tag && inJson.content) {\n  const tag = toStr(inJson.tag).toLowerCase();\n  if (tag === \"human\") humanRec = { tag: \"human\", content: inJson.content, session_id: inJson.session_id };\n  if (tag === \"ai\") aiRec = { tag: \"ai\", content: inJson.content, session_id: inJson.session_id };\n}\n\n// Session fallback\nconst sessionFallback = humanRec?.session_id ?? aiRec?.session_id ?? inJson.session_id ?? \"\";\nif (humanRec && !humanRec.session_id) humanRec.session_id = sessionFallback;\nif (aiRec && !aiRec.session_id) aiRec.session_id = sessionFallback;\n\n// ---------------- Build Output ----------------\nconst out = [];\nif (humanRec) out.push(buildRecord(humanRec));\nif (aiRec) out.push(buildRecord(aiRec));\n\nif (out.length === 0) {\n  throw new Error(\"No valid inputs found. Provide `records`, or human/ai objects, or content fields.\");\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -660,
        100
      ],
      "id": "3ff3e752-6459-47cc-9182-370b99c5545d",
      "name": "ChatHistory"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{\n  {\n  records: [\n    { tag: \"human\", content: $('Trigger').first().json.data.last_email.email_text, session_id: $('Trigger').first().json.data.thread.ThreadId + $('Trigger').first().json.data.Manager.user_id},\n    { tag: \"ai\", content: $json.output.response, session_id: $('Trigger').first().json.data.thread.ThreadId + $('Trigger').first().json.data.Manager.user_id},\n  ]\n  }\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -880,
        100
      ],
      "id": "cb82cb54-dad8-4ba7-84b3-0bfd19720cb8",
      "name": "Edit Fields5"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "public",
          "mode": "list",
          "cachedResultName": "public"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "session_id",
              "displayName": "session_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "message",
              "displayName": "message",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -440,
        100
      ],
      "id": "8dfbe4fe-0285-4726-8365-dbb06636b5d5",
      "name": "Postgres2",
      "retryOnFail": true,
      "maxTries": 2,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"required\": [\"response\", \"task_attempted\", \"next_task\"],\n  \"properties\": {\n    \"response\": {\n      \"type\": \"string\",\n      \"description\": \"A well structured response to the manager based on the tool executed. Strictly follow gmail-API friendly html formatting with propoer bullets, numbering etc.\",\n      \"minLength\": 1\n    },\n    \"task_attempted\": {\n      \"type\": \"object\",\n      \"required\": [\"task_name\", \"task_status\"],\n      \"properties\": {\n        \"task_name\": {\n          \"type\": \"string\",\n          \"description\": \"The name of the last task attempted by you on behalf of the manager.\",\n          \"enum\": [\"create_deal\", \"update_deal\", \"create_invoice\", \"update_invoice\", \"file_requested\"]\n        },\n        \"task_status\": {\n          \"type\": \"string\",\n          \"description\": \"Status of the last task.\",\n          \"enum\": [\"completed\", \"failed\"]\n        }\n      }\n    },\n    \"next_task\": {\n      \"type\": \"string\",\n      \"description\": \"Any next task proposed by you to the manager. Use 'no_action' if no task is recommended or the task_attempted failed.\",\n      \"enum\": [\"create_deal\", \"update_deal\", \"create_invoice\", \"update_invoice\", \"no_action\", \"send_file_to_user\", \"send_file_on_cc\", \"retry\"]\n    }\n  },\n  \"allOf\": [\n    {\n      \"if\": {\n        \"properties\": {\n          \"task_attempted\": {\n            \"properties\": {\n              \"task_status\": { \"const\": \"failed\" }\n            },\n            \"required\": [\"task_status\"]\n          }\n        }\n      },\n      \"then\": {\n        \"properties\": {\n          \"next_task\": { \"const\": \"no_action\" }\n        }\n      }\n    }\n  ]\n}\n"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -240,
        780
      ],
      "id": "eeddec9b-0024-464f-98fb-fc9b9ee810da",
      "name": "Parser"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserAutofixing",
      "typeVersion": 1,
      "position": [
        -500,
        540
      ],
      "id": "2937bbf5-c585-4293-b5d4-c74a194bb99f",
      "name": "AutoFix"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {
          "maxTokens": 2500,
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1460,
        780
      ],
      "id": "fd8f6dab-b74e-4ee1-a275-9cef84e285d9",
      "name": "Model",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "name": "InvoiceFileRequest",
        "description": "Call this tool when the user is requesting invoice file as pdf or other format. Forexample;\n- Share/send the invoice file to me.\n- I want the invoice as file etc.\n- Send the invoice file.\n- Send me the invoice.",
        "workflowId": {
          "__rl": true,
          "value": "WOYF6k52WBWh9f8A",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "ai_input": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ai_input', `A detailed description of the task to be performed by the worker agent for the Manager <Include manager>. This description must include all the details related to invoice such as recipient, amount, due date, emails and address extracted from all the provided context.`, 'string') }}",
            "action": "pdf_request",
            "data": "={{ \n{\nThreadId: $('Trigger').first().json.data.thread.ThreadId,\nuser_id: $('Trigger').first().json.data.user_id,\nmetadata: $('Trigger').first().json.data.metadata,\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -1100,
        420
      ],
      "id": "74511154-fd16-4bb9-8942-bfb39d256a28",
      "name": "Get Invoice File"
    },
    {
      "parameters": {
        "name": "SendFile",
        "description": "Call this tool when the user is requesting to send some file to recipient and provides recipient name and email address. For example;\n- Send the attached file to the recipient.",
        "workflowId": {
          "__rl": true,
          "value": "WOYF6k52WBWh9f8A",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "ai_input": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('ai_input', `A detailed description of the task to be performed by the worker agent for the Manager <Include manager>. This description must include all the details related to invoice such as recipient, amount, due date, emails and address extracted from all the provided context.`, 'string') }}",
            "action": "send_file",
            "data": "={{ \n{\nThreadId: $('Trigger').first().json.data.thread.ThreadId,\nuser_id: $('Trigger').first().json.data.user_id,\nmetadata: $('Trigger').first().json.data.metadata,\n\"recipient_name\": $fromAI(\"recipient_name\", \"Extract the recipeint name provided by the Manager to whom he/she wants to send the file.\", \"string\"),\n\"recipient_email\": $fromAI(\"recipient_email\", \"Extract the exact recipeint email provided by the Manager to whom he/she wants to send the file.\", \"string\")\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.1,
      "position": [
        -1240,
        420
      ],
      "id": "7c0002d9-1160-4e17-b0cf-8dd33b9968a5",
      "name": "SendFile"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Trigger').first().json.data.last_email.email_text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are the spcialized and intelligent Patchbay Actions Agent, to plan, call and execute the correct tools based on the provided context. You will recieve below informations;\n- User Message: A response to the 'last_action_recommended' from the user.\n- last_action_recommended: Last recommended action.\n- manager_details: Manager(User), who is responding.\n- metadata: Necessary metadata required by the tools. \n---\n\n## GOAL\nYour main goal is to;\n- Analyse the user message in response to the 'last_action_recommended'.\n- Decide the tool from below provide tools;\n  - CreateDeal: For creating the deals\n  - CreateInvoice: For creating invoices in patchbay system.\n  - UpdateDeal: Handle deal updations\n  - UpdateInvoice: Handle invoice updates.\n  - InvoiceFileRequest: Call this tool only when the user has requested the invoice as pdf/other file. Don't confuse this with CreateInvoice and UpdateInvoice.\n  - SendFile: Call this tool only when the user request to send the attached file to some recipient providing email and name. Don't confuse this with InvoiceFileRequest.\n- Identify the correct input required by the tool.\n-  Execute the tool and respond back to user based on the output from the tool.\n\n---\n\n## EXECUTION RULES:\n- If CreateDeal is called:\n  - Resond back to the user with input from tool called. set next_task as advised by the tool output.\n\n- If CreateInvoice is Called:\n  - Call tool(mentioned in response of previous tool) or response back to the user based on the tool response.\n\n- If UpdateDeal is called:\n  - Respond back to the user with what with the changes made based on tool response. set next_task as advised by the tool.\n\n- If UpdateInvoice is called:\n  - Respond back to the user with updated invoice changes and call tool advised in the tool response.\n\n- If InvoiceFileRequest is called:\n  - Respond back to the user mentioning the attached file for the invoice requested by id.\n\n### 2. TOOL EXECUTION RULES\n- Call the correct tool for the action type.\n- Wait for tool completion before responding.\n- Set the next_task based on the tool response.\n- If the tool is not called (unsupported or missing data), follow the “Unsupported/Missing Data” handling rules.\n---\n\n## RESPONSE STYLE RULES\n\n- Tone: Polite, concise, and approachable — no system jargon.\n- Clarity: Use short paragraphs and clear bullet points for key details.\n- Formatting:  \n  - `<p>` for paragraphs  \n  - `<ul>` or `<ol>` for bullet/numbered lists  \n  - `<strong>` for emphasis  \n  - Separate deal terms and invoice terms into distinct lists if both are mentioned.\n- **Politeness cues:** Use courteous phrases such as:\n  - “I’ve completed…”\n  - “Here’s what we’ve done…”\n  - “Please let me know if you’d like any adjustments.”\n- **Signature:** End with `<p>Patchbay Assistant</p>`.\n- **No technical talk:** Avoid tool names, API language, or schema terms in the response.\n---\n\n## UNSUPPORTED OR MISSING DATA\n- If action is unsupported or metadata is missing:\n  - Do not call the tool.\n  - Set `task_attempted.task_status` = `\"failed\"`, `next_task` = `\"no_action\"`.\n  - In `response`, politely explain the situation and ask for the exact missing info.\n---\n\n## OUTPUT FORMAT\nReturn a single JSON object matching this structure:\n```json\n{\n  \"response\": \"<body-only Gmail HTML>\",\n  \"task_attempted\": {\n    \"task_name\": \"create_invoice\",\n    \"task_status\": \"completed\"\n  },\n  \"next_task\": \"no_action\"\n}\n\n\nlast_action_recommended manager_details and the metadata needed for tools is provided below;\n\n- last_action_recommended: {{ $('Trigger').first().json.data.metadata.last_bot_response.removeTags() }}\n \n- manager_details: {{ JSON.stringify($('Trigger').first().json.data.Manager, null, ' ') }}\n\n- metadata: {{ JSON.stringify(\n  Object.fromEntries(\n    Object.entries($('Trigger').first().json.data.metadata).filter(([k]) => !['last_bot_response', 'routing_id', 'task_metadata'].includes(k))\n  ),\n  null,\n  ' '\n) }}\n\nFor your reference the prvious chat history is given below;\n\n{{ $json.history }}}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -1280,
        100
      ],
      "id": "84d91e14-25dc-4487-97f5-d49417421166",
      "name": "Action Executer"
    }
  ],
  "pinData": {
    "Trigger": [
      {
        "json": {
          "data": {
            "user_id": "2edfd81b-b1a1-4cb9-89b5-6c84b8bd6dc2",
            "thread": {
              "ThreadId": "199a43a3f62bd778",
              "Emails": "---------------\nFrom: Dwayne Hoover (dwayne@patchbay.xyz)\nTo: Patchbay Assistant (asst@patchbay.xyz)\nDate: Thu, Oct 2, 2025, 9:21 AM\nBody: Send me invoice  #0004   for my client quincy jones.\n\n---------------",
              "Subject": "Send Invoice",
              "Others": [],
              "Managers": [
                {
                  "name": "Dwayne Hoover",
                  "address": "dwayne@patchbay.xyz",
                  "user_id": "2edfd81b-b1a1-4cb9-89b5-6c84b8bd6dc2",
                  "person_number": "2752c92b-b570-4f0f-a082-611fe1770ec4",
                  "Role": "Manager",
                  "Clients": [
                    {
                      "person_name": "Quincy  Jones",
                      "performer_name": "quincy jones",
                      "status": "verified",
                      "book_number": "38930866-9e7a-424c-9492-bf9dd476bde6",
                      "book_id": "620",
                      "role": "",
                      "message": " Quincy  Jones is verified in the Manager's workspace. Inform the manager."
                    }
                  ]
                },
                {
                  "name": "Agent",
                  "address": "asst@patchbay.xyz",
                  "user_id": "9cd5749c-7e7d-4a92-98cd-c1356b626258",
                  "person_number": "03014402-449b-48bb-8973-212449e99e2f",
                  "Role": "Manager",
                  "Clients": []
                }
              ],
              "references": [
                "<CAP=u+8CjH6Ks7ZFqNLMacd-_uj+NwS_C=2JK1U0-w1EwMK5THw@mail.gmail.com>",
                "<CAEaeWjTPE=Qv0UwXWtz-nvrHo6tQqHS97uC2C86Rg7RsDFWXQg@mail.gmail.com>",
                "<CAP=u+8DfXCtziGS9f1NMq-ty3nGVLYgn5RehzmyVW07jC8KSGw@mail.gmail.com>",
                "<CAEaeWjSjp6Q4MX4A2CCzNz+qB9Os7smYW+nVJWV8F3QBQZQ3QA@mail.gmail.com>",
                "<CAP=u+8Cj8S5moS2Yns-_oc19je_m6ZeQwnb8TVRoz=uWHcppOQ@mail.gmail.com>",
                "<CAEaeWjRHJpbkLSfdy=K9tUDEAi89yVcv5b7Ak_RxbK80bhPyTw@mail.gmail.com>",
                "<CAP=u+8CN17v9KMxT65yCikTXhCNnX28rDTCiDzn_G3dKz=XpKA@mail.gmail.com>",
                "<CAEaeWjTqKQryQE=Dw3mzFUyT+oWbShebSjDrX6cFOz+NriR33w@mail.gmail.com>",
                "<CAP=u+8A3FFMYb9Kn_dQoa2Jhk6J955KQxOFNBOOU9PLeUVqNgQ@mail.gmail.com>",
                "<CAEaeWjTjn-_uhwr5MfjOKv_RZWi3MUhU4775Y7dVtYOsOejKqw@mail.gmail.com>",
                "<CAP=u+8C5sd59oN7NidY4jyLbY7afZjS4op7vJBhr-bFxNk-1eA@mail.gmail.com>",
                "<CAEaeWjRB-AiZixAHOh34pyxEyG1s8uv8FWkLLm3LS7aiWKMz9A@mail.gmail.com>"
              ],
              "Label": "CRUD-ASSISTANT",
              "sessionStatus": true
            },
            "last_email": "yes, please send it over here.",
            "Manager": {
              "name": "Dwayne Hoover",
              "address": "dwayne@patchbay.xyz",
              "user_id": "2edfd81b-b1a1-4cb9-89b5-6c84b8bd6dc2",
              "Clients": [
                {
                  "person_name": "Quincy  Jones",
                  "performer_name": "quincy jones",
                  "status": "verified",
                  "book_number": "38930866-9e7a-424c-9492-bf9dd476bde6",
                  "book_id": "620",
                  "role": "",
                  "message": " Quincy  Jones is verified in the Manager's workspace. Inform the manager."
                }
              ]
            },
            "metadata": {
              "type": "wf_deal_and_invoice",
              "thread_id": "199a43a3f62bd778",
              "Manager": {
                "name": "Dwayne Hoover",
                "address": "dwayne@patchbay.xyz",
                "user_id": "2edfd81b-b1a1-4cb9-89b5-6c84b8bd6dc2"
              },
              "person_verification": {
                "book_number": "38930866-9e7a-424c-9492-bf9dd476bde6",
                "book_id": "620",
                "person_legal_name": "Quincy  Jones",
                "person_performer_name": null,
                "person_role": "Producer",
                "message": "Person Verification Successful."
              },
              "task_metadata": {
                "deal_discussion": true,
                "deal_type": "Master",
                "deal_id": 4,
                "artist_name": "Quincy Jones",
                "masters": [
                  "Amazing Fellas"
                ],
                "deal_next_step": null
              },
              "deal_metadata": {
                "exists": false,
                "message": "New deal creation is pending."
              },
              "invoice_metadata": {
                "exists": true,
                "invoice_id": 4,
                "invoice_number": "8ac7c3a8-cb00-4cac-85fc-1439bf13d8e8",
                "message": "Invoice metadata added"
              },
              "routing_id": "<CAEaeWjRB-AiZixAHOh34pyxEyG1s8uv8FWkLLm3LS7aiWKMz9A@mail.gmail.com>",
              "last_bot_response": "<div style=\"font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:1.5;color:#111;max-width:680px;\">\n\n  <p>Here's the latest on your request for invoice #0004 for Producer Quincy Jones:</p>\n\n  <p><b>Invoice</b></p>\n  <ul><li>Invoice #0004 (ID: 4) for the master 'Amazing Fellas' is marked as <b>Paid</b>.</li><li>Amount: 100</li><li>Some metadata is incomplete (recipient and invoice date missing).</li></ul>\n\n  <p><b>Deal</b></p>\n  <ul><li>No formal deal record exists—referenced only via this invoice.</li><li>Key deal details (artist, fee, royalty terms) are missing.</li></ul>\n\n  <p>If you'd like to receive invoice #0004 as a file, please confirm and I'll send it right away. If you want to formalize the deal or update invoice details, let me know the missing info (artist, fee, royalty terms, or recipient).</p>\n\n  <hr style=\"margin-top:20px;border:none;border-top:1px solid #ddd;\">\n  <p style=\"margin-top:12px;\">Best,<br>Patchbay Assistant</p>\n</div>"
            }
          }
        }
      }
    ]
  },
  "repo_name": "hub-n8n",
  "repo_owner": "ck-bit",
  "repo_path": "",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-10-07T07:37:05.457Z",
  "versionId": "29c1b781-e4e5-4699-beea-bb860bf65664"
}