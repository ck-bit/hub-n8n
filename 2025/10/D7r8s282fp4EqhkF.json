{
  "active": false,
  "connections": {
    "Trigger": {
      "main": [
        [
          {
            "node": "User Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router1": {
      "main": [
        [
          {
            "node": "Deal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "InvoiceInputs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Verified",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze Person",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Not-Verified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Person": {
      "main": [
        [
          {
            "node": "Verified",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Not-Verified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verified": {
      "main": [
        [
          {
            "node": "Session2",
            "type": "main",
            "index": 0
          },
          {
            "node": "EmbedInvoiceClients",
            "type": "main",
            "index": 0
          },
          {
            "node": "Add clients1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Not-Verified": {
      "main": [
        [
          {
            "node": "Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Model": {
      "ai_languageModel": [
        [
          {
            "node": "Analyze Person",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Session2": {
      "main": [
        [
          {
            "node": "Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store": {
      "main": [
        [
          {
            "node": "Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "sub_session": {
      "main": [
        [
          {
            "node": "User Session1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If9": {
      "main": [
        [
          {
            "node": "sub_session",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "subsession",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "subsession": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Session": {
      "main": [
        [
          {
            "node": "If9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Session1": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Deal",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Fix",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fix": {
      "ai_outputParser": [
        [
          {
            "node": "Deal",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Fix",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Deal Search": {
      "main": [
        [
          {
            "node": "Session5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DSInput": {
      "main": [
        [
          {
            "node": "Deal Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "LastUpdated",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AiInput3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "InvoiceInputs",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Fix1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fix1": {
      "ai_outputParser": [
        [
          {
            "node": "InvoiceInputs",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "Fix1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Deal": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [],
        [
          {
            "node": "InvoiceInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Invoice Client3": {
      "main": [
        [
          {
            "node": "Session4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceInstructions": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Session4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Invoice Client3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceTerms": {
      "main": [
        [
          {
            "node": "Invoices",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "AiInput",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AiInput1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "New/Options3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store4": {
      "main": [
        [
          {
            "node": "InvoiceInstructions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session4": {
      "main": [
        [
          {
            "node": "Store4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceRecipient": {
      "main": [
        [
          {
            "node": "InvoiceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceInfo": {
      "main": [
        [
          {
            "node": "Invoice Lookup inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Invoice Lookup inputs": {
      "main": [
        [
          {
            "node": "InvoiceCheck",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceCheck": {
      "main": [
        [
          {
            "node": "GuidedResponses",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WPS-Upd-14": {
      "main": [
        [
          {
            "node": "FormatSessionData22",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FormatSessionData22": {
      "main": [
        [
          {
            "node": "UpdateSesssion17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GuidedResponses": {
      "main": [
        [
          {
            "node": "Session11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceRecipient1": {
      "main": [
        [
          {
            "node": "Session8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "InvoiceRecipient",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "InvoiceRecipient1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "WPS-Upd-14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceInput": {
      "main": [
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session8": {
      "main": [
        [
          {
            "node": "Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch5": {
      "main": [
        [
          {
            "node": "AiInput5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AiInput6",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "New/Options4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AiInput": {
      "main": [
        [
          {
            "node": "Analyse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AiInput1": {
      "main": [
        [
          {
            "node": "Analyse1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyse": {
      "main": [
        [
          {
            "node": "New/Options",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyse1": {
      "main": [
        [
          {
            "node": "New/Options",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AiInput2": {
      "main": [
        [
          {
            "node": "Analyse2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyse2": {
      "main": [
        [
          {
            "node": "Edit Fields3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AiInput3": {
      "main": [
        [
          {
            "node": "Analyse3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyse3": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "AiInput4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AiInput4": {
      "main": [
        [
          {
            "node": "Analyse4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AiInput5": {
      "main": [
        [
          {
            "node": "Analyse5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyse5": {
      "main": [
        [
          {
            "node": "New/Options6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AiInput6": {
      "main": [
        [
          {
            "node": "Analyse6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyse6": {
      "main": [
        [
          {
            "node": "New/Options6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session11": {
      "main": [
        [
          {
            "node": "Store10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store10": {
      "main": [
        [
          {
            "node": "Switch5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session5": {
      "main": [
        [
          {
            "node": "Store7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store7": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input": {
      "main": [
        [
          {
            "node": "Router1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store1": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "InvoiceTerms",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "New/Options5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EmbedDeals": {
      "main": [
        [
          {
            "node": "DSInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LastUpdated": {
      "main": [
        [
          {
            "node": "AiInput2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "InvoiceTerms1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceTerms1": {
      "main": [
        [
          {
            "node": "Invoices",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Invoices": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "InvoiceInputs": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "EmbedDeals",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-10T05:31:26.548Z",
  "id": "D7r8s282fp4EqhkF",
  "meta": null,
  "name": "DealInvoiceTools",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "action"
            },
            {
              "name": "data"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -2420,
        1560
      ],
      "id": "f341a0a9-2bca-4e9d-b2b3-b8bdc0ba6b70",
      "name": "Trigger"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "deal_search",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "2ce840f8-7860-4ee8-ae9a-775600317e28"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "deal_search"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "invoice_search",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3df951g9-8971-5ff9-bf0b-886711428f39"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "invoice_search"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "client_search",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4eg062h0-9082-6gg0-cg1c-997822539g40"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "client_search"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1000,
        1540
      ],
      "id": "9f3c8c52-101a-4a20-aa6a-8e4970b55ad0",
      "name": "Router1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  bw.number AS book_number,\n  bw.id AS book_id,\n  pp.name AS person_legal_name,\n  pp.performer_name AS person_performer_name,\n  ROUND(\n    (GREATEST(similarity(pp.name, $2), similarity(pp.performer_name, $2)) * 100.0)::numeric, \n    2\n  ) AS confidence_score\nFROM \n  hub_user_hubuser hu\nJOIN hub_user_manager hm \n  ON hm.user_id = hu.id AND hm.deleted_at IS NULL\nJOIN books_bookofwork bw \n  ON bw.id = hm.book_id AND bw.deleted_at IS NULL\nJOIN person_person p \n  ON p.id = bw.person_id AND p.deleted_at IS NULL\nJOIN person_personproperties pp \n  ON pp.id = p.current_properties_id AND pp.deleted_at IS NULL\nWHERE \n  hu.number = $1\nORDER BY \n  GREATEST(similarity(pp.name, $2), similarity(pp.performer_name, $3)) DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ $json.sub_session.Manager.user_id }},\n{{ ($json.session.person_legal_name && $json.session.person_legal_name.trim() !== '') ? $json.session.person_legal_name : $json.session.person_performer_name }}\n, {{ ($json.session.person_performer_name && $json.session.person_performer_name.trim() !== '') ? $json.session.person_performer_name : $json.session.person_legal_name }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -420,
        2980
      ],
      "id": "a102da1c-43ab-4a52-ac1e-ec6ac44ddc4f",
      "name": "Postgres",
      "alwaysOutputData": true,
      "retryOnFail": true,
      "executeOnce": false,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "let input;\ntry {\n  input = $('Verified').first().json;\n} catch {\n  input = $('Not-Verified').first().json;\n}\nsub_session = $input.first().json\n\n// Remove specific keys\nconst { routing_id, last_bot_response, ...filtered } = sub_session;\nsub_session = filtered;\n\n// Handle both single object and array\nconst data = Array.isArray(input) ? input : [input];\nconst responses = data.map(item => {\n  const {\n    person_legal_name,\n    person_performer_name,\n    book_number,\n    book_id,\n    verification_status\n  } = item;\n  // Helper function to check if value exists and is not empty\n  const hasValue = (value) => value && value !== null && value.toString().trim() !== '';\n  // Start building the response\n  let response = '';\n  \n  if (verification_status === true) {\n    // Verified case\n    if (hasValue(person_legal_name)) {\n      response = `The ${person_legal_name}`;\n      \n      // Add performer name if it exists and is different from legal name\n      if (hasValue(person_performer_name) && person_performer_name !== person_legal_name) {\n        response += ` also referred to as ${person_performer_name}`;\n      }\n      \n      response += ' is verified in the Manager\\'s workspace.';\n      \n      // Add verification details\n      let details = [];\n      details.push(`Legal Name: ${person_legal_name}`);\n      \n      if (hasValue(person_performer_name)) {\n        details.push(`Performer Name: ${person_performer_name}`);\n      }\n      \n      if (hasValue(book_number)) {\n        details.push(`book_number: ${book_number}`);\n      }\n      \n      if (hasValue(book_id)) {\n        details.push(`book_id: ${book_id}`);\n      }\n      \n      details.push(`Verification Status: verified`);\n      \n      response += '\\n\\nDetails:\\n' + details.join('\\n');\n    } else {\n      response = 'Person is verified in the Manager\\'s workspace but no legal name provided.';\n    }\n  } else {\n    // Not verified case\n    if (hasValue(person_legal_name)) {\n      response = `The ${person_legal_name}`;\n      \n      if (hasValue(person_performer_name) && person_performer_name !== person_legal_name) {\n        response += ` also referred to as ${person_performer_name}`;\n      }\n      \n      response += ' is not verified in the Manager\\'s workspace.';\n      \n      // Add basic details (excluding book_number and book_id for unverified)\n      let details = [];\n      details.push(`Legal Name: ${person_legal_name}`);\n      \n      if (hasValue(person_performer_name)) {\n        details.push(`Performer Name: ${person_performer_name}`);\n      }\n      \n      details.push(`Verification Status: not_verified`);\n      \n      response += '\\n\\nDetails:\\n' + details.join('\\n');\n    } else {\n      response = 'Person is not verified and no legal name provided.';\n    }\n  }\n  \n  return response;\n});\n// Return the formatted responses\nreturn responses.map(response => ({ json: { message: response, metdata: sub_session} }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1160,
        3160
      ],
      "id": "249ecd5b-ee6c-4b14-9b7e-ebd529dec8cc",
      "name": "Response"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.isNotEmpty() && $json.confidence_score.toNumber()>=90 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "04d860ea-9c1f-4346-86cf-128b2f90128e"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1903d193-626b-44b2-b3d9-ee5ce0a7d1ca",
                    "leftValue": "={{ $json.isNotEmpty() && ($json.confidence_score.toNumber() >= 25 && $json.confidence_score.toNumber() < 90) }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ca5f3fee-aac7-44c0-9907-adb4a93ae4f7",
                    "leftValue": "={{ $json.isEmpty() || $json.confidence_score.toNumber()<25 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -80,
        2980
      ],
      "id": "8b7b3456-a930-49cf-9942-793d58acf111",
      "name": "Switch1"
    },
    {
      "parameters": {
        "inputText": "=input-1: {{ \n  (() => {\n    let result = [];\n    \n    if ($json.person_legal_name && $json.person_legal_name !== null && $json.person_legal_name.trim() !== '') {\n      result.push(`Legal Name: ${$json.person_legal_name}`);\n    }\n    \n    if ($json.person_performer_name && $json.person_performer_name !== null && $json.person_performer_name.trim() !== '') {\n      result.push(`Performer Name: ${$json.person_performer_name}`);\n    }\n    \n    return result.join(', ');\n  })()\n}}\n\nInput: {{ \n  (() => {\n    let result = [];\n    \n    if ($('Trigger').first().json.data.person_legal_name && $json.person_legal_name !== null && $json.person_legal_name.trim() !== '') {\n      result.push(`Legal Name: ${$json.person_legal_name}`);\n    }\n    \n    if ($json.person_performer_name && $json.person_performer_name !== null && $json.person_performer_name.trim() !== '') {\n      result.push(`Performer Name: ${$json.person_performer_name}`);\n    }\n    \n    return result.join(', ');\n  })()\n}}",
        "categories": {
          "categories": [
            {
              "category": "verified",
              "description": "=When comparing Input-1 and Input-2, if the Legal Name and/or Performer Name are the same (even if not exactly identical, e.g., due to spelling variations, abbreviations, or common aliases) and you reasonably determine they refer to the same individual, then classify the result as Verified."
            },
            {
              "category": "Not Verified",
              "description": "=When comparing Input-1 and Input-2, if the Legal Name and Performer Name do not sufficiently match, or there is not enough evidence to reasonably conclude that they refer to the same individual, then classify the result as Not Verified. This includes cases where the names are distinctly different, unrelated, or ambiguous enough that verification cannot be confidently made."
            }
          ]
        },
        "options": {
          "enableAutoFixing": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.textClassifier",
      "typeVersion": 1,
      "position": [
        140,
        2980
      ],
      "id": "2bb8aeac-cf35-4ae1-8853-50f1f7c2d40e",
      "name": "Analyze Person",
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3db57f33-586e-4ec5-9fc8-af302a21d8c9",
              "name": "verification_status",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        520,
        2800
      ],
      "id": "03689942-b92e-4a5f-b4d2-d446db349faa",
      "name": "Verified"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3db57f33-586e-4ec5-9fc8-af302a21d8c9",
              "name": "verification_status",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "9b0867ad-f95d-44d0-8a49-d7ef5febfde2",
              "name": "person_legal_name",
              "value": "={{ $('Trigger').item.json.data.person_legal_name }}",
              "type": "string"
            },
            {
              "id": "aada2520-0157-4e3b-b792-4dc5d7807419",
              "name": "person_performer_name",
              "value": "={{ $('Trigger').item.json.data.person_performer_name }}",
              "type": "string"
            },
            {
              "id": "b39b4ef6-d1b0-4b90-ba73-8e292b38e036",
              "name": "person_role",
              "value": "={{ $('Trigger').item.json.data.person_role }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        520,
        3180
      ],
      "id": "b6e72472-d60d-4167-90bf-3981aa858ed8",
      "name": "Not-Verified"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        240,
        3200
      ],
      "id": "f3460bf8-6c56-41f6-a828-9849a1cafb0d",
      "name": "Model",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Input').first().json.sub_session;\nif (!prev) {\n  throw new Error(\"Missing sub_session\");\n}\n\nconst person_new = $input.first().json;\nconst message = \"Person Verification Successful.\";\n\nconst { confidence_score, verification_status, ...personDataOnly } = person_new ?? {};\npersonDataOnly.person_role = $('Trigger').first().json.data.person_role\nreturn [\n  {\n    json: {\n      ...prev,\n      person_verification: {\n        ...personDataOnly,\n        message: message\n      }\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        740,
        3020
      ],
      "id": "68136d65-7e1e-4d66-b423-c34aa28476ca",
      "name": "Session2"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $json.thread_id+ $json.Manager.user_id}}",
        "value": "={{ $json.toJsonString() }}",
        "keyType": "string",
        "expire": true,
        "ttl": "={{ 60 * 60 * 24 * 30 }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        960,
        3020
      ],
      "id": "b530c594-7224-49b6-b184-c3dbc67b9c60",
      "name": "Store",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const { Clients, ...managerWithoutClients } = $('Trigger').first().json.data.Manager;\n\nreturn [\n  {\n    json: {\n      sub_session: {\n        type: \"wf_deal_and_invoice\",\n        thread_id: $('Trigger').first().json.data.session_data.ThreadId,\n        Manager: managerWithoutClients\n      },\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1760,
        1540
      ],
      "id": "08f35bc3-3145-4184-a13b-4c22f7917b43",
      "name": "sub_session"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "eaaa7599-aec4-4ecb-88ec-e91e4dd291c7",
              "leftValue": "={{ $json.user_session===null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1980,
        1560
      ],
      "id": "e298ca06-a34e-45c2-8f2d-689de148897a",
      "name": "If9"
    },
    {
      "parameters": {
        "jsCode": "// Parse user_session for the current item\nconst userSessionString = $input.item.json.user_session;\nconst userSession = JSON.parse(userSessionString);\n\nreturn {sub_session: userSession};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1620,
        1720
      ],
      "id": "0d30701f-254e-4267-b3c0-b78f0ff779bd",
      "name": "subsession"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "user_session",
        "key": "=user_session_{{ $json.data.session_data.ThreadId+$json.data.user_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2200,
        1560
      ],
      "id": "4dd3ce59-e049-457d-88ab-000ced5f3f90",
      "name": "User Session",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $json.sub_session.thread_id+$json.sub_session.Manager.user_id }}",
        "value": "={{ $json.sub_session.toJsonString() }}",
        "keyType": "string"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -1460,
        1540
      ],
      "id": "ab7ffb9b-2709-4ce0-bdaa-753647f0a7e8",
      "name": "User Session1",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -560,
        820
      ],
      "id": "41e62c8a-3313-40c0-90db-43aaa457eb3d",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserAutofixing",
      "typeVersion": 1,
      "position": [
        -340,
        600
      ],
      "id": "cbb4f591-37ca-4e84-9985-9dddedfd37e9",
      "name": "Fix"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"title\": \"Deal Requirements Extraction Schema\",\n  \"description\": \"Structured output for deal classification and requirements extraction in entertainment industry agreements.\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"deal_discussion\": {\n      \"type\": \"boolean\",\n      \"description\": \"True if any recognized deal type is found (not Unrecognized). False only for Unrecognized type.\"\n    },\n    \"deal_type\": {\n      \"type\": \"string\",\n      \"description\": \"Most specific applicable deal classification based on decision tree order.\",\n      \"enum\": [\n        \"Record\",\n        \"Master\",\n        \"Simple Royalty\",\n        \"Live Performance\",\n        \"Sync License\",\n        \"Publishing\",\n        \"Neighboring Rights\",\n        \"Unrecognized\"\n      ]\n    },\n    \"deal_id\": {\n      \"type\": [\"integer\", \"null\"],\n      \"description\": \"Numerical deal ID if explicitly referenced by user (e.g., 'Deal #12345' â†’ 12345). Null if searching by client/masters or no explicit ID.\",\n      \"minimum\": 1\n    },\n    \"artist_name\": {\n      \"description\": \"Name of the musical entity/brand for releases (solo artist, band, group). Can be same as person_name if individual uses their name as artist brand. Null if not found.\",\n      \"anyOf\": [\n        {\n          \"type\": \"null\"\n        },\n        {\n          \"type\": \"string\",\n          \"minLength\": 1,\n          \"pattern\": \"^[^\\\\n\\\\r]+$\"\n        }\n      ]\n    },\n    \"masters\": {\n      \"description\": \"Array of exact master recording titles without additional text or descriptions. Null if no specific masters mentioned.\",\n      \"anyOf\": [\n        {\n          \"type\": \"null\"\n        },\n        {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"string\",\n            \"minLength\": 1,\n            \"pattern\": \"^[^\\\\n\\\\r]+$\",\n            \"description\": \"Exact master recording title\"\n          },\n          \"minItems\": 1,\n          \"uniqueItems\": true\n        }\n      ]\n    },\n    \"deal_next_step\":{\n      \"type\": [\"string\", null],\n      \"description\": \"Set to 'create_new'  if the user rejects other deal options and wants to create a new deal. Don confuse it for invoice and consult the conversation history before you decide. Otherwise null in all conditions.\",\n      \"enum\": [\"create_new\", null]\n    },\n    \"thread_last_updated\": {\n\t\t\t\"type\": [\"datetime\", null],\n            \"description\": \"Extract the Exact latest date(ISO) from the 'Email Conversation' usually assigned to the last email(from any party) where 'asst@patchbay.xyz' is not mentioned in (From, To) sections. If the condition does not satify, set to null\"\n\t\t}\n  },\n  \"required\": [\n    \"deal_type\",\n    \"deal_discussion\",\n    \"artist_name\",\n    \"masters\",\n    \"deal_id\"\n  ],\n  \"additionalProperties\": false,\n  \"allOf\": [\n    {\n      \"if\": {\n        \"properties\": {\n          \"deal_type\": {\n            \"const\": \"Unrecognized\"\n          }\n        },\n        \"required\": [\"deal_type\"]\n      },\n      \"then\": {\n        \"properties\": {\n          \"deal_discussion\": {\n            \"const\": false,\n            \"description\": \"Must be false when deal_type is Unrecognized\"\n          },\n          \"artist_name\": {\n            \"type\": \"null\",\n            \"description\": \"Must be null when deal_type is Unrecognized\"\n          },\n          \"masters\": {\n            \"type\": \"null\",\n            \"description\": \"Must be null when deal_type is Unrecognized\"\n          }\n        }\n      },\n      \"else\": {\n        \"properties\": {\n          \"deal_discussion\": {\n            \"const\": true,\n            \"description\": \"Must be true when deal_type is any recognized type\"\n          }\n        }\n      }\n    }\n  ],\n  \"examples\": [\n    {\n      \"deal_discussion\": true,\n      \"deal_type\": \"Master\",\n      \"deal_id\": null,\n      \"artist_name\": \"Bella Poarch\",\n      \"masters\": [\"Build a Bitch\", \"Inferno\"]\n    },\n    {\n      \"deal_discussion\": false,\n      \"deal_type\": \"Unrecognized\",\n      \"deal_id\": null,\n      \"artist_name\": null,\n      \"masters\": null,\n      \"deal_next_step\": null\n    },\n    {\n      \"deal_discussion\": true,\n      \"deal_type\": \"Record\",\n      \"deal_id\": 12345,\n      \"artist_name\": \"The Weeknd\",\n      \"masters\": null\n    }\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -400,
        820
      ],
      "id": "d8b8f28f-35ee-4265-a183-131b9a0b67dd",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "J9qD5mmAG74Azgol",
          "mode": "list",
          "cachedResultName": "deal_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "search",
            "data": "={{ $json.sub_session }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        960,
        380
      ],
      "id": "1d406d49-f741-444b-a760-75f88f655a36",
      "name": "Deal Search",
      "alwaysOutputData": true,
      "executeOnce": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1f71ded-7340-44b0-92af-247ea3a09222",
              "name": "sub_session",
              "value": "={{ $('subsession').first().json.sub_session }}",
              "type": "object"
            },
            {
              "id": "aede48a0-d68c-41e3-ac8a-f5663010bb33",
              "name": "sub_session.task_metadata",
              "value": "={{ $('Deal').first().json.output }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        720,
        380
      ],
      "id": "a0eb2b47-4c4e-4a88-bee6-1f63cf3a1039",
      "name": "DSInput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Deal Search').first().json.next_route === 'update'  }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "333f6206-18c1-4317-94f5-ea11cf01dadd"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1cb4dd84-753e-4d08-b41b-72d291211b0f",
                    "leftValue": "={{ $('Deal Search').first().json.next_route === 'no_action' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "756a8c57-4314-4d56-a80c-c98c286d71d0",
                    "leftValue": "={{ $('Deal Search').first().json.next_route === 'confirm' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bee1f315-5478-4b21-a5cb-fc3acdf75dbc",
                    "leftValue": "={{ $('Deal Search').first().json.next_route === 'create_new' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1820,
        360
      ],
      "id": "6d6dc8b4-30f6-4090-8888-536b9c400c88",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "af745b92-bb83-45a7-9124-df6d91f5e3e5",
              "name": "deal_search_findings",
              "value": "={{ $('Deal Search').first().json.deal_search_output }}",
              "type": "string"
            },
            {
              "id": "782510b1-c551-490b-ad4f-97e568a0ff39",
              "name": "deal_next_step",
              "value": "no_action",
              "type": "string"
            },
            {
              "id": "9dd44f84-c991-4c0e-8d11-8e24f1f5cd2d",
              "name": "next_tool_instructions",
              "value": "Call tool:invoice_search next and compile teh findings.",
              "type": "string"
            },
            {
              "id": "216d8935-b853-4b8b-9153-61e0d6076853",
              "name": "metadata",
              "value": "={{ $('Store7').first().json }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2340,
        120
      ],
      "id": "ca990b15-47d1-42d8-afcb-ce1b93533df3",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "af745b92-bb83-45a7-9124-df6d91f5e3e5",
              "name": "deal_search_findings",
              "value": "={{ $('Deal Search').first().json.deal_search_output }}",
              "type": "string"
            },
            {
              "id": "782510b1-c551-490b-ad4f-97e568a0ff39",
              "name": "deal_next_step",
              "value": "await_confirmation",
              "type": "string"
            },
            {
              "id": "dffd6305-0106-4341-bae4-dbd8b9042194",
              "name": "next_tool_instructions",
              "value": "=Stop here and don't call the invoice_search tool as the deal confirmation is needed from the provided list.",
              "type": "string"
            },
            {
              "id": "e9557ebd-d67a-4281-a861-4975bd36bd36",
              "name": "metadata",
              "value": "={{ $('Store7').first().json }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2320,
        380
      ],
      "id": "a80e4c14-2168-41c3-bcb0-f97731c8ae31",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "responseFormat": "json_object",
          "temperature": 0
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -540,
        2040
      ],
      "id": "8e2d6364-1563-45fe-b88e-9ccb32fc06de",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "mxdHDElSd4VQZiDt",
          "name": "OpenAi account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserAutofixing",
      "typeVersion": 1,
      "position": [
        -540,
        1840
      ],
      "id": "be42c40f-4fdd-4f4e-840d-2e13a4ae2ecd",
      "name": "Fix1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"title\": \"Invoice Detection and Extraction Schema\",\n  \"description\": \"Structured output for invoice request detection in entertainment industry communications\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"invoice\": {\n      \"type\": \"object\",\n      \"description\": \"Invoice request detection and details\",\n      \"properties\": {\n        \"request_status\": {\n          \"type\": \"boolean\",\n          \"description\": \"True only for actionable invoice requests (creation, lookup, payment processing). False for historical discussions or non-actionable mentions.\"\n        },\n        \"request_type\": {\n          \"type\": [\"string\", \"null\"],\n          \"description\": \"Classification of invoice request. Must be non-null when request_status is true.\",\n          \"enum\": [\"remittance_payment\", \"general\", null]\n        },\n        \"next_step\": {\n          \"type\": [\"string\", \"null\"],\n          \"description\": \"ONLY evaluate if conversation_history contains previous invoice recommendations. 'request_as_file' ONLY if last_email contains ONLY file/PDF request with no other content. 'create_new' ONLY if conversation_history shows system offered invoice options AND last_email explicitly rejects ALL of them. Otherwise null (including when no previous recommendations exist).\",\n          \"enum\": [\"create_new\", \"request_as_file\", null]\n        },\n        \"recipient\": {\n          \"type\": [\"string\", \"null\"],\n          \"description\": \"Entity responsible for payment (label, company, venue). Cannot be a person name, artist name, or master name. Null if not identifiable.\",\n          \"minLength\": 1,\n          \"pattern\": \"^[^\\\\n\\\\r]+$\"\n        },\n        \"amount\": {\n          \"type\": [\"number\", \"null\"],\n          \"description\": \"Exact payment amount from most recent discussion. Null if not specified.\",\n          \"minimum\": 0,\n          \"exclusiveMinimum\": false\n        },\n        \"currency\": {\n          \"type\": [\"string\", \"null\"],\n          \"description\": \"ISO 4217 currency code. Defaults to 'USD' if amount exists without specified currency. Null only if no amount.\",\n          \"pattern\": \"^[A-Z]{3}$\"\n        },\n        \"invoice_id\": {\n          \"type\": [\"string\", \"null\"],\n          \"description\": \"Invoice identifier extracted as digits only (e.g., 'INV-00123' becomes '123'). Null if not found.\",\n          \"pattern\": \"^[0-9]+$\"\n        },\n        \"deal_discussion\": {\n          \"type\": [\"boolean\"],\n          \"description\": \"Set to false when there is no deal being discussed in the conversation or the user has not linked the invoice to any deal. Means Email thread is all about invoice and invoice only. Otherwise true\"\n        }\n      },\n      \"required\": [\"request_status\", \"request_type\", \"next_step\", \"recipient\", \"amount\", \"currency\", \"invoice_id\"],\n      \"additionalProperties\": false,\n      \"allOf\": [\n        {\n          \"if\": {\n            \"properties\": {\n              \"request_status\": {\n                \"const\": true\n              }\n            },\n            \"required\": [\"request_status\"]\n          },\n          \"then\": {\n            \"properties\": {\n              \"request_type\": {\n                \"type\": \"string\",\n                \"enum\": [\"remittance_payment\", \"general\"],\n                \"description\": \"Must be non-null string when request_status is true\"\n              }\n            },\n            \"required\": [\"request_type\"]\n          },\n          \"else\": {\n            \"properties\": {\n              \"request_type\": {\n                \"const\": null,\n                \"description\": \"Must be null when request_status is false\"\n              },\n              \"next_step\": {\n                \"const\": null,\n                \"description\": \"Must be null when request_status is false\"\n              },\n              \"recipient\": {\n                \"const\": null,\n                \"description\": \"Must be null when request_status is false\"\n              },\n              \"amount\": {\n                \"const\": null,\n                \"description\": \"Must be null when request_status is false\"\n              },\n              \"currency\": {\n                \"const\": null,\n                \"description\": \"Must be null when request_status is false\"\n              },\n              \"invoice_id\": {\n                \"const\": null,\n                \"description\": \"Must be null when request_status is false\"\n              }\n            }\n          }\n        },\n        {\n          \"if\": {\n            \"properties\": {\n              \"amount\": {\n                \"type\": \"number\"\n              }\n            },\n            \"required\": [\"amount\"]\n          },\n          \"then\": {\n            \"properties\": {\n              \"currency\": {\n                \"type\": \"string\",\n                \"pattern\": \"^[A-Z]{3}$\",\n                \"description\": \"Must be a valid ISO 4217 code when amount is specified\"\n              }\n            }\n          }\n        }\n      ]\n    }\n  },\n  \"required\": [\"invoice\"],\n  \"additionalProperties\": false,\n  \"examples\": [\n    {\n      \"invoice\": {\n        \"request_status\": true,\n        \"request_type\": \"general\",\n        \"next_step\": null,\n        \"recipient\": \"Atlantic Records\",\n        \"amount\": 5000,\n        \"currency\": \"USD\",\n        \"invoice_id\": \"123\"\n      }\n    },\n    {\n      \"invoice\": {\n        \"request_status\": false,\n        \"request_type\": null,\n        \"next_step\": null,\n        \"recipient\": null,\n        \"amount\": null,\n        \"currency\": null,\n        \"invoice_id\": null\n      }\n    },\n    {\n      \"invoice\": {\n        \"request_status\": true,\n        \"request_type\": \"remittance_payment\",\n        \"next_step\": null,\n        \"recipient\": \"Sony Music\",\n        \"amount\": 2500.50,\n        \"currency\": \"EUR\",\n        \"invoice_id\": null\n      }\n    }\n  ]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        -380,
        2040
      ],
      "id": "d2abf6bc-356c-4576-8833-e945ec05782b",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyse the below recent email, previous discussion on the deal an details from document(If provided) to decide the correct classify and extract the data in a welll structured format according to the provided schema.;\n\nLatest Email: {{ $json.session.last_email }}\n\nEmail Thread: {{\n`Subject: ${$json.session.session_data.Subject}\\n, Emails: ${$json.session.session_data.Emails}`\n}}\n\nDeal Document: {{ $json.session.session_data.last_attachment?.document || 'Not Provided' }}\n\nManager's Metadata: {{ JSON.stringify($json.sub_session.Manager, null, ' ') }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are an expert contract classifier for entertainment industry deal agreements.\n\nOBJECTIVE:\nClassify deal types and extract deal requirements from entertainment industry communications and documents. Output normalized JSON following the provided schema.\n\nCRITICAL RULES:\n- Never hallucinate or guess values - use null for missing data\n- Follow the deal classification decision tree sequentially\n- Use data priority when conflicts exist\n\n---\n\nDEFINITIONS:\n\nArtist: Musical entity or brand name for releases (solo artist, band, group)\n- Examples: The Beatles, Daft Punk, Bella Poarch\n- Can be same as individual's name if they use it as their brand\n\nMasters: Specific sound recording titles by the artist and produced by the Client. Look for the subject where master is usually mentioned along client(producer/mixer) and artist.\n- Examples: \"Build a Bitch\", \"Blinding Lights\", \"Levitating\", \"4 THE SOUL\"\n- Must be exact titles without additional descriptions\n\nData Priority (when conflicts exist):\n1. Latest Email (highest): The most recent email from the user\n2. Thread: Completed email thread with discussed terms\n3. Deal Document (optional): Attached deal documentation\n\n---\n\nDEAL CLASSIFICATION DECISION TREE:\n\nApply in order - stop at first match:\n\n1. **Master Deal**\n   - Keywords: master recording, sound recordings, work_for_hire, recoupable, advance, PPD\n   - Involves: Creation/ownership of recordings with producer/mixer credits\n   - Trigger: Customer + artist + master present\n\n2. **Record Deal**\n   - Keywords: recording contract, label agreement, distribution, royalty splits\n   - Involves: Artist signing with label for recording rights\n\n3. **Sync License**\n   - Keywords: synchronization, sync rights, visual media, film/TV/ad\n   - Payment: Typically flat sync fee\n\n4. **Publishing Deal**\n   - Keywords: composition, publishing rights, mechanical royalties\n   - Types: Publisher, Administrator, Co-Publisher, Sub-Publisher\n\n5. **Simple Royalty**\n   - Keywords: commission, representation, management percentage\n   - Only commission arrangements, no other rights involved\n\n6. **Live Performance**\n   - Keywords: performance fee, venue, show date, technical rider\n\n7. **Neighboring Rights**\n   - Keywords: performer rights, societies, territories, repertoire\n\n8. **Unrecognized**\n   - None of the above patterns match\n\n---\n\nFIELD EXTRACTION RULES:\n\n**deal_discussion:**\n- true: If any recognized deal type (not Unrecognized)\n- false: Only if Unrecognized\n\n**deal_type:**\n- Select most specific applicable type from decision tree\n\n**artist_name:**\n- Name of the performing/releasing entity\n- null if not found or Unrecognized type\n\n**masters:**\n- Array of exact recording titles only\n- No descriptions or additional text\n- null if not mentioned or Unrecognized type\n\n**deal_id:**\n- Extract only if explicitly referenced (e.g., \"Deal #12345\" â†’ 12345)\n- null if searching by client/masters or no explicit ID\n\n**deal_next_step:**\nPriority evaluation order(Always decided on Latest Email):\n1. **create_new**: If conversation_history shows system offered deal options AND 'Latest Email' explicitly rejects ALL those options\n2. **null**: All other cases (default)\n\n---\n\nCONVERSATION HISTORY:\nUse provided history to identify:\n- Previously discussed deal terms\n- System recommendations or options presented\n- User responses, rejections, or modifications\n\nConversation History: {{ $('Trigger').item.json.data.history }}\n\n---\n\nVALIDATION CHECKLIST:\n1. Deal type matches most specific category from decision tree\n2. artist_name and masters are null when deal_type is Unrecognized\n3. deal_discussion is false only for Unrecognized type\n4. No hallucinated values - use null when data is missing\n5. deal_next_step evaluated correctly based on conversation context"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -540,
        400
      ],
      "id": "deabca14-da5d-47f3-bcc0-c94b86e2aedc",
      "name": "Deal",
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d134d2ee-c3f5-4443-90bb-2e9f8593f5e3",
              "leftValue": "={{ !!$('Input').first()?.json?.sub_session?.deal_metadata && $json.output.invoice.deal_discussion}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -200,
        1600
      ],
      "id": "e3b17df6-b6ab-407a-bf19-18d33cb8cdff",
      "name": "If"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "2pP2wYbGL3fjaJ0y",
          "mode": "list",
          "cachedResultName": "InvoiceCustomer-V-1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "retrieve",
            "data": "={{  \n{\n  \"invoice_recipient\": String($('InvoiceInputs').first().json.output.invoice.recipient || \"\"),\n  \"threshold\": 0.05,\n  \"book_number\": $('Input').first().json.sub_session.person_verification.book_number\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        940,
        1300
      ],
      "id": "d2fcea56-7502-4aab-949c-121e6afe20d1",
      "name": "Invoice Client3"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node - Multi-Invoice Analysis Prompt Generator\nfunction generateAnalysisPrompt(invoiceMetadataList, invoiceTermsList = [], dealStage = null, next_step = null) {\n  // Extract invoice_recipient from the first metadata item (assuming same recipient for all invoices in a deal)\n  const recipient = invoiceMetadataList[0]?.invoice_recipient || {};\n  \n  // PRIORITY 1: Check if next_step is 'create_new' - this overrides all other conditions\n  if (next_step === 'create_new') {\n    let recipientInstructions = getRecipientInstructions(recipient);\n    \n    // If there are existing invoices, show them for context\n    const existingInvoicesSection = invoiceTermsList.length > 0 \n      ? `\\nEXISTING INVOICES FOR THIS DEAL:\\n${formatInvoicesList(invoiceTermsList)}\\n`\n      : '';\n    \n    return {\n      promptInstructions: `\nA new invoice creation/drafting is requested for this deal.\n${existingInvoicesSection}\nSearch and extract the latest agreed terms from the email conversation for the NEW invoice:\n1. Deal Title: Assign a well-suited deal title based on what's being discussed in the thread.\n2. Amount: Extract the latest agreed amount if provided in the email. If not available, set to \"Not Provided\".\n3. Due Date: Identify the due date for the invoice from the conversation. If not mentioned, set to \"Not Provided\".\n4. Status: Set the current status to \"Draft\".\n5. ${recipientInstructions}\n\nFINAL STEP: Ask the manager for approval to proceed with creating this NEW invoice based on the extracted details.\n      `.trim(),\n      invoice_next_step: 'create_new'\n    };\n  }\n  \n  // PRIORITY 2: Check if deal is in review stage\n  if (dealStage === 'Needs Review') {\n    return {\n      promptInstructions: `There is no invoice due at this stage of the deal negotiations. Don't mention anything to the Manager on the invoice related to this deal.`,\n      invoice_next_step: 'no_action'\n    };\n  }\n  \n  // PRIORITY 3: Check if ALL invoices are paid\n  const allPaid = invoiceTermsList.length > 0 && invoiceTermsList.every(inv => inv.invoice_status === 'Paid');\n  if (allPaid) {\n    return {\n      promptInstructions: `\nAll invoices for this deal have been paid:\n${formatInvoicesList(invoiceTermsList)}\n\nDESCRIPTION: All invoices are already paid and require no further changes or actions.\n      `.trim(),\n      invoice_next_step: 'no_action'\n    };\n  }\n  \n  // PRIORITY 4: Invoices exist (at least one is not paid) - compile and compare terms\n  if (invoiceTermsList.length > 0) {\n    const paidInvoices = invoiceTermsList.filter(inv => inv.invoice_status === 'Paid');\n    const unpaidInvoices = invoiceTermsList.filter(inv => inv.invoice_status !== 'Paid');\n    \n    let promptText = `Multiple invoices exist for this deal:\\n\\n`;\n    \n    if (paidInvoices.length > 0) {\n      promptText += `PAID INVOICES (No action needed):\\n${formatInvoicesList(paidInvoices)}\\n\\n`;\n    }\n    \n    if (unpaidInvoices.length > 0) {\n      promptText += `UNPAID/DRAFT INVOICES:\\n${formatInvoicesList(unpaidInvoices)}\\n\\n`;\n      promptText += `Please analyze and compare these unpaid invoice terms with the email conversation to identify the final agreed terms. Look for any discrepancies, updates, or modifications discussed in the email thread and provide recommendations for aligning each invoice with the agreed terms.`;\n    }\n    \n    return {\n      promptInstructions: promptText.trim(),\n      invoice_next_step: 'update'\n    };\n  }\n  \n  // FALLBACK: No existing invoices found\n  let recipientInstructions = getRecipientInstructions(recipient);\n  \n  return {\n    promptInstructions: `\nNo existing invoices found for this deal. Please extract the latest agreed details from the email conversation:\n1. Deal Title: Create a well-suited deal title based on what's being discussed in the thread.\n2. Amount: Extract the latest agreed amount if provided in the email. If not available, set to \"Not Provided\".\n3. Due Date: Identify the due date for the invoice from the conversation. If not mentioned, set to \"Not Provided\".\n4. Status: Set the current status to \"Draft\".\n5. ${recipientInstructions}\n\nNOTE: If multiple invoices are discussed (e.g., milestone payments, split payments), extract details for each invoice separately.\n\nFINAL STEP: Ask the manager for approval to proceed with creating this invoice (or these invoices) based on the extracted details.\n    `.trim(),\n    invoice_next_step: 'create_new'\n  };\n}\n\n// Helper function to format invoices list\nfunction formatInvoicesList(invoicesList) {\n  return invoicesList.map((inv, index) => {\n    const details = [];\n    details.push(`Invoice ${index + 1}:`);\n    if (inv.invoice_id) details.push(`  - Invoice ID: ${inv.invoice_id}`);\n    if (inv.invoice_number) details.push(`  - Invoice Number: ${inv.invoice_number}`);\n    if (inv.person_name) details.push(`  - Person: ${inv.person_name}`);\n    if (inv.invoice_amount) details.push(`  - Amount: ${inv.invoice_amount}`);\n    if (inv.due_date) details.push(`  - Due Date: ${inv.due_date}`);\n    if (inv.invoice_status) details.push(`  - Status: ${inv.invoice_status}`);\n    return details.join('\\n');\n  }).join('\\n\\n');\n}\n\n// Helper function to get recipient instructions\nfunction getRecipientInstructions(recipient) {\n  switch (recipient.status) {\n    case 'exists':\n      return `Recipient: ${recipient.name}`;\n    case 'missing':\n      return `Recipient: ${recipient.name}\\n  NOTE: Ask the manager whether they want to register this recipient or not.`;\n    case 'not_provided':\n      return `Recipient: Ask the manager about the invoice recipient details.`;\n    default:\n      return `Recipient: Status unknown - please clarify with manager.`;\n  }\n}\n\n// Main execution for n8n\nconst invoiceMetadataRaw = $json.invoice_metadata;\nconst invoiceTermsRaw = $(\"Invoices\").all();\n\nlet invoice_request;\ntry {\n  invoice_request = $(\"InvoiceInputs\").first().json.output.invoice.next_step || \"update\";\n} catch (error) {\n  invoice_request = \"update\";\n}\n\n// Process all invoices\nconst invoiceTermsList = invoiceTermsRaw\n  .map(item => item.json?.invoice_info)\n  .filter(inv => inv != null)\n  .map(inv => {\n    // Create a clean copy without invoice_number and invoice_customer_id\n    const cleanInvoice = { ...inv };\n    delete cleanInvoice.invoice_number;\n    delete cleanInvoice.invoice_customer_id;\n    return cleanInvoice;\n  });\n\nconst deal_stage = $('Session4').first()?.json?.deal_metadata[0];\n\ntry {\n  const result = generateAnalysisPrompt(\n    invoiceMetadataRaw, \n    invoiceTermsList, \n    deal_stage, \n    invoice_request\n  );\n  \n  return [\n    {\n      json: {\n        invoice_search_output: result.promptInstructions,\n        invoice_next_step: result.invoice_next_step,\n        invoice_metadata: invoiceMetadataRaw,\n        invoice_count: invoiceTermsList.length,\n        invoices: invoiceTermsList,\n        deal_stg_temp: deal_stage\n      }\n    }\n  ];\n} catch (error) {\n  throw new Error(`Prompt generation failed: ${error.message}`);\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        1200
      ],
      "id": "4db121d0-8015-47ac-ae74-edb5f452f6b0",
      "name": "InvoiceInstructions"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "589cc8a3-030f-4bbe-9ed2-1dd9140464b9",
              "leftValue": "={{ $json.isNotEmpty() }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        720,
        1220
      ],
      "id": "f1273049-af0a-486b-a6da-d39f4990cc89",
      "name": "If4"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COALESCE(\n    jsonb_build_object(\n      'invoice_id', i.invoice_number,\n      'deal_id', $2,\n      'invoice_number', i.number,\n      'invoice_amount', i.amount,\n      'invoice_status', i.status,\n      'invoice_customer_id', i.customer_id,\n      'person_name', $3\n    ),\n    NULL\n  ) AS invoice_info\nFROM invoices_invoice i\nWHERE i.book_id = $1 AND i.master_deal_id = $2 AND deleted_at ISNULL\nLIMIT 5;",
        "options": {
          "queryReplacement": "={{ $('Input').first().json.sub_session.person_verification.book_id}}, {{ $('Input').first().json.sub_session.deal_metadata[0].deal_id }}, {{ $('Input').first().json.sub_session.person_verification.person_legal_name }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        360,
        1260
      ],
      "id": "f0fa8fd2-ca0d-4e8b-a340-d6f58bb2ccea",
      "name": "InvoiceTerms",
      "retryOnFail": true,
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.invoice_next_step === 'update'  }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "333f6206-18c1-4317-94f5-ea11cf01dadd"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1cb4dd84-753e-4d08-b41b-72d291211b0f",
                    "leftValue": "={{ $json.invoice_next_step === 'create_new' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "756a8c57-4314-4d56-a80c-c98c286d71d0",
                    "leftValue": "={{ $json.invoice_next_step === 'no_action' }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1800,
        1200
      ],
      "id": "8992177a-c97d-4ab1-9b9e-243122ea6a46",
      "name": "Switch2"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $json.thread_id+ $json.Manager.user_id}}",
        "value": "={{ $json.toJsonString() }}",
        "keyType": "string",
        "expire": true,
        "ttl": "={{ 60 * 60 * 24 * 30 }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1300,
        1200
      ],
      "id": "7af8d8ba-eeec-472a-9e46-6868ba6bf519",
      "name": "Store4",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Input').first().json.sub_session;\nconst invoiceInfoArray = $(\"Invoices\").all().map(item => item.json.invoice_info).filter(Boolean);\n\n// Validate presence of sub_session\nif (!prev) {\n  throw new Error(\"Missing sub_session\");\n}\n\n// Prepare invoice_metadata structure\nlet invoice_metadata = {\n  invoice_recipient: $input.first().json.invoice_recipient,\n  invoices: []\n};\n\nif (invoiceInfoArray.length > 0) {\n  // Get existing invoices array\n  const existingInvoices = prev.invoice_metadata?.invoices || [];\n  \n  // Create Map from existing data - only include entries with invoice_number\n  const uniqueInvoicesMap = new Map(\n    existingInvoices\n      .filter(inv => inv.invoice_number) // Only include entries with invoice_number\n      .map(inv => [inv.invoice_number, inv])\n  );\n  \n  // Add/update with new invoices\n  invoiceInfoArray.forEach(invoiceInfo => {\n    if (invoiceInfo.invoice_number) {\n      uniqueInvoicesMap.set(invoiceInfo.invoice_number, {\n        \"exists\": true,\n        deal_id: invoiceInfo.deal_id,\n        invoice_id: invoiceInfo.invoice_id,\n        invoice_number: invoiceInfo.invoice_number,\n        customer_name: invoiceInfo.customer_name\n      });\n    }\n  });\n  \n  // Convert Map to array - guaranteed unique by invoice_number\n  invoice_metadata.invoices = Array.from(uniqueInvoicesMap.values());\n  \n} else {\n  // If no invoices exist, add a single \"not exists\" entry\n  invoice_metadata.invoices = [\n  ];\n}\n\n// Return original data unchanged + updated sub_session\nreturn [\n  {\n    json: {\n      ...prev,\n      invoice_metadata: invoice_metadata\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        1200
      ],
      "id": "56ad0974-73b1-472b-b044-1327fdcdbc56",
      "name": "Session4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "40d7397e-7161-46b6-a482-274968d356d7",
              "name": "invoice_search_findings",
              "value": "={{ $json.invoice_search_output }}",
              "type": "string"
            },
            {
              "id": "f6f9f910-0297-41dc-a18b-5076731f6203",
              "name": "deal_next_step",
              "value": "no_action",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2000,
        1440
      ],
      "id": "48f1f8f7-96a2-4ce3-8753-ed991a451197",
      "name": "New/Options3"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "2pP2wYbGL3fjaJ0y",
          "mode": "list",
          "cachedResultName": "InvoiceCustomer-V-1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "retrieve",
            "data": "={{  \n{\n\"invoice_recipient\": $json?.invoice?.recipient ?? \"\", \"threshold\": 0.05,\nbook_number: $('Input').first().json.sub_session.person_verification.book_number\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        680,
        1640
      ],
      "id": "9e943c2b-7672-4a26-9315-d549bdc98ca0",
      "name": "InvoiceRecipient"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8e218b64-283b-44f7-a51e-2ba9b79f89a8",
              "name": "output.person_verification",
              "value": "={{ $('Input').first().json.sub_session.person_verification }}",
              "type": "object"
            },
            {
              "id": "49ff862f-37a2-42f3-b2a5-9a39de5119c2",
              "name": "output.invoice",
              "value": "={{ $('InvoiceInput').first().json.invoice }}",
              "type": "object"
            },
            {
              "id": "5f5831de-0a47-4a3a-8592-075f0a829e76",
              "name": "output.invoice.recipient",
              "value": "={{ $json.invoice_recipient }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        900,
        1640
      ],
      "id": "24b0a1ab-ad78-4d33-83f5-85610445c156",
      "name": "InvoiceInfo"
    },
    {
      "parameters": {
        "jsCode": "// Safe reads\nconst book_id = $json?.output?.person_verification?.book_id\nconst inv = $json?.output?.invoice ?? {};\nconst invoiceId = (inv.invoice_id ?? \"\").toString().trim() || null;\nconst inv_next_step = (inv.next_step ?? \"\").toString().trim() || null;\n\nconst rec = inv.recipient ?? {};\nconst recStatus = (rec.status ?? \"not_provided\").trim();\nconst recName = (rec.name ?? \"\").trim();\nconst recNumber = rec.invoice_recipient_number ?? null;\n\nconst amount = Number.isFinite(Number(inv.amount)) ? Number(inv.amount) : null;\n\n// Build all valid routes (not exclusive)\nconst routes = [];\n\n/**\n * Rule 1: by_invoice_id\n * - No other parameter needs to be checked.\n */\nif (invoiceId) {\n  routes.push({\n    route_by: \"by_invoice_id\",\n    invoice_id: invoiceId,\n    next_step: inv_next_step,\n    book_id \n  });\n}\n\nconst recipientIsValid = recStatus === \"exists\" && !!recName;\n\nif (recipientIsValid && amount !== null) {\n  routes.push({\n    route_by: \"by_recipient_with_amount\",\n    recipient_number: recNumber ?? null,\n    recipient_name: recName,\n    amount,\n    book_id\n  });\n}\n\nif (recipientIsValid) {\n  routes.push({\n    route_by: \"by_recipient_no_amount\",\n    recipient_number: recNumber ?? null,\n    recipient_name: recName,\n    book_id\n  });\n}\n\n/**\n * Rule 4: by_amount_only\n * - Only when no other scenarios are valid AND amount is provided\n */\nif (amount !== null) {\n  routes.push({\n    route_by: \"by_amount_only\",\n    amount,\n    book_id\n  });\n}\n\n/**\n * Fallback ONLY if no valid routes at all\n */\nif (routes.length === 0) {\n  routes.push({\n    route_by: \"no_info_provided\",\n    recipient_name: recName || null,\n    book_id\n  });\n}\n\n// Output\nreturn { json: { routes } };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        1640
      ],
      "id": "6f973c16-a47b-4e34-b06e-8dc88acfc692",
      "name": "Invoice Lookup inputs"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HlDl13aUnQDXiwvI",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "check",
            "data": "={{ $json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1340,
        1640
      ],
      "id": "660ccbef-bc3b-45e2-9bb2-d63e1c6acac5",
      "name": "InvoiceCheck"
    },
    {
      "parameters": {
        "jsCode": "// Pull previous payload and current input\nconst prev = $('Store1').first()?.json;\nconst invoiceInfo = {};\nconst last_response = \"No enough information for invoice search\";\n\n// Validate presence of sub_session\nif (!prev || !prev.sub_session) {\n  throw new Error(\"Missing sub_session\");\n}\n\n// Prepare invoice_metadata\nlet invoice_metadata;\nif (Object.keys(invoiceInfo).length > 0) {\n  invoice_metadata = {\n    invoice_status: \"missing\",\n  };\n} else {\n  invoice_metadata = {\n    invoice_status: \"missing\"\n  };\n}\n\n// Update only sub_session (do not mutate original data)\nconst updatedSubSession = {\n  ...prev.sub_session,\n  invoice_metadata,\n  last_bot_response: last_response\n};\n\n// Return original data unchanged + updated sub_session\nreturn [\n  {\n    json: {\n      data: prev.data,\n      sub_session: updatedSubSession\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        640,
        2000
      ],
      "id": "58da0b13-b7ee-4d7a-af73-e228337ee025",
      "name": "WPS-Upd-14"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a25d4362-1dbe-4a26-8fc9-a4e0ea3071d1",
              "name": "message",
              "value": "=The thread lacks enough information to locate the invoice for the payee {{ $json.sub_session.customer_verification.customer_name }}. Ask the manager if he is still interested, he can provide details such as invoice ID, Payer or amout details.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        860,
        2000
      ],
      "id": "6719b96b-d26a-4ea9-b092-61a37d164768",
      "name": "FormatSessionData22"
    },
    {
      "parameters": {
        "jsCode": "function toStr(v) {\n  if (v === null || v === undefined) return \"\";\n  return String(v);\n}\n\nfunction isPaid(status) {\n  return toStr(status).trim().toLowerCase() === \"paid\";\n}\n\nfunction stripHtml(s) {\n  const str = toStr(s);\n  return str.replace(/<[^>]*>/g, \" \").replace(/\\s+/g, \" \").trim();\n}\n\nfunction mdEscape(s) {\n  return toStr(s).replace(/\\|/g, \"\\\\|\").replace(/`/g, \"\\\\`\").replace(/\\r?\\n/g, \" \");\n}\n\nfunction tableForInvoices(invoices) {\n  const header = `| # | Title | Details | Invoice ID | Amount | Status | Recipient |\n|---:|-------|---------|-----------:|-------:|--------|-----------|`;\n\n  const rows = invoices.map((inv, idx) => {\n    const t = mdEscape(inv.title ?? \"â€”\");\n    const d = mdEscape(stripHtml(inv.details ?? \"â€”\"));\n    const id = mdEscape(inv.invoice_id ?? \"â€”\");\n    const amt = typeof inv.invoice_amount === \"number\" ? inv.invoice_amount : (toStr(inv.invoice_amount) || \"â€”\");\n    const st = mdEscape(inv.invoice_status ?? \"â€”\");\n    const rec = mdEscape(inv.invoice_recipient ?? \"â€”\");\n    return `| ${idx + 1} | ${t} | ${d} | ${id} | ${amt} | ${st} | ${rec} |`;\n  });\n\n  return [header, ...rows].join(\"\\n\");\n}\n\n// ---------- Main ----------\nconst data = $json;\nconst data_add = $(\"InvoiceInput\").first().json\n\nconst route = toStr(data.route_by).trim();\nconst invoices = Array.isArray(data.invoices) ? data.invoices : [];\nconst invoiceType = toStr(data_add.invoice?.request_type || data.request_type || \"\").toLowerCase();\nconst recipient = $(\"InvoiceInfo\").first().json.output.invoice.recipient || {};\n\nlet invoice_search_findings = \"\";\nlet invoice_next_step = \"no_action\";\nlet invoice_metadata = { exists: false };\n\n// ---------- Routing Logic ----------\nif (route === \"by_invoice_id\") {\n  const inv = invoices[0] || {};\n  if (Object.keys(inv).length > 0) {\n    if (isPaid(inv.invoice_status)) {\n      invoice_search_findings =\n        \"I found below invoice which shows that the status is already Paid. There are no updates due to this invoice.\\n\\n\" +\n        tableForInvoices([inv]);\n      invoice_next_step = \"no_action\";\n      \n      // Add invoice metadata for no_action with provided data\n      invoice_metadata = {\n        exists: true,\n        invoice_id: inv.invoice_id,\n        invoice_number: inv.invoice_number || inv.invoice_id,\n        message: \"Invoice metadata added\"\n      };\n      \n    } else {\n      invoice_search_findings =\n        `I found the below invoice which has a current status of ${toStr(inv.invoice_status)}. ` +\n        \"Recommend changes discussed in the thread to the invoice and ask for manager's approval.\\n\\n\" +\n        tableForInvoices([inv]);\n      invoice_next_step = \"update\";\n      \n      // Add invoice metadata for update with provided data\n      invoice_metadata = {\n        exists: true,\n        invoice_id: inv.invoice_id,\n        invoice_number: inv.invoice_number || inv.invoice_id,\n        message: \"Invoice metadata added\"\n      };\n    }\n  } else {\n    if (invoiceType === \"general\") {\n      invoice_search_findings =\n        \"I could not locate any invoice for the <payee: customer_name>. Propose a nice invoice draft to the manager and ask for his approval?\";\n      invoice_next_step = \"create_new\";\n      \n      // Add invoice metadata for create_new (not provided case)\n      invoice_metadata = {\n        exists: false,\n        invoice_recipient: recipient\n      };\n      \n    } else {\n      invoice_search_findings =\n        \"I could not locate any invoice matching this request. Offer further invoice and deals related help to the manager\";\n      invoice_next_step = \"no_action\";\n      \n      // Add invoice metadata for no_action (not provided case)\n      invoice_metadata = {\n        exists: false,\n        invoice_recipient: recipient\n      };\n    }\n  }\n} else {\n  // route_by != by_invoice_id\n  // ALL other cases: always {exists: false, invoice_recipient}\n  if (invoices.length > 1) {\n    invoice_search_findings =\n      \"I found multiple invoices matching this request. Ask the manager to select the correct invoice relevant to this discussion from given below:\\n\\n\" +\n      tableForInvoices(invoices);\n    invoice_next_step = \"await_confirmation\";\n    \n  } else if (invoices.length === 1) {\n    const inv = invoices[0];\n    if (isPaid(inv.invoice_status)) {\n      invoice_search_findings =\n        \"I found below invoice with status being Paid. Ask manager to confirm below invoice being discussed in this conversation..\\n\\n\" +\n        tableForInvoices([inv]);\n      invoice_next_step = \"await_confirmation\";\n      \n    } else {\n      invoice_search_findings =\n        `I found the below invoice which has a current status of ${toStr(inv.invoice_status)}.` +\n        \"Confirm from manager if this is the invoice he is refering to.\\n\\n\" +\n        tableForInvoices([inv]);\n      invoice_next_step = \"await_confirmation\";\n    }\n  } else {\n    if (invoiceType === \"general\") {\n      invoice_search_findings =\n        \"I could not locate any invoice. Find and draft an invoice with below fields;\\n -Amount, \\n -Due Date, \\-Invoice Recipient.\";\n      invoice_next_step = \"create_new\";\n      \n    } else {\n      invoice_search_findings =\n        \"I could not locate any invoice matching this request.\";\n      invoice_next_step = \"no_action\";\n    }\n  }\n  \n  // For all cases where route != \"by_invoice_id\"\n  invoice_metadata = {\n    exists: false,\n    invoice_recipient: recipient\n  };\n}\n\n// ---------- Recipient Handling (general invoices only) ----------\nif (invoiceType === \"general\") {\n  if (recipient.status === \"missing\") {\n    invoice_search_findings +=\n      \"\\n\\nThe invoice recipient is not registered. Also confirm if the Manager wants to register the current recipient?\";\n  } else if (recipient.status === \"not_provided\") {\n    invoice_search_findings +=\n      \"\\n\\nNo recipient provided\";\n  }\n}\n\nreturn {\n  invoice_next_step,\n  invoice_search_findings,\n  invoice_metadata\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1560,
        1640
      ],
      "id": "c5e2884b-b75d-465b-84d0-70a610d81f7b",
      "name": "GuidedResponses"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "2pP2wYbGL3fjaJ0y",
          "mode": "list",
          "cachedResultName": "InvoiceCustomer-V-1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "retrieve",
            "data": "={{  \n{\n\"invoice_recipient\": $json?.invoice?.recipient ?? \"\", \"threshold\": 0.05,\nbook_number: $('Input').first().json.sub_session.person_verification.book_number\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": true
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        680,
        1840
      ],
      "id": "987936f4-a280-4297-970d-642be467fdf5",
      "name": "InvoiceRecipient1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ ($json.invoice.amount != null || $json.invoice.invoice_id != null || $json.invoice.recipient != null) && $json.invoice.next_step!==\"create_new\"}}",
                    "rightValue": "deal",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "7c15fe57-4eb5-46f9-8483-3c8eb8e3a06b"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "32aa5725-5fd7-4965-ac28-14f869828e46",
                    "leftValue": "={{ ($json.invoice.amount != null || $json.invoice.invoice_id != null || $json.invoice.recipient != null) && $json.invoice.next_step===\"create_new\"}}",
                    "rightValue": "missing_requirement",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ec123837-3c81-4088-a699-fc0403b6d7b2",
                    "leftValue": "={{ $json.invoice.amount === null && $json.invoice.invoice_id === null && $json.invoice.recipient === null}}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        460,
        1840
      ],
      "id": "c0eaa97e-3e33-4ed3-98ff-2a872f012f29",
      "name": "Switch3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "db054f4f-0e46-4dab-8af1-36df5c65bdb0",
              "name": "invoice",
              "value": "={{ $json.output.invoice }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        160,
        1840
      ],
      "id": "ed316d38-33ba-46bf-8b87-4e1a6f4e31fb",
      "name": "InvoiceInput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "40d7397e-7161-46b6-a482-274968d356d7",
              "name": "invoice_search_findings",
              "value": "={{ $('GuidedResponses').item.json.invoice_search_findings }}",
              "type": "string"
            },
            {
              "id": "f6f9f910-0297-41dc-a18b-5076731f6203",
              "name": "invoice_next_step",
              "value": "={{ $('GuidedResponses').first().json.invoice_next_step }}",
              "type": "string"
            },
            {
              "id": "65a21155-e716-4a55-bc1d-2ddfb563e942",
              "name": "metadata",
              "value": "={{ $('Store10').first().json }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2440,
        1840
      ],
      "id": "81261267-414f-456a-8d06-f2d97e31b924",
      "name": "New/Options4"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node (JavaScript)\n\n// --- Ingest previous session and current input ---\nconst prev =  $('Input').first().json.sub_session;\nif (!prev || !prev) {\n  throw new Error(\"Missing sub_session\");\n}\n\n// --- Build invoice_metadata ---\nlet invoice_metadata = {\"exists\": false}\ninvoice_metadata.invoice_recipient =$input.first().json.invoice_recipient\n\nreturn [\n  {\n    json: {\n      ...prev,\n      invoice_metadata: invoice_metadata\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        1840
      ],
      "id": "d0d65a05-d4dd-423c-bb70-43a42ff291ce",
      "name": "Session8"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('GuidedResponses').first().json.invoice_next_step === \"update\"  }}",
                    "rightValue": "update",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "19a0ff34-4cf4-4d66-80e4-61d5633cf711"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "060c1965-3572-4841-995b-e242db8c18a4",
                    "leftValue": "={{ $('GuidedResponses').first().json.invoice_next_step ===\"create_new\" }}",
                    "rightValue": "create_new",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b06a4428-7512-4681-a1d4-16f76a4fb559",
                    "leftValue": "={{ $('GuidedResponses').first().json.invoice_next_step === \"no_action\" || $('GuidedResponses').first().json.invoice_next_step === \"await_confirmation\" }}",
                    "rightValue": "no_action",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2220,
        1640
      ],
      "id": "1a47e6bc-cd81-44a2-a7df-650f8144f3c9",
      "name": "Switch5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "048c2fc1-e917-4c0a-8b80-e68455c1ae1c",
              "name": "input",
              "value": "=Email Thread:   {{ `Subject: ${$('Trigger').first().json.data.session_data.Subject}\\n, Emails: ${$('Trigger').first().json.data.session_data.Emails}`  }}\n------------\n{{ `Deal Document: ${$('Trigger').first().json.data.session_data.last_attachment.document}\\n, Attachement Updated at: ${$('Trigger').first().json.data.session_data.last_attachment.attached_at}` }} \n------------ \nCurrent Invoice Terms: {{ $('InvoiceInstructions').first().json.invoice_search_output }}",
              "type": "string"
            },
            {
              "id": "7b9db329-dbae-40d6-ad93-03d6b4f60656",
              "name": "system_prompt",
              "value": "=You are the Patchbay Invoice Analysis Agent. Compare current Invoice Terms against source Email Thread and/or Deal Document and recommend changes only with explicit evidence.\n\nINPUTS\n- Email Thread: Chronological correspondence\n- Deal Document: Contract terms (if provided)\n- Invoice Current Details: Current details of the invoice.\n- Context: person_name, artist_name, master_name\n\nEvidence Priority: One with the latest agreed terms.\n\nANALYSIS LOGIC\nFor each field:\n1. If not mentioned in sources, skip it and make no recommendation\n2. If source value differs from current value, recommend update\n3. If current value is null/NaN but source has value, recommend update\nNever recommend changes without source evidence.\n\nKEY DEAL FIELDS\n- Status: Draft â†’ Sent â†’ In-Transit â†’ Paid\n  Only move forward, never backward. Skip if already Fully Paid.\n- Amount: Total invoice amount, fees, payment amounts per latest agreed terms\n- Dates: Execution, payment due, delivery, signature dates\n- Party Info: Client name, company, contacts\n\nSTATUS KEYWORDS/Patterns\nStatus:\n- \"'Draft': Draft an invoice for Quincy Jones\"\n- \"Send\" The invoice has been sent  to the payee.\n- \"In-Transit\" means invoice is send but not being recived by payee.\n- \"Paid\" Paid by the Paying party.\n\nOUTPUT FORMAT\nI found below invoice(s):\n- <Mention and invoice current invoice terms here>\n\nIf need update: \n\"Below are the fields which needs to be updated as per <refer to changes agreed upon>\"\";\nField: [field_name]\nCurrent: [current_value]\nSource: [source_value]\nEvidence: \"[exact quote]\" - [source] ([date])\nRecommendation: [what to change]\n\nIf don't need update: \n- <Invoice(s) numbers> are up to date and don't need any changes as per the latest recommendation.\n\nFinal Summary:\n- invoice_next_step: update or not_update.\n\nCRITICAL RULES\n1. Cite exact quotes for every recommendation\n2. Never move deal status backward\n3. Do not assume - only use provided evidence\n4. Most recent email overrides older ones\n5. Deal Document overrides Email Thread\n\nRecent chat history for context:\n{{ $('Trigger').first().json.data.history }}\n\nBe thorough, evidence-based, and precise. Only recommend changes you can prove with quotes.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2040,
        900
      ],
      "id": "0782a988-edd1-4e2e-92da-bd6809da4cbe",
      "name": "AiInput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "048c2fc1-e917-4c0a-8b80-e68455c1ae1c",
              "name": "input",
              "value": "=Email Thread:   {{\n`Subject: ${$('Trigger').first().json.data.session_data.Subject}\\n, Emails: ${$('Trigger').first().json.data.session_data.Emails}`\n\n}}\n------------\n{{\n`Deal Document: ${$('Trigger').first().json.data.session_data.last_attachment.document}\\n, Attachement Updated at: ${$('Trigger').first().json.data.session_data.last_attachment.attached_at}`\n}}\n------------\nInvoice Instructions: {{ $json.invoice_search_output }}",
              "type": "string"
            },
            {
              "id": "7b9db329-dbae-40d6-ad93-03d6b4f60656",
              "name": "system_prompt",
              "value": "=You are a Patchbay Invoice Analyser. Extract key terms from Email Thread and Deal Document as per the \"Instructions\" provided to collect the necessary information for the Manager's approval to create a new invoice in the Patchbay System.\n\nAnalyze provided materials (Email thread, Deal Docuement) and extract essential invoice information following the instruction template format exactly as provided.\n\nOutput format: Extract below Invoice terms Manager's approval:\n\n'Below are the terms for the invoice to be created. You must send the draft to manager for approval and wait for his response before proceeding to create the invoice;'\n- Deal Title: <A breif deal title for which the invoice is>\n- Person/Producer: {{ $('Store4').item.json.person_verification.person_legal_name || $('Store4').item.json.person_verification.person_performer_name }}\n- Status(Draft|Sent|In-Transit|Paid)\n- Amount: <Amount of the invoice to be paid>\n- Due Date: <Due date of the invoice if provided>\n- Invoice Recipient: Detais to whom will pay the invoice.\n\nRules: Extract exact values when available, use \"Not Provided\" for missing information, stick strictly to required terms only, provide clean response without additional commentary, follow instruction template format precisely.\n\nPrevious conversation history with the user is provided below which could be helpfull if any specific details the user wants to include;\n{{ $('Trigger').first().json.data.history }}\n\n\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2020,
        1200
      ],
      "id": "6d59f7c0-6bb0-424d-a6e3-92a431a9360c",
      "name": "AiInput1"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HlDl13aUnQDXiwvI",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "analyze",
            "data": "={{ $json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2320,
        900
      ],
      "id": "25d916c1-3a7e-4636-a93d-691d7ab5965c",
      "name": "Analyse"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HlDl13aUnQDXiwvI",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "analyze",
            "data": "={{ $json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2260,
        1200
      ],
      "id": "435eb6c1-b5ea-4909-b692-cb4f50e4e450",
      "name": "Analyse1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "048c2fc1-e917-4c0a-8b80-e68455c1ae1c",
              "name": "input",
              "value": "={{ $('Deal Search').first().json.deal_search_output }}\n\nEmail Thread:   {{\n`Subject: ${$('Trigger').first().json.data.session_data.Subject}\\n, Emails: ${$('Trigger').first().json.data.session_data.Emails}`\n\n}}\n------------\n{{\n`Deal Document: ${$('Trigger').first().json.data.session_data.last_attachment.document}\\n, Attachement Updated at: ${$('Trigger').first().json.data.session_data.last_attachment.attached_at}`\n}}\n",
              "type": "string"
            },
            {
              "id": "7b9db329-dbae-40d6-ad93-03d6b4f60656",
              "name": "system_prompt",
              "value": "=You are the Patchbay Deal Analysis Agent. Compare current deal terms against source documents/Information and recommend changes only with explicit evidence.\n\nINPUTS\n- Email Thread: Chronological correspondence\n- Deal Document: Contract terms (if provided)\n- Deal Current Details: Current system state\n- Context: person_name, artist_name, master_name\n\nEvidence Priority: Deal Document > Email Thread > Current Details\n\nANALYSIS LOGIC\nFor each field:\n1. If not mentioned in sources, skip it and make no recommendation\n2. If source value differs from current value, recommend update\n3. If current value is null/NaN but source has value, recommend update\nNever recommend changes without source evidence.\n\nKEY DEAL FIELDS\n- Status: Need Review â†’ Counter Party Action â†’ Client Signature â†’ Counter Party Signature â†’ Fully Executed\n  Only move forward, never backward. Skip if already Fully Executed.\n- Payment Status: Unpaid â†’ Processing â†’ Paid. Skip if not mentioned.\n- Amounts: Total deal amount, fees, payment amounts per latest agreed terms\n- Dates: Execution, payment due, delivery, signature dates\n- Party Info: Client name, company, contacts\n\nSTATUS KEYWORDS\nStatus:\n- \"signed by both parties\" or \"fully executed\" means Fully Executed\n- \"counter party signed\" means Counter Party Signature\n- \"sent to client for signature\" means Client Signature\n- \"waiting for [party]\" means appropriate pending status\n\nPayment Status:\n- \"paid\" or \"payment received\" or \"wire received\" means Paid\n- \"pending payment\" or \"processing\" means Processing\n- \"outstanding\" or \"awaiting payment\" means Unpaid\n\nOUTPUT FORMAT\nFor each field needing update:\n\nField: [field_name]\nCurrent: [current_value]\nSource: [source_value]\nEvidence: \"[exact quote]\" - [source] ([date])\nRecommendation: [what to change]\n\nFinal Summary:\n- deal_next_step: update or not_update.\n\nCRITICAL RULES\n1. Cite exact quotes for every recommendation\n2. Never move deal status backward\n3. Do not assume - only use provided evidence\n4. Most recent email overrides older ones\n5. Deal Document overrides Email Thread\n\nRecent chat history for context:\n{{ $('Trigger').first().json.data.history }}\n\nBe thorough, evidence-based, and precise. Only recommend changes you can prove with quotes.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2360,
        -160
      ],
      "id": "8faa672b-5ff3-4b0c-a40f-260fc2c9ae17",
      "name": "AiInput2"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "J9qD5mmAG74Azgol",
          "mode": "list",
          "cachedResultName": "deal_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "analyze",
            "data": "={{ $json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2580,
        -160
      ],
      "id": "18d3a682-455d-4f30-b475-281c75661cda",
      "name": "Analyse2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "048c2fc1-e917-4c0a-8b80-e68455c1ae1c",
              "name": "input",
              "value": "={{ $('Deal Search').first().json.deal_search_output }}\n\nEmail Thread:   {{\n`Subject: ${$('Trigger').first().json.data.session_data.Subject}\\n, Emails: ${$('Trigger').first().json.data.session_data.Emails}`\n\n}}\n------------\n{{\n`Deal Document: ${$('Trigger').first().json.data.session_data.last_attachment.document}\\n, Attachement Updated at: ${$('Trigger').first().json.data.session_data.last_attachment.attached_at}`\n}}\n------------",
              "type": "string"
            },
            {
              "id": "7b9db329-dbae-40d6-ad93-03d6b4f60656",
              "name": "system_prompt",
              "value": "=You are a Patchbay Deal Analyser. Extract key terms from Email Thread and Deal Document as per the \"Instructions\" provided to collect the necessary information for the Manager's approval to create a new deal in the Patchbay System.\n\nAnalyze provided materials (emails, contracts, existing deals) and extract essential deal information following the instruction template format exactly as provided.\n\nOutput format: Start with brief summary without heading, followed by \"**Proposed Terms:**\" heading with required terms as bullet points, end with exactly: \"I have compiled the above instructions for the deal under discussion. Please share these with the manager and ask for his approval to create a new deal or ask for what he wants to change.\"\n\nExtract only these required terms:\n- Person/Producer\n- Artist  \n- Master(s)\n- Status\n- Payment Status\n- Fee Amount\n- Royalty Terms\n\nRules: Extract exact values when available, use \"Not Provided\" for missing information, stick strictly to required terms only, provide clean response without additional commentary, follow instruction template format precisely.\n\nPrevious conversation history with the user is provided below which could be helpfull if any specific details the user wants to include;\n{{ $('Trigger').first().json.data.history }}\n\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2240,
        660
      ],
      "id": "7e40fc96-a4e0-4ad7-8151-1a5518286e35",
      "name": "AiInput3"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "J9qD5mmAG74Azgol",
          "mode": "list",
          "cachedResultName": "deal_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "analyze",
            "data": "={{ $json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2460,
        660
      ],
      "id": "471af6d5-3b40-4837-94a1-c41de00d8750",
      "name": "Analyse3"
    },
    {
      "parameters": {
        "jsCode": "// Get the invoice recipient status from the previous node\nconst invoiceRecipientStatus = $('InvoiceRecipient1').first().json.invoice_recipient.status;\n\n// Get person legal name from session data\nconst personLegalName = $('Session8').first().json.person_verification.person_legal_name;\n\n// Get invoice recipient name (if exists)\nconst invoiceRecipientName = $('InvoiceRecipient1').first().json.invoice_recipient.name || 'Not Provided';\n\n// Initialize output object with common fields\nlet output = {\n  invoice_status: \"create_new\"  // Consistent field name across all branches\n};\n\n// Route based on invoice recipient status\nif (invoiceRecipientStatus === 'exists') {\n  // RecipientExists node logic\n  output.invoice_search_findings = `Extract below invoice details(agreeed by all parties) from the given Email Threa/Deal Document as per the latest correspondance: \n\nPayee: ${personLegalName}\nService: <Service Provided by Payee>\nFee: <latest discussed/proposed fee> \nStatus: <latest discussed status or Draft(by default)> \nDue Date: <Due Date if provided> \nInvoice Recipient: ${invoiceRecipientName}  \n\nIf you could not find the invoice due date from the conversation set it to [to be confirmed by manager].`;\n  \n} else if (invoiceRecipientStatus === 'missing') {\n  // RecipientExists3 node logic\n  output.propose_to_manager_on_invoice = `Extract below invoice details(agreeed by all parties) from the given Email Threa/Deal Document as per the latest correspondance: \n\nPayee: ${personLegalName}\nServices: <Services provided by Payee>\nFee: <latest discussed/proposed fee> \nStatus: <latest discussed status or Draft(by defauld)> \nDue Date: <Due Date if provided> \nInvoice Recipient: ${invoiceRecipientName}\nNote: Invoice recipient is mentioned in the email discussion but is not registered in personLegalName workspace. Need confirmation to be registered.\n`;\n  \n} else if (invoiceRecipientStatus === 'not_provided') {\n  // RecipientExists4 node logic\n  output.propose_to_manager_on_invoice = `Extract below invoice details(agreeed by all parties) from the given Email Threa/Deal Document as per the latest correspondance: \nPayee: ${personLegalName}\nServices: <What services are provided by payee>\nFee: <latest discussed/proposed fee> \nStatus: <latest discussed status or Draft(by defauld)> Due Date: <Due Date if provided> \nDue Date: <Extract if provided otherwise set to 'Not Provided'>\nInvoice Recipient: Not Provided.\nNote: The invoice recipient is not provided any where in the discussion. This needs confirmation from Manager.`\n\n}\n\n// Return the output\nreturn [{ json: output }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1340,
        1840
      ],
      "id": "34541c02-7263-4fb1-8fa2-979dac060200",
      "name": "Code"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HlDl13aUnQDXiwvI",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "analyze",
            "data": "={{ $json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1780,
        1840
      ],
      "id": "d6bde774-36ae-4d3e-9ba6-67b82f9bdbae",
      "name": "Analyse4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "048c2fc1-e917-4c0a-8b80-e68455c1ae1c",
              "name": "input",
              "value": "=Email Thread:   {{\n`Subject: ${$('Trigger').first().json.data.session_data.Subject}\\n, Emails: ${$('Trigger').first().json.data.session_data.Emails}`\n\n}}\n------------\n{{\n`Deal Document: ${$('Trigger').first().json.data.session_data.last_attachment.document}\\n, Attachement Updated at: ${$('Trigger').first().json.data.session_data.last_attachment.attached_at}`\n}}\n------------\nInvoice Instructions: {{ $json.invoice_search_findings }}",
              "type": "string"
            },
            {
              "id": "7b9db329-dbae-40d6-ad93-03d6b4f60656",
              "name": "system_prompt",
              "value": "=You are a Patchbay Invoice Analyser. Extract key terms from Email Thread and Deal Document as per the \"Instructions\" provided to collect the necessary information for the Manager's approval to create a new invoice in the Patchbay System.\n\nAnalyze provided materials (Email thread, Deal Docuement) and extract essential invoice information following the instruction template format exactly as provided.\n\nOutput format: Extract below Invoice terms Manager's approval;\n- Deal Title: <A breif deal title for which the invoice is>\n- Person/Producer: {{ $('Session8').item.json.person_verification.person_legal_name || $('Session8').item.json.person_verification.person_performer_name }}\n- Status(Draft|Sent|In-Transit|Paid)\n- Amount: <Amount of the invoice to be paid>\n- Due Date: <Due date of the invoice if provided>\n- Invoice Recipient: Detais to whom will pay the invoice.\n\nRules: Extract exact values when available, use \"Not Provided\" for missing information, stick strictly to required terms only, provide clean response without additional commentary, follow instruction template format precisely.\n\nPrevious conversation history with the user is provided below which could be helpfull if any specific details the user wants to include;\n{{ $('Trigger').first().json.data.history }}\n\nYou will extract whatever latest details is provided in the thread/document and set the invoice_next_step = create_new\n\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1560,
        1840
      ],
      "id": "3bd2be05-1f8e-4d05-b8e8-09fa0dce000d",
      "name": "AiInput4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "048c2fc1-e917-4c0a-8b80-e68455c1ae1c",
              "name": "input",
              "value": "=Email Thread:   {{ `Subject: ${$('Trigger').first().json.data.session_data.Subject}\\n, Emails: ${$('Trigger').first().json.data.session_data.Emails}`  }}\n------------\n{{ `Deal Document: ${$('Trigger').first().json.data.session_data.last_attachment.document}\\n, Attachement Updated at: ${$('Trigger').first().json.data.session_data.last_attachment.attached_at}` }} \n------------ \nCurrent Invoice Terms: {{ $('GuidedResponses').item.json.invoice_search_findings }}",
              "type": "string"
            },
            {
              "id": "7b9db329-dbae-40d6-ad93-03d6b4f60656",
              "name": "system_prompt",
              "value": "=You are the Patchbay Invoice Analysis Agent. Compare current Invoice Terms against source Email Thread and/or Deal Document and recommend changes only with explicit evidence.\n\nINPUTS\n- Email Thread: Chronological correspondence\n- Deal Document: Contract terms (if provided)\n- Invoice Current Details: Current details of the invoice.\n- Context: person_name, artist_name, master_name\n\nEvidence Priority: One with the latest agreed terms.\n\nANALYSIS LOGIC\nFor each field:\n1. If not mentioned in sources, skip it and make no recommendation\n2. If source value differs from current value, recommend update\n3. If current value is null/NaN but source has value, recommend update\nNever recommend changes without source evidence.\n\nKEY DEAL FIELDS\n- Status: Draft â†’ Sent â†’ In-Transit â†’ Paid\n  Only move forward, never backward. Skip if already Fully Paid.\n- Amount: Total invoice amount, fees, payment amounts per latest agreed terms\n- Dates: Execution, payment due, delivery, signature dates\n- Party Info: Client name, company, contacts\n\nSTATUS KEYWORDS/Patterns\nStatus:\n- \"'Draft': Draft an invoice for Quincy Jones\"\n- \"Send\" The invoice has been sent  to the payee.\n- \"In-Transit\" means invoice is send but not being recived by payee.\n- \"Paid\" Paid by the Paying party.\n\nOUTPUT FORMAT\nFor each field needing update:\n\nField: [field_name]\nCurrent: [current_value]\nSource: [source_value]\nEvidence: \"[exact quote]\" - [source] ([date])\nRecommendation: [what to change]\n\nFinal Summary:\n- deal_next_step: update or not_update.\n\nCRITICAL RULES\n1. Cite exact quotes for every recommendation\n2. Never move deal status backward\n3. Do not assume - only use provided evidence\n4. Most recent email overrides older ones\n5. Deal Document overrides Email Thread\n\nRecent chat history for context:\n{{ $('Trigger').first().json.data.history }}\n\nBe thorough, evidence-based, and precise. Only recommend changes you can prove with quotes.",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2440,
        1440
      ],
      "id": "e651c05a-29a9-4392-84f4-461b194b0377",
      "name": "AiInput5"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HlDl13aUnQDXiwvI",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "analyze",
            "data": "={{ $json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2660,
        1440
      ],
      "id": "5eb06e3c-ad23-4745-8d9b-f4bc4acb4b56",
      "name": "Analyse5"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "048c2fc1-e917-4c0a-8b80-e68455c1ae1c",
              "name": "input",
              "value": "=Email Thread:   {{\n`Subject: ${$('Trigger').first().json.data.session_data.Subject}\\n, Emails: ${$('Trigger').first().json.data.session_data.Emails}`\n\n}}\n------------\n{{\n`Deal Document: ${$('Trigger').first().json.data.session_data.last_attachment.document}\\n, Attachement Updated at: ${$('Trigger').first().json.data.session_data.last_attachment.attached_at}`\n}}\n------------\nInvoice Instructions: {{ $('GuidedResponses').item.json.invoice_search_findings }}",
              "type": "string"
            },
            {
              "id": "7b9db329-dbae-40d6-ad93-03d6b4f60656",
              "name": "system_prompt",
              "value": "=You are a Patchbay Invoice Analyser. Extract key terms from Email Thread and Deal Document as per the \"Instructions\" provided to collect the necessary information for the Manager's approval to create a new invoice in the Patchbay System.\n\nAnalyze provided materials (Email thread, Deal Docuement) and extract essential invoice information following the instruction template format exactly as provided.\n\nOutput format: Extract below Invoice terms Manager's approval;\n- Deal Title: <A breif deal title for which the invoice is>\n- Person/Producer: {{ $('Store4').item.json.person_verification.person_legal_name || $('Store4').item.json.person_verification.person_performer_name }}\n- Status(Draft|Sent|In-Transit|Paid)\n- Amount: <Amount of the invoice to be paid>\n- Due Date: <Due date of the invoice if provided>\n- Invoice Recipient: Detais to whom will pay the invoice.\n\nRules: Extract exact values when available, use \"Not Provided\" for missing information, stick strictly to required terms only, provide clean response without additional commentary, follow instruction template format precisely.\n\nPrevious conversation history with the user is provided below which could be helpfull if any specific details the user wants to include;\n{{ $('Trigger').first().json.data.history }}\n\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2440,
        1640
      ],
      "id": "d0a310aa-0d54-4ba9-8899-2572260565d8",
      "name": "AiInput6"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HlDl13aUnQDXiwvI",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "analyze",
            "data": "={{ $json }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2660,
        1640
      ],
      "id": "6a853608-d74e-49db-b0e5-b6cd5a2e131c",
      "name": "Analyse6"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node (JavaScript)\n\n// --- Ingest previous session and current input ---\nconst prev =  $('Input').first().json.sub_session;\nif (!prev || !prev) {\n  throw new Error(\"Missing sub_session\");\n}\n\n// Current input can be an array or object\nconst incoming = $input.first()?.json ?? {};\n\n// --- Build invoice_metadata ---\nlet invoice_metadata = incoming.invoice_metadata;\n\nreturn [\n  {\n    json: {\n      ...prev,\n      invoice_metadata: invoice_metadata\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        1640
      ],
      "id": "dac5dec8-9866-4bed-b98f-21338600629e",
      "name": "Session11"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $json.thread_id+ $json.Manager.user_id}}",
        "value": "={{ $json.toJsonString() }}",
        "keyType": "string",
        "expire": true,
        "ttl": "={{ 60 * 60 * 24 * 30 }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2000,
        1640
      ],
      "id": "6019a6e7-a6b9-433d-93b3-163202b45101",
      "name": "Store10",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "=user_session_{{ $('sub_session').first().json.data.session_data.ThreadId+$('sub_session').first().json.data.user_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1080,
        2000
      ],
      "id": "93897734-5228-4cee-aa2b-cf52d5595d0e",
      "name": "UpdateSesssion17",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "af745b92-bb83-45a7-9124-df6d91f5e3e5",
              "name": "deal_search_findings",
              "value": "={{ $json.deal_search_findings }}",
              "type": "string"
            },
            {
              "id": "782510b1-c551-490b-ad4f-97e568a0ff39",
              "name": "deal_next_step",
              "value": "create_new",
              "type": "string"
            },
            {
              "id": "430aaf43-72b2-413a-9dcd-409e7f2f5cda",
              "name": "next_tool_instructions",
              "value": "Stop here and don't call invoice_search. Directly move to compiling deal findings only.",
              "type": "string"
            },
            {
              "id": "e9557ebd-d67a-4281-a861-4975bd36bd36",
              "name": "metadata",
              "value": "={{ $('Store7').first().json }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2680,
        660
      ],
      "id": "54ddcc26-ee2d-4fc4-a0e0-a11e961cb2df",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "jsCode": "const prev = $('Input').first().json.sub_session;\nif (!prev) {\n  throw new Error(\"Missing sub_session\");\n}\nconst deal_new = $input.first().json.deal_metadata;\n\nreturn [\n  {\n    json: {\n      ...prev,\n      deal_metadata: (Array.isArray(deal_new) && deal_new.length === 0 && prev.deal_metadata && prev.deal_metadata.length > 0) \n        ? prev.deal_metadata \n        : deal_new\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1160,
        380
      ],
      "id": "cdf09c46-c4f1-40ef-b029-6d13edbf6058",
      "name": "Session5"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $json.thread_id+ $json.Manager.user_id}}",
        "value": "={{ $json.toJsonString() }}",
        "keyType": "string",
        "expire": true,
        "ttl": "={{ 60 * 60 * 24 * 30 }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1520,
        380
      ],
      "id": "da6298a8-a315-423d-a6b5-5e4f7cc71dd5",
      "name": "Store7",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "af745b92-bb83-45a7-9124-df6d91f5e3e5",
              "name": "deal_search_findings",
              "value": "={{ $json.deal_search_findings }}",
              "type": "string"
            },
            {
              "id": "782510b1-c551-490b-ad4f-97e568a0ff39",
              "name": "deal_next_step",
              "value": "{{ $json.deal_next_step }}",
              "type": "string"
            },
            {
              "id": "430aaf43-72b2-413a-9dcd-409e7f2f5cda",
              "name": "next_tool_instructions",
              "value": "Proceed to next step.",
              "type": "string"
            },
            {
              "id": "e9557ebd-d67a-4281-a861-4975bd36bd36",
              "name": "metadata",
              "value": "={{ $('Store7').first().json }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2800,
        -160
      ],
      "id": "fc7920b4-f731-459a-ba01-b04e2fbd19c9",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "bf7f6c96-6653-403d-8d39-98e060d2e67e",
              "name": "action",
              "value": "={{ $('Trigger').item.json.action }}",
              "type": "string"
            },
            {
              "id": "8bbcecc1-c9e7-4b72-9072-e3d662963236",
              "name": "session",
              "value": "={{  $('Trigger').item.json.data }}",
              "type": "object"
            },
            {
              "id": "d06fd82b-4581-4731-ae25-bdcb4c5cc6c5",
              "name": "sub_session",
              "value": "={{ $json.sub_session }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1200,
        1540
      ],
      "id": "ea5d8341-1c2a-4d35-ab84-19db266b7744",
      "name": "Input"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "40d7397e-7161-46b6-a482-274968d356d7",
              "name": "invoice_search_findings",
              "value": "={{ $json.invoice_search_findings }}",
              "type": "string"
            },
            {
              "id": "f6f9f910-0297-41dc-a18b-5076731f6203",
              "name": "invoice_next_step",
              "value": "={{ $json.invoice_next_step }}",
              "type": "string"
            },
            {
              "id": "65a21155-e716-4a55-bc1d-2ddfb563e942",
              "name": "metadata",
              "value": "={{ Object.fromEntries(Object.entries($('Store10').first().json).filter(([key]) => key !== 'last_bot_response')) }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2880,
        1540
      ],
      "id": "5431fa58-bedf-4e11-af79-3d7f16eb1894",
      "name": "New/Options6"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=user_session_{{ $json.thread_id+ $json.Manager.user_id}}",
        "value": "={{ $json.toJsonString() }}",
        "keyType": "string",
        "expire": true,
        "ttl": "={{ 60 * 60 * 24 * 30 }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1120,
        1840
      ],
      "id": "53ae9ef1-1d53-4524-b891-a46664ced649",
      "name": "Store1",
      "credentials": {
        "redis": {
          "id": "ujdbLpmKXmUC4bPj",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "2pP2wYbGL3fjaJ0y",
          "mode": "list",
          "cachedResultName": "InvoiceCustomer-V-1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "embed",
            "data": "={{\n{\nuser_id: $('Input').first().json.session.user_id,\nbook_number: $json.book_number\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        740,
        2600
      ],
      "id": "70e769a7-179e-41f3-b565-1b3e009b47bd",
      "name": "EmbedInvoiceClients"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HlDl13aUnQDXiwvI",
          "mode": "list",
          "cachedResultName": "invoice_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "add_client",
            "data": "={{ \n{\nsession_manager: $('Input').first().json.session.Manager,\nclient: $json,\nsessioin_data: $('Input').first().json.session.session_data\n}\n}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "ai_input",
              "displayName": "ai_input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        740,
        2800
      ],
      "id": "3cb24e1a-f83d-4ae6-bfdb-82aa40246afc",
      "name": "Add clients1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "40d7397e-7161-46b6-a482-274968d356d7",
              "name": "invoice_search_findings",
              "value": "=Deal Metadata is missing. First execute the search_deal to identify the details related to this discussion and then proceed to invoice_search.",
              "type": "string"
            },
            {
              "id": "f6f9f910-0297-41dc-a18b-5076731f6203",
              "name": "deal_next_step",
              "value": "no_action",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        400,
        1640
      ],
      "id": "af5f5dc2-ef13-40cc-898c-eb7c84605d8c",
      "name": "New/Options5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "666117c0-69f4-47d2-95b3-2cd2662f28f1",
              "leftValue": "={{ $('Input').first().json.sub_session.deal_metadata!=[] && $('Input').first().json.sub_session.deal_metadata.length===1}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        160,
        1280
      ],
      "id": "c9cceb89-9acc-4430-a83a-2253f7e651a6",
      "name": "If1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "40d7397e-7161-46b6-a482-274968d356d7",
              "name": "invoice_search_findings",
              "value": "={{ $json.invoice_search_findings }}",
              "type": "string"
            },
            {
              "id": "f6f9f910-0297-41dc-a18b-5076731f6203",
              "name": "invoice_next_step",
              "value": "={{ $json.invoice_next_step }}",
              "type": "string"
            },
            {
              "id": "65a21155-e716-4a55-bc1d-2ddfb563e942",
              "name": "metadata",
              "value": "={{ Object.fromEntries(Object.entries($('Store4').first().json).filter(([key]) => key !== 'last_bot_response')) }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "ignoreConversionErrors": false
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2760,
        1200
      ],
      "id": "d8f63354-e93d-4a7a-91c7-eedeeb0d8000",
      "name": "New/Options"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "vsVHPxzukmEKdO6C",
          "mode": "list",
          "cachedResultName": "Database Manager"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "embed"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        420,
        380
      ],
      "id": "1a72d851-7e3c-4eeb-bb13-f783659faff3",
      "name": "EmbedDeals"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "J9qD5mmAG74Azgol",
          "mode": "list",
          "cachedResultName": "deal_helpers-V1.0.5"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "action": "thread_last_updated",
            "data": "={{ {\nbook_id: $json.person_verification.book_id,\ndeal_id: $json.deal_metadata[0].deal_id,\ndeal_number: $json.deal_metadata[0].deal_number,\nthread_last_updated: $('Deal').first().json.output.thread_last_updated\n} }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "data",
              "displayName": "data",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "binary",
              "displayName": "binary",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        2140,
        -160
      ],
      "id": "b91e7e26-d091-44fa-b71e-7a41c194ace8",
      "name": "LastUpdated",
      "alwaysOutputData": true,
      "executeOnce": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  COALESCE(\n    jsonb_build_object(\n      'invoice_id', i.invoice_number,\n      'deal_id', $2,\n      'invoice_number', i.number,\n      'invoice_amount', i.amount,\n      'invoice_status', i.status,\n      'invoice_customer_id', i.customer_id,\n      'person_name', $3\n    ),\n    NULL\n  ) AS invoice_info\nFROM invoices_invoice i\nWHERE i.book_id = $1 AND i.master_deal_id = $2 AND deleted_at ISNULL\nLIMIT 5;",
        "options": {
          "queryReplacement": "={{ $('Input').first().json.sub_session.person_verification.book_id}}, {{ $('Input').first().json.session.deal_id }}, {{ $('Input').first().json.sub_session.person_verification.person_legal_name }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        280,
        1020
      ],
      "id": "d7cf1af6-0624-4fd6-859d-086d86faf139",
      "name": "InvoiceTerms1",
      "retryOnFail": true,
      "executeOnce": true,
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "wYLes21z9h3njdSn",
          "name": "postgress-prod"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ef681abc-82a3-4f2a-ad18-1bdbda18c068",
              "leftValue": "={{$('Input').first().json.session.deal_id!==\"null\" &&$('Input').first().json.session.deal_id!==\"\" }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -100,
        1260
      ],
      "id": "9553bd11-abaa-4f17-a061-e0db25d040e6",
      "name": "If2"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        560,
        1220
      ],
      "id": "ca085b87-5993-475a-b253-0bfbca09cee8",
      "name": "Invoices"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Analyse the below recent email, previous discussion on the deal an details from document(If provided) to decide the correct classify and extract the data in a welll structured format according to the provided schema.;\n\nLast Email: {{ $json.session.last_email }}\n\nEmail Thread: {{\n`Subject: ${$json.session.session_data.Subject}\\n, Emails: ${$json.session.session_data.Emails}`\n}}\n\nDeal Document: {{ $json.session.session_data.last_attachment?.document || '' }}\n\nManager's Metadata: {{ JSON.stringify($json.sub_session, null, ' ') }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are an expert invoice detection and structured information extraction agent for entertainment industry communications.\n\n## OBJECTIVE\nDetect invoice requests from entertainment industry communications and documents. Output normalized JSON following the provided schema.\n\n## CRITICAL RULES\n- Never hallucinate or guess values - use null for missing data\n- Always output the invoice object with all required fields\n- Distinguish between actionable requests and historical mentions\n\n---\n\n## DEFINITIONS\n\n**Data Priority** (when conflicts exist):\n1. **Last Email** (highest): The last email received from the user\n2. **Thread**: A completed email thread where terms are discussed\n3. **Document** (Optional): Any attached documents under discussion\n\n---\n\n## INVOICE DETECTION\n\n### Request Status\n`request_status = true` if any of the following:\n- **Creation requests**: \"send invoice\", \"create invoice\", \"bill them\", \"invoice for this\"\n- **Payment requests**: \"payment of $X\", \"invoice amount\", \"process payment\"\n- **Lookup requests**: \"find invoice\", \"check invoice #\", \"where is the invoice\"\n- **Remittance**: \"payment confirmation\", \"remittance advice\", \"payment received\"\n\n`request_status = false` if:\n- **Historical mentions**: \"invoice was sent\", \"already invoiced\", \"we sent the invoice last week\"\n- **No action needed**: Discussing invoices without any action verb or request\n\n### Request Type\nWhen `request_status = true`, classify as:\n- **remittance_payment**: Payment confirmations, remittance advice, payment received notifications\n- **general**: All other invoice requests (creation, lookup, sending)\n- **null**: When `request_status = false`\n\n---\n\n## FIELD EXTRACTION\n\n### recipient\n- The entity/organization responsible for payment.\n- Examples: \"Atlantic Records\", \"Sony Music\", \"Live Nation\", \"Universal Publishing\"\n- **Cannot be**: Person names, artist names, or song/master titles\n- **null** if not identifiable or not mentioned\n- **Critical**: The person verified and associated with the manager can never be a recipient. Actually invoice is being paid to him and not by him. So he is not the invoice recipient.\n\n### amount\n- Extract exact numeric value only\n- Examples: \"$5,000\" â†’ 5000, \"â‚¬2,500.50\" â†’ 2500.50\n- **null** if not specified\n\n### currency\n- ISO 4217 currency code (3 uppercase letters)\n- Examples: USD, EUR, GBP, THB, CAD, AUD\n- **Default to \"USD\"** if amount exists but currency is not specified\n- **null** only if no amount is present\n\n### invoice_id\n- Extract numbers only from invoice identifiers\n- Examples: \"INV-00123\" â†’ \"123\", \"Invoice #456\" â†’ \"456\", \"#789\" â†’ \"789\"\n- **null** if not found or not mentioned\n\n### next_step\n**ONLY evaluate if conversation_history contains previous invoice recommendations from the system**\n\nSet to:\n1. **\"request_as_file\"** - ONLY if last_email contains ONLY a request for invoice as file/PDF/document with no other instructions\n   - Examples: \"send me the invoice PDF\", \"can I get the invoice as a file\"\n   \n2. **\"create_new\"** - ONLY if conversation_history shows system offered invoice options AND last_email explicitly rejects ALL those options\n   - Example: System offered invoices A, B, C â†’ User says \"none of these are correct, create a new one\"\n   \n3. **null** - In all other cases, including:\n   - No previous invoice recommendations exist in conversation history\n   - User accepts one of the offered options\n   - User provides new information without explicit rejection\n   - First mention of invoice in conversation\n\n### deal_discussion:\n- set to true if the user have linked or mentioned any deal related to this invoice(s). If no mention of the deal is made. Set this to false.\n---\n\n## ERROR HANDLING\n\n### Data Conflicts\nUse priority order: `last_email > previous_discussion > attached_document`\n\n### Missing Information\n- Use `null` for all missing values\n- Never invent or assume information not present in the communication\n\n---\n\n## VALIDATION CHECKLIST\n1. âœ“ `request_status` accurately reflects actionable vs historical mentions\n2. âœ“ `request_type` is non-null only when `request_status = true`\n3. âœ“ `currency` defaults to \"USD\" when amount exists without currency\n4. âœ“ `recipient` is not a person/artist/master name\n5. âœ“ `invoice_id` contains only digits\n6. âœ“ `next_step` is null unless conversation_history contains previous recommendations\n7. âœ“ No hallucinated values\n\n---\n\n## CONVERSATION HISTORY\nUse provided history to identify:\n- Previous invoice recommendations from the system\n- User rejections or modifications of recommended invoices\n- Context for determining `next_step`\n\n**Conversation History**: {{ $('Trigger').item.json.data.history }}"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        -720,
        1540
      ],
      "id": "4e9fc690-75aa-47d7-b6e5-0ccc01d797d2",
      "name": "InvoiceInputs",
      "retryOnFail": true,
      "maxTries": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "14786cf1-0b4e-44f1-bbb6-8e12bd70c655",
              "leftValue": "={{[\"Master\"]}}",
              "rightValue": "={{ $json.output.deal_type }}",
              "operator": {
                "type": "array",
                "operation": "contains",
                "rightType": "any"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        40,
        400
      ],
      "id": "09c921a8-89c3-4ed4-b6e8-f1e6fecbf0e3",
      "name": "If3"
    },
    {
      "parameters": {
        "jsCode": "// n8n JavaScript Code for Deal Type Message Generation\n// Input: deal_type from previous node\n// Output: Object with deal_search_findings message and deal_next_step status\n\nconst dealType = $input.first().json.output.deal_type;\n\n// List of recognized deal types\nconst recognizedDealTypes = [\n  \"Live Performance\",\n  \"Recording\",\n  \"Publishing\",\n  \"Licensing\",\n  \"Distribution\",\n  \"Sync\",\n  \"Artist Development\",\n  \"Production\"\n];\n\nlet message;\nlet dealNextStep;\n\n// Check if deal type is recognized\nif (!dealType || dealType.trim() === \"\") {\n  message = \"I see the deal type identified from the email discussion is not recognized by the system. It would be great if you could specify which kind of deal is under discussion. Currently the Patchbay Assistant supports processing Producer, Mixer, Featured Artist deals.\";\n  dealNextStep = \"unrecognised\";\n} else if (recognizedDealTypes.includes(dealType)) {\n  message = `I see ${dealType} deal is under discussion at this time. Patchbay Email assistant does not support processing the deal and invoice related operations to this deal. Currently the Patchbay Assistant supports processing Producer, Mixer, Featured Artist deals. The maanger needs to be informed about the incapability. Don't execute any further steps and help the agent respond to Manager.`;\n  dealNextStep = \"unsupported\";\n} else {\n  message = \"I see the deal type identified from the email discussion is not recognized by the system. It would be great if you could specify which kind of deal is under discussion. Currently the Patchbay Assistant supports processing Producer, Mixer, Featured Artist deals.\";\n  dealNextStep = \"unrecognised\";\n}\n\n// Return output in n8n compatible format\nreturn {\n  deal_search_findings: message,\n  deal_next_step: dealNextStep,\n  deal_type: dealType || null,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        340,
        740
      ],
      "id": "605405cf-b3ca-48d0-a6e0-3ab9cdc7233b",
      "name": "Code1"
    }
  ],
  "pinData": {
    "Trigger": [
      {
        "json": {
          "action": "deal_search",
          "data": {
            "user_id": "b07af3f8-c51e-42df-b5c7-6b5248a5ee5e",
            "session_data": {
              "ThreadId": "199358c948d5ae69",
              "Emails": "---------------\nFrom: Aidan Schechter (aidan@1916mgmt.com)\nTo: asst@patchbay.xyz\nDate: Thu, Oct 30, 2025, 7:22 AM\nBody: New deal if it doesn't yet exist None of these are the deal Best, Aidan Schechter AIDAN SCHECHTER P: +1 310.467.6229 | E: AIDAN@1916MGMT.COM\n---------------\n\n---------------\nFrom: Aidan Schechter (aidan@1916mgmt.com)\nTo: asst@patchbay.xyz\nDate: Thu, Oct 30, 2025, 7:22 AM\nBody: New deal if it doesn't yet exist None of these are the deal Best, Aidan Schechter AIDAN SCHECHTER P: +1 310.467.6229 | E: AIDAN@1916MGMT.COM\n---------------\n\n---------------\nFrom: Aidan Schechter (aidan@1916mgmt.com)\nTo: David O'Sullivan (dave@thisisnq.com)\nDate: Thu, Oct 30, 2025, 12:09 AM\nBody: From: Aidan Schechter (aidan@1916mgmt.com)\nTo: David O'Sullivan (dave@thisisnq.com)\nDate: Thursday, October 30, 2025 at 12:09 AM\nSubject: Re: 4 THE SOUL - AITCH\nBody:\nSee here thanks!\n\nhttps://card.patchbay.xyz/16t0/alexgoldblatt\n\nBest,\nAidan Schechter\n\nAIDAN SCHECHTER\n\nP: +1 310.467.6229 | E: AIDAN@1916MGMT.COM\n\nOn Mon, Oct 27, 2025 at 4:15 AM, David O'Sullivan < dave@thisisnq.com > wrote:\n\n> \n> Hey mate,\n> \n> \n> Sorry about the delay, This is GBP yes.\n> \n> \n> Can you send over contracting details?\n> \n> \n> \n> \n> Kind regards,\n> \n> \n> \n> \n> David O'Sullivan\n> \n> \n> \n> \n> *Head A&R*\n> \n> \n> \n> \n> \n> \n> \n> *NQ*\n> \n> \n> \n> *(+44)7880933337 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n> \n> \n> \n> *Talent & Entertainment*\n> \n> \n> \n> Dave@ thisisnq. com ( Dave@thisisnq.com )\n> \n> \n> \n> \n> This email and any files transmitted with it are confidential and are\n> intended solely for the use of the individual or entity which they are\n> addressed to. Any unauthorised dissemination or copying of this email, any\n> files transmitted with it or any use or disclosure of any information\n> contained within them is strictly prohibited. If you have received this\n> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n> management team. Whilst we have taken every effort to scan this email and\n> any files transmitted with it for viruses, we cannot be held responsible\n> for any viruses transferred.\n> \n> \n> \n> \n> \n> \n> \n> \n> On Sun, 26 Oct 2025 at 21:28, Aidan Schechter < aidan@ 1916mgmt. com (\n> aidan@1916mgmt.com ) > wrote:\n> \n> \n>> LetÂ me know so we can knock this out. Can we get invoicing in motion?\n>> \n>> Best,\n>> Aidan Schechter\n>> \n>> \n>> \n>> \n>> \n>> \n>> \n>> \n>> \n>> \n>> AIDAN SCHECHTER\n>> \n>> \n>> \n>> P: +1 310.467.6229 | E: AIDAN@ 1916MGMT. COM ( AIDAN@1916MGMT.COM )\n>> \n>> \n>> \n>> \n>> \n>> \n>> \n>> On Fri, Oct 10, 2025 at 4:03 PM, Aidan Schechter < aidan@ 1916mgmt. com (\n>> aidan@1916mgmt.com ) > wrote:\n>> \n>>> ThisÂ is GBP?\n>>> \n>>> \n>>> Best,\n>>> Aidan Schechter\n>>> \n>>> \n>>> \n>>> \n>>> \n>>> \n>>> \n>>> \n>>> \n>>> \n>>> AIDAN SCHECHTER\n>>> \n>>> \n>>> \n>>> P: +1 310.467.6229 | E: AIDAN@ 1916MGMT. COM ( AIDAN@1916MGMT.COM )\n>>> \n>>> \n>>> \n>>> \n>>> \n>>> \n>>> \n>>> On Tue, Oct 07, 2025 at 3:52 AM, David O'Sullivan < dave@ thisisnq. com (\n>>> dave@thisisnq.com ) > wrote:\n>>> \n>>>> Hey mate,\n>>>> \n>>>> \n>>>> Sorry have been looking into budgets for this hence the delay, any chance\n>>>> we can look at 1.5k fee?\n>>>> \n>>>> \n>>>> \n>>>> \n>>>> Kind regards,\n>>>> \n>>>> \n>>>> \n>>>> \n>>>> David O'Sullivan\n>>>> \n>>>> \n>>>> \n>>>> \n>>>> *Head A&R Manager*\n>>>> \n>>>> \n>>>> \n>>>> \n>>>> \n>>>> \n>>>> \n>>>> *NQ*\n>>>> \n>>>> \n>>>> \n>>>> *(+44)7880933337 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>> \n>>>> \n>>>> \n>>>> *Talent & Entertainment*\n>>>> \n>>>> \n>>>> \n>>>> Dave@ thisisnq. com ( Dave@thisisnq.com )\n>>>> \n>>>> \n>>>> \n>>>> \n>>>> This email and any files transmitted with it are confidential and are\n>>>> intended solely for the use of the individual or entity which they are\n>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>> files transmitted with it or any use or disclosure of any information\n>>>> contained within them is strictly prohibited. If you have received this\n>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>> management team. Whilst we have taken every effort to scan this email and\n>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>> for any viruses transferred.\n>>>> \n>>>> \n>>>> \n>>>> \n>>>> \n>>>> \n>>>> \n>>>> \n>>>> On Tue, 7 Oct 2025 at 06:09, Aidan Schechter < aidan@ 1916mgmt. com (\n>>>> aidan@1916mgmt.com ) > wrote:\n>>>> \n>>>> \n>>>>> LetÂ me know what you can do here?\n>>>>> \n>>>>> Best,\n>>>>> Aidan Schechter\n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> AIDAN SCHECHTER\n>>>>> \n>>>>> \n>>>>> \n>>>>> P: +1 310.467.6229 | E: AIDAN@ 1916MGMT. COM ( AIDAN@1916MGMT.COM )\n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> \n>>>>> On Thu, Oct 02, 2025 at 5:03 PM, Aidan Schechter < aidan@ 1916mgmt. com (\n>>>>> aidan@1916mgmt.com ) > wrote:\n>>>>> \n>>>>>> What canÂ you do on the fee side budget-wise?\n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> Best,\n>>>>>> Aidan Schechter\n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> AIDAN SCHECHTER\n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> P: +1 310.467.6229 | E: AIDAN@ 1916MGMT. COM ( AIDAN@1916MGMT.COM )\n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> \n>>>>>> On Thu, Oct 02, 2025 at 2:18 AM, David O'Sullivan < dave@ thisisnq. com (\n>>>>>> dave@thisisnq.com ) > wrote:\n>>>>>> \n>>>>>>> Hey Aidan,\n>>>>>>> \n>>>>>>> \n>>>>>>> Hope you are well sir, did you have any thoughts here on the master side?\n>>>>>>> Obviously we arenâ€™t working with it budgets as independent and this was\n>>>>>>> also a deluxe release but let me know what your thinking\n>>>>>>> \n>>>>>>> On Fri, 26 Sep 2025 at 16:42, Aidan Schechter < aidan@ 1916mgmt. com (\n>>>>>>> aidan@1916mgmt.com ) > wrote:\n>>>>>>> \n>>>>>>> \n>>>>>>>> *JasperÂ Harris* Brookside Publishing /Â AvexÂ USA Hits / Songs of S10 Publishing\n>>>>>>>> (BMI)\n>>>>>>>> \n>>>>>>>> \n>>>>>>>> Best,\n>>>>>>>> Aidan Schechter\n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> AIDAN SCHECHTER\n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> P: +1 310.467.6229 | E: AIDAN@ 1916MGMT. COM ( AIDAN@1916MGMT.COM )\n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>>> On Fri, Sep 26, 2025 at 8:41 AM, Via Culpan < via@ thisisnq. com (\n>>>>>>>> via@thisisnq.com ) > wrote:\n>>>>>>>> \n>>>>>>>>> Just following up here please\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> Thanks\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> Via Culpan\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> *Day to Day Manager*\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> *NQ*\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> *(+44)7734407732 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> via@ thisisnq. com ( via@thisisnq.com )\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>> for any viruses transferred.\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> On Thu, 25 Sep 2025 at 18:26, Via Culpan < via@ thisisnq. com (\n>>>>>>>>> via@thisisnq.com ) > wrote:\n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>>> Thank you, do you have Jaspers also?\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> Via Culpan\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> *Day to Day Manager*\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> *NQ*\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> *(+44)7734407732 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> via@ thisisnq. com ( via@thisisnq.com )\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>>> for any viruses transferred.\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> On Thu, 25 Sep 2025 at 18:20, Aidan Schechter < aidan@ 1916mgmt. com (\n>>>>>>>>>> aidan@1916mgmt.com ) > wrote:\n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>>> YesÂ thanks\n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> https:/ / card. patchbay. xyz/ 16t0/ alexgoldblatt (\n>>>>>>>>>>> https://card.patchbay.xyz/16t0/alexgoldblatt ) is Alex's info\n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> Best,\n>>>>>>>>>>> Aidan Schechter\n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> AIDAN SCHECHTER\n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> P: +1 310.467.6229 | E: AIDAN@ 1916MGMT. COM ( AIDAN@1916MGMT.COM )\n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> On Thu, Sep 25, 2025 at 10:17 AM, Via Culpan < via@ thisisnq. com (\n>>>>>>>>>>> via@thisisnq.com ) > wrote:\n>>>>>>>>>>> \n>>>>>>>>>>>> Confirming the below:\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> Whyjay 20%\n>>>>>>>>>>>> LiTek 20%\n>>>>>>>>>>>> Alex 5%\n>>>>>>>>>>>> Jasper 5%\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> Please let me know if weâ€™re good to register\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> Thank you\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> Via Culpan\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> *Day to Day Manager*\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> *NQ*\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> *(+44)7734407732 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> via@ thisisnq. com ( via@thisisnq.com )\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>>>>> for any viruses transferred.\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> On Thu, 25 Sep 2025 at 17:57, Aidan Schechter < aidan@ 1916mgmt. com (\n>>>>>>>>>>>> aidan@1916mgmt.com ) > wrote:\n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>>> For publishing please just splitÂ 50/50 between JasperÂ and Alex as Lily\n>>>>>>>>>>>>> didn't write on this one. Thanks\n>>>>>>>>>>>>> \n>>>>>>>>>>>>> Best,\n>>>>>>>>>>>>> Aidan Schechter\n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> AIDAN SCHECHTER\n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> P: +1 310.467.6229 | E: AIDAN@ 1916MGMT. COM ( AIDAN@1916MGMT.COM )\n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> On Thu, Sep 18, 2025 at 5:41 AM, Via Culpan < via@ thisisnq. com (\n>>>>>>>>>>>>> via@thisisnq.com ) > wrote:\n>>>>>>>>>>>>> \n>>>>>>>>>>>>>> Apologies for the triple email, in the essence of time, please see\n>>>>>>>>>>>>>> proposed splits below:\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> Whyjay 20%\n>>>>>>>>>>>>>> LiTek 20%\n>>>>>>>>>>>>>> Alex 3.33%\n>>>>>>>>>>>>>> Jasper 3.33%\n>>>>>>>>>>>>>> Lily 3.33%\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> Thank you\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> On Thu, 18 Sept 2025 at 13:08, Via Culpan < via@ thisisnq. com (\n>>>>>>>>>>>>>> via@thisisnq.com ) > wrote:\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> +Michael Adex ( Adex@thisisnq.com ) also\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> On Thu, 18 Sept 2025 at 10:10, Via Culpan < via@ thisisnq. com (\n>>>>>>>>>>>>>>> via@thisisnq.com ) > wrote:\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> Hi Aiden,\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> Please can you come back on this one?\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> Thanks\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> On Thu, 11 Sept 2025 at 10:25, Shan Gibson < shannon@ thisisnq. com (\n>>>>>>>>>>>>>>>> shannon@thisisnq.com ) > wrote:\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> Thank you Aidan!\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> Please can you clarify how the credits should appear?\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> On Wed, 10 Sept 2025 at 22:33, Aidan Schechter < aidan@ 1916mgmt. com (\n>>>>>>>>>>>>>>>>> aidan@1916mgmt.com ) > wrote:\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> We'll be splitting fee and master 3 ways: Alex Goldblatt, Jasper Harris,\n>>>>>>>>>>>>>>>>>> and LilyÂ Kaplan.\n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> We'll be splitting publishing evenly between Alex, Jasper, and probably a\n>>>>>>>>>>>>>>>>>> writer alias just need to figure that out this week back ASAP.\n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> LetÂ me know if you need anything else thanks.\n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> Best,\n>>>>>>>>>>>>>>>>>> Aidan Schechter\n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> AIDAN SCHECHTER\n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> P: +1 310.467.6229 | E: AIDAN@ 1916MGMT. COM ( AIDAN@1916MGMT.COM )\n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> On Tue, Sep 09, 2025 at 12:33 AM, Via Culpan < via@ thisisnq. com (\n>>>>>>>>>>>>>>>>>> via@thisisnq.com ) > wrote:\n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> Thanks Dave and hi guys,\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> Please can I check where weâ€™re up to here?\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> Via Culpan\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> *Day to Day Manager*\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> *NQ*\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> *(+44)7734407732 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> via@ thisisnq. com ( via@thisisnq.com )\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>>>>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>>>>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>>>>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>>>>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>>>>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>>>>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>>>>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>>>>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>>>>>>>>>>>> for any viruses transferred.\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> On Mon, 8 Sep 2025 at 18:49, David O'Sullivan < dave@ thisisnq. com (\n>>>>>>>>>>>>>>>>>>> dave@thisisnq.com ) > wrote:\n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>> Adding Via in here for visibility whilst Iâ€™m away.\n>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>> On Mon, 8 Sep 2025 at 20:43, Shan Gibson < shannon@ thisisnq. com (\n>>>>>>>>>>>>>>>>>>>> shannon@thisisnq.com ) > wrote:\n>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> Hi all,\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> Please can we receiveÂ an update on this?\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> Thank you,\n>>>>>>>>>>>>>>>>>>>>> Shan\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> On Fri, 15 Aug 2025 at 16:02, David O'Sullivan < dave@ thisisnq. com (\n>>>>>>>>>>>>>>>>>>>>> dave@thisisnq.com ) > wrote:\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>> Hey guys,\n>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>> On the call now\n>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>> On Thu, 14 Aug 2025 at 17:15, Howie < howie@ howie. ai ( howie@howie.ai ) >\n>>>>>>>>>>>>>>>>>>>>>> wrote:\n>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>>> Hi all,\n>>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>>> Following up per Aidan's request, would tomorrow ( Fri, Aug 15 ) at 8am PDT\n>>>>>>>>>>>>>>>>>>>>>>> (4pm BST) work for everyone for a 30-minute meeting?\n>>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>>> Please let me know if that time is good, or if you need to suggest\n>>>>>>>>>>>>>>>>>>>>>>> alternatives.\n>>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>>> Best,\n>>>>>>>>>>>>>>>>>>>>>>> Howie\n>>>>>>>>>>>>>>>>>>>>>>> 1916/Patchbay\n>>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>>> On Thu, Aug 14, 2025, 10:52AM howie@ howie. ai ( howie@howie.ai ) wrote:\n>>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>>> > Hi all,\n>>>>>>>>>>>>>>>>>>>>>>> >\n>>>>>>>>>>>>>>>>>>>>>>> > Thanks for confirming David! I sent the invite for the 30-minute meeting\n>>>>>>>>>>>>>>>>>>>>>>> on Tue, Aug 19 at 8:30am PDT (4:30pm BST).\n>>>>>>>>>>>>>>>>>>>>>>> >\n>>>>>>>>>>>>>>>>>>>>>>> > Please let me know if you need anything else.\n>>>>>>>>>>>>>>>>>>>>>>> >\n>>>>>>>>>>>>>>>>>>>>>>> > Best,\n>>>>>>>>>>>>>>>>>>>>>>> > Howie\n>>>>>>>>>>>>>>>>>>>>>>> > 1916/Patchbay\n>>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> --\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> Shan Gibson\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> *Executive Assistant to CEO, Michael Adex*\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> *\n>>>>>>>>>>>>>>>>>>>>> *\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> *NQ*\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> *(+44)7956513409 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> shannon@ thisisnq. com ( shannon@thisisnq.com )\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>>> *This email was sent at a time & date convenient to me; please do not feel\n>>>>>>>>>>>>>>>>>>>>> under any pressure to respond immediately if this is outside your normal\n>>>>>>>>>>>>>>>>>>>>> working hours.*\n>>>>>>>>>>>>>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>>>>>>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>>>>>>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>>>>>>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>>>>>>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>>>>>>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>>>>>>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>>>>>>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>>>>>>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>>>>>>>>>>>>>> for any viruses transferred.\n>>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> --\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> Shan Gibson\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> *Executive Assistant to CEO, Michael Adex*\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> *\n>>>>>>>>>>>>>>>>> *\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> *NQ*\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> *(+44)7956513409 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> shannon@ thisisnq. com ( shannon@thisisnq.com )\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>>> *This email was sent at a time & date convenient to me; please do not feel\n>>>>>>>>>>>>>>>>> under any pressure to respond immediately if this is outside your normal\n>>>>>>>>>>>>>>>>> working hours.*\n>>>>>>>>>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>>>>>>>>>> for any viruses transferred.\n>>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> --\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> Via Culpan\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> *Day to Day Manager*\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> *NQ*\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> *(+44)7734407732 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> via@ thisisnq. com ( via@thisisnq.com )\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>>>>>>>>> for any viruses transferred.\n>>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> --\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> Via Culpan\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> *Day to Day Manager*\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> *NQ*\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> *(+44)7734407732 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> via@ thisisnq. com ( via@thisisnq.com )\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>>>>>>>> for any viruses transferred.\n>>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> --\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> Via Culpan\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> *Day to Day Manager*\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> *NQ*\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> *(+44)7734407732 |* *www. thisisnq. com* ( http://www.thisisnq.com/ ) **\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> *Talent & Entertainment*\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> via@ thisisnq. com ( via@thisisnq.com )\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> \n>>>>>>>>>>>>>> This email and any files transmitted with it are confidential and are\n>>>>>>>>>>>>>> intended solely for the use of the individual or entity which they are\n>>>>>>>>>>>>>> addressed to. Any unauthorised dissemination or copying of this email, any\n>>>>>>>>>>>>>> files transmitted with it or any use or disclosure of any information\n>>>>>>>>>>>>>> contained within them is strictly prohibited. If you have received this\n>>>>>>>>>>>>>> e-mail in error, please notify us by emailing: info@ thisisnq. com (\n>>>>>>>>>>>>>> info@thisisnq.com ). Views do not necessarily reflect the views ofÂ the NQ\n>>>>>>>>>>>>>> management team. Whilst we have taken every effort to scan this email and\n>>>>>>>>>>>>>> any files transmitted with it for viruses, we cannot be held responsible\n>>>>>>>>>>>>>> for any viruses transferred.\n>>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>>> \n>>>>>>>>> \n>>>>>>>>> \n>>>>>>>> \n>>>>>>>> \n>>>>>>> \n>>>>>>> \n>>>>>> \n>>>>>> \n>>>>> \n>>>>> \n>>>> \n>>>> \n>>> \n>>> \n>> \n>> \n> \n>\n---------------",
              "Subject": "Re: 4 THE SOUL - AITCH",
              "Others": [
                {
                  "name": "David O'Sullivan",
                  "address": "dave@thisisnq.com"
                }
              ],
              "Managers": [
                {
                  "name": "Aidan Schechter",
                  "address": "aidan@1916mgmt.com",
                  "user_id": "b07af3f8-c51e-42df-b5c7-6b5248a5ee5e",
                  "person_number": "beeb7d89-c123-4bf1-90a6-f4a279a0164a",
                  "Role": "Manager",
                  "Clients": []
                }
              ],
              "references": [
                "<010f0198a835f521-a0bf5f4b-3b34-4bee-9cac-90aacd8a756a-000000@us-east-2.amazonses.com>",
                "<010f0198a95d46a8-df0dae5f-3bf6-4a9a-9321-76e06b7d3501-000000@us-east-2.amazonses.com>",
                "<CAKYzVcYbWcUzYJ7YXk1Q2s=2s3D1gkZt3e7ngFGtM0bm9+hE-A@mail.gmail.com>",
                "<CAPHUd6tn6EsNEstXcQ6HKuiM8btV6606o52r00G-P3DCVXYqnA@mail.gmail.com>",
                "<CAKYzVcbBpJ_fvoONZZJ4MDP696J0CKAT0suR5DH0dAZPB-6RFA@mail.gmail.com>",
                "<CAFTdqfMjVpX-05W_i20uM6uEiyA0jjdYgOHK9g6KoeFe6ehdfA@mail.gmail.com>",
                "<mfehwcji.58e79b2b-b234-482f-9c0f-8437d66f9fb8@we.are.superhuman.com>",
                "<CAPHUd6uwXintOTVS4+S5ijwnCdGs4f6K9pOgpDjsH_PeB_GFyA@mail.gmail.com>",
                "<CAFTdqfO0uW89RAZpa77npjn1vO_C=1rug5knsHy0bAoEacMEGQ@mail.gmail.com>",
                "<CAFTdqfNKx_u0EFuROE+TSgCavLGtqy4Rki4K7MRLMV7=ha7M=A@mail.gmail.com>",
                "<CAFTdqfN0XThQ8KXUFfOdNrQ++gabKrrHgHQiNGRqi2V5Zt5g_g@mail.gmail.com>",
                "<mfznnkmj.73eb2163-e251-4e7b-b385-d02e953e8761@we.are.superhuman.com>",
                "<CAFTdqfNxgZxpZtsVruwVdnMsqL1ughjA-vPR5tPe0qi_fOczPA@mail.gmail.com>",
                "<mfzohx4s.eb15a67d-4885-41e9-b46c-9d9c350c38d8@we.are.superhuman.com>",
                "<CAFTdqfM-vDLSGG43ukdQbcRVSR+D3x9gc9nRFUetEQFmCGWemw@mail.gmail.com>",
                "<CAFTdqfMJJNxd_ry8FL5pOOgnUZWeqcFzuTMTbhGwCDpFDJyLbA@mail.gmail.com>",
                "<mg10g882.319c45e3-a66a-444e-a1d1-9180956b4a0b@we.are.superhuman.com>",
                "<CAKYzVcbGffxqA6yXrXJYY0ADw+8oAsecp4TkBhNBE9c1yPKT=g@mail.gmail.com>",
                "<mga2ytpd.bd4a0dd0-3032-4573-80aa-7569b5c0b280@we.are.superhuman.com>",
                "<mgg3nh2a.32a80dec-f0f8-46a7-a4fa-f9044df80fdc@we.are.superhuman.com>",
                "<CAKYzVcaBa_yMjyvqoSue64VZjEdKOh5WOoPzqbR4FB4mYPhjQw@mail.gmail.com>",
                "<mglgc85w.46852b64-d8cf-4c24-a909-8d118895077e@we.are.superhuman.com>",
                "<mh87zxbq.5426e1de-6c70-4c2b-8a69-71797397b84b@we.are.superhuman.com>",
                "<CAEaeWjRtZJXiN++_jLJ1ffS-=bHznHZ3pvd5tqA0G2owazNzAg@mail.gmail.com>",
                "<mhco2wpx.d09515f6-0a0b-41df-a98f-e54389148082@we.are.superhuman.com>",
                "<CAEaeWjTsra3mnTxh75TdGLm2GKDzy_NtixE+FALfwznqQStgCg@mail.gmail.com>"
              ],
              "Label": "CRUD-ASSISTANT",
              "sessionStatus": true
            },
            "last_email": "New deal if it doesn't yet exist None of these are the deal Best, Aidan Schechter AIDAN SCHECHTER P: +1 310.467.6229 | E: AIDAN@1916MGMT.COM",
            "history": "### Conversation (last 2 turns)\n\n**User** This deal is only for Alex. Please update the deal if it exists already and create it if it doesn't. Thank you. Best, Aidan Schechter AIDAN SCHECHTER P: +1 310.467.6229 | E: AIDAN@1916MGMT.COM Last interaction: 2025-10-30T03:17:06.789Z\n\n**AI** I understand the split for fee, master, and publishing among Alex Goldblatt, Jasper Harris, Lily Kaplan, and a potential writer alias is being arranged. Missing Information Master name or project title Artist name related to this master Could you please provide the master or project name and the artist name to proceed with setting up the deal? Best, Patchbay Assistant\n\n**User** We'll be splitting fee and master 3 ways: Alex Goldblatt, Jasper Harris, and Lily Kaplan. We'll be splitting publishing evenly between Alex, Jasper, and probably a writer alias just need to figure that out this week back ASAP. Let me know if you need anything else thanks. Best, Aidan Schechter AIDAN SCHECHTER P: +1 310.467.6229 | E: AIDAN@1916MGMT.COM Last interaction: 2025-09-11T04:03:34.937Z\n\n**AI** (no reply found)_"
          }
        }
      }
    ]
  },
  "repo_name": "hub-n8n",
  "repo_owner": "ck-bit",
  "repo_path": "",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-10-30T07:41:00.732Z",
  "versionId": "9c2f7420-9038-40b5-871b-55abe3ee37e7"
}